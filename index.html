<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SHAHRAZAD ELECTRIC | نظام إدارة المبيعات المتقدم</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <style>
        /* Custom styles for SHAHRAZAD ELECTRIC identity */
        body { font-family: 'Cairo', sans-serif; background-color: #f4f7fa; }
        /* Brand color (Strong blue) */
        .text-shahrazad { color: #004d99; } 
        .bg-shahrazad { background-color: #004d99; }
        /* Advanced gradient background */
        .gradient-bg { background: linear-gradient(135deg, #004d99 0%, #002d5b 100%); }
        /* Soft-edged cards with high shadow */
        .card { background-color: white; border-radius: 12px; box-shadow: 0 6px 15px rgba(0, 0, 0, 0.08); transition: transform 0.2s; }
        .card:hover { transform: translateY(-3px); box-shadow: 0 12px 25px rgba(0, 0, 0, 0.12); }
        /* Chat box style for the smart assistant */
        #chat-body { height: 300px; overflow-y: auto; display: flex; flex-direction: column-reverse; }
        .chat-message-user { background-color: #dbeafe; border-bottom-right-radius: 0; }
        .chat-message-ai { background-color: #e0f2f1; color: #004d99; border-bottom-left-radius: 0; }
        
        /* Styles for printing the invoice */
        @media print {
            body * {
                visibility: hidden;
            }
            .print-area, .print-area * {
                visibility: visible;
            }
            .print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                margin: 0;
                padding: 0;
            }
            /* Hide print-only buttons */
            .print-controls {
                display: none !important;
            }
        }
    </style>
</head>
<body>

    <script type="module">
        
        // --- 1. Firebase Configuration ---
        const defaultFirebaseConfig = {
            apiKey: "AIzaSyBtc-pniRx5Mda5UW_kNqS0Zyi8zcKvdlU",
            authDomain: "shahrazad-electric.firebaseapp.com",
            projectId: "shahrazad-electric",
            storageBucket: "shahrazad-electric.firebasestorage.app",
            messagingSenderId: "582314926345",
            appId: "1:582314926345:web:39c2979beadd8b47a133d8",
            measurementId: "G-3RH0BKKW16"
        };
        
        // Fetch global variables from the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-shahrazad-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const firestoreConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : defaultFirebaseConfig;

        // --- 2. Firebase Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // تم إضافة createUserWithEmailAndPassword لاستخدامها في صفحة إدارة المستخدمين
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut, updatePassword, signInWithEmailAndPassword, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // **تم إضافة 'increment' لدعم تحديثات المخزون المنفصلة (التعديل المطلوب)**
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, query, where, addDoc, updateDoc, deleteDoc, writeBatch, getDocs, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- 3. Initialization ---
        const app = initializeApp(firestoreConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        setLogLevel('Debug'); // Enable debug logs

        // --- 4. Global State (App) ---
        window.App = {
            db,
            auth,
            appId,
            userId: null,
            userRole: 'staff',
            view: 'loading',
            data: { products: [], customers: [], invoices: [], users: [], alerts: [], warehouses: [] },
            draftInvoice: { items: [], subTotal: 0, totalDiscount: 0, grandTotal: 0 }, // New state for invoice creation
            currentInvoiceForView: null, // New state for print view
            
            // Public collection path (for products, invoices, users)
            getCollectionPath(collectionName) {
                return `artifacts/${this.appId}/public/data/${collectionName}`;
            },
        };

        // ====================================================================
        //                      MERGED UTILITY CLASS (Assistant) 
        // ====================================================================
        /**
         * Assistant Class (فئة المساعد)
         */
        class Assistant {
            constructor(name = "المساعد الرقمي") {
                this.name = name;
            }

            calculateSum(a, b) {
                if (typeof a !== 'number' || typeof b !== 'number') {
                    return NaN;
                }
                return a + b;
            }

            generateGreeting(userName) {
                if (!userName || typeof userName !== 'string') {
                    userName = "صديقنا العزيز";
                }
                return `أهلاً بك يا ${userName}! ${this.name} في خدمتك.`;
            }

            /**
             * تنسيق التاريخ (Format Date)
             */
            formatCurrentDate() {
                const now = new Date();
                const options = { year: 'numeric', month: 'long', day: 'numeric' };
                // استخدام اللغة العربية في التنسيق
                return now.toLocaleDateString('ar-EG', options);
            }
            
            formatTimestamp(timestamp) {
                if (!timestamp) return 'غير محدد';
                // Check if it's a Firestore Timestamp object or a string
                const date = (timestamp.toDate && typeof timestamp.toDate === 'function') ? timestamp.toDate() : new Date(timestamp);
                const options = { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' };
                return date.toLocaleDateString('ar-EG', options);
            }
        }
        
        const myAssistant = new Assistant("مساعد واجهة المستخدم");
        
        // ====================================================================
        //                      Auth and Role Management Unit (Auth & Roles)       
        // ====================================================================
        
        async function authenticateUser() {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(App.auth, initialAuthToken);
                } 
                // تم إزالة signInAnonymously() هنا. سيتم تحويل المستخدم إلى صفحة الدخول إذا لم يكن هناك توكن.
            } catch (error) {
                console.error("Critical Firebase authentication error:", error);
                App.view = 'auth_error';
                render();
            }
        }

        function setupAuthStateListener() {
            onAuthStateChanged(App.auth, async (user) => {
                if (user) {
                    App.userId = user.uid;
                    const userDocRef = doc(App.db, App.getCollectionPath('users'), user.uid);
                    const userDoc = await getDoc(userDocRef);
                    
                    if (userDoc.exists()) {
                        App.userRole = userDoc.data().role || 'staff';
                    } else {
                        // Logic to assign 'admin' to the FIRST user in Firestore
                        const usersCollectionRef = collection(App.db, App.getCollectionPath('users'));
                        const usersSnapshot = await getDocs(usersCollectionRef);
                        
                        // If collection is empty, this user is the Admin.
                        if (usersSnapshot.size === 0) {
                             App.userRole = 'admin'; 
                             alertUser("تهانينا! أنت أول مستخدم وتم تعيين دور 'المدير الأساسي' لك تلقائياً.", "success");
                        } else {
                             App.userRole = 'staff'; 
                        }
                        
                        // Save the new user record with assigned role
                        await setDoc(userDocRef, { uid: user.uid, role: App.userRole, createdAt: new Date().toISOString(), email: user.email || 'N/A' }, { merge: true });
                    }

                    setupFirestoreListeners();
                    App.view = 'dashboard'; // Direct routing to dashboard
                } else {
                    // إذا لم يكن هناك مستخدم، اذهب إلى صفحة تسجيل الدخول
                    App.userId = null;
                    App.view = 'login'; 
                }
                render();
            });
        }
        
        window.handleLogout = () => {
             signOut(App.auth).then(() => { 
                alertUser("تم تسجيل الخروج بنجاح.", "success"); 
             }).catch(console.error);
        };
        
        /**
         * معالج تسجيل الدخول: يدعم البريد وكلمة المرور أو وضع الاختبار المجهول
         */
        window.handleLoginSubmit = async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const loginBtn = document.getElementById('login-btn');
            
            loginBtn.disabled = true;
            loginBtn.innerHTML = `<i data-lucide="loader-circle" class="w-5 h-5 ml-2 inline animate-spin"></i> جاري الدخول...`;

            try {
                // وضع الاختبار: تسجيل دخول مجهول
                if (email.toLowerCase() === "test" && password === "test") {
                    await signInAnonymously(App.auth);
                    alertUser("تم تسجيل الدخول بنجاح كـ 'وضع الاختبار المجهول'.", "success");
                } else {
                    // تسجيل الدخول بالبريد وكلمة المرور
                    await signInWithEmailAndPassword(App.auth, email, password);
                    alertUser("تم تسجيل الدخول بنجاح.", "success");
                }
            } catch (error) {
                console.error("Login error:", error);
                
                let errorMessage = "فشل تسجيل الدخول. يرجى التحقق من البريد الإلكتروني وكلمة المرور.";
                if (error.code === 'auth/user-not-found') {
                    errorMessage = "البريد الإلكتروني غير مسجل في النظام. (ربما تحتاج لتسجيل مستخدم جديد في Firebase).";
                } else if (error.code === 'auth/wrong-password') {
                    errorMessage = "كلمة المرور غير صحيحة.";
                } else if (error.code === 'auth/invalid-credential') {
                     errorMessage = "بيانات الاعتماد غير صالحة.";
                }
                
                alertUser(errorMessage, 'error');
            } finally {
                loginBtn.disabled = false;
                loginBtn.innerHTML = `<i data-lucide="log-in" class="w-5 h-5 ml-2 inline"></i> تسجيل الدخول`;
                lucide.createIcons();
            }
        };

        /**
         * معالج إنشاء مستخدم جديد (Admin Only)
         */
        window.handleUserCreate = async (e) => {
            e.preventDefault();
            const form = document.getElementById('add-user-form');
            const email = form.querySelector('#user-email').value;
            const password = form.querySelector('#user-password').value;
            const role = form.querySelector('#user-role').value;
            const name = form.querySelector('#user-name').value;
            const createBtn = form.querySelector('button[type="submit"]');

            if (App.userRole !== 'admin') {
                alertUser("عذراً، يجب أن تكون بـ **صلاحية المدير الأساسي** لإنشاء مستخدمين جدد.", "error");
                return;
            }

            createBtn.disabled = true;
            createBtn.innerHTML = `<i data-lucide="loader-circle" class="w-5 h-5 ml-2 inline animate-spin"></i> جاري الإنشاء...`;
            lucide.createIcons();
            
            try {
                // 1. Create user in Firebase Auth
                const userCredential = await createUserWithEmailAndPassword(App.auth, email, password);
                const user = userCredential.user;
                
                // 2. Save user role and details in Firestore
                const userDocRef = doc(App.db, App.getCollectionPath('users'), user.uid);
                await setDoc(userDocRef, { 
                    uid: user.uid, 
                    role: role, 
                    email: user.email,
                    name: name || 'غير محدد',
                    createdAt: new Date().toISOString(),
                });
                
                alertUser(`تم إنشاء المستخدم **${email}** بنجاح وتعيين دور ${role}.`, "success");
                form.reset();

            } catch (error) {
                console.error("User creation error:", error);
                let errorMessage = "فشل إنشاء المستخدم. يرجى التحقق من البيانات.";
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = "هذا البريد الإلكتروني مستخدم بالفعل.";
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = "كلمة المرور ضعيفة جداً (يجب أن تكون 6 أحرف على الأقل).";
                } else if (error.code === 'auth/operation-not-allowed') {
                    errorMessage = "غير مسموح بإنشاء المستخدمين. يرجى تفعيل (Email/Password) في إعدادات Firebase Authentication.";
                }
                alertUser(errorMessage, 'error');
            } finally {
                createBtn.disabled = false;
                createBtn.innerHTML = `<i data-lucide="user-plus" class="w-5 h-5 ml-2 inline"></i> إضافة مستخدم جديد`;
                lucide.createIcons();
            }
        };

        /**
         * معالج حذف مستخدم (Admin Only)
         */
        window.handleUserDelete = async (userId, userEmail) => {
            if (App.userRole !== 'admin') {
                alertUser("عذراً، يجب أن تكون بـ **صلاحية المدير الأساسي** للحذف.", "error");
                return;
            }
            if (!confirm(`هل أنت متأكد من حذف سجل المستخدم: ${userEmail}؟ لا يمكن التراجع عن هذا الإجراء!`)) return;

            // نحذف السجل من Firestore فقط، لأن حذف المستخدم من Firebase Auth 
            // يتطلب Admin SDK لأسباب أمنية. نعتمد على أن السجل المحذوف 
            // سيمنع المستخدم من الحصول على دور "admin" أو "staff" في هذا التطبيق.
            
            try {
                // حذف سجل المستخدم من Firestore
                await deleteDoc(doc(App.db, App.getCollectionPath('users'), userId));
                alertUser(`تم حذف سجل المستخدم **${userEmail}** من قاعدة بيانات Firestore بنجاح.`, "success");
            } catch (error) {
                console.error("User deletion error:", error);
                alertUser(`فشل حذف المستخدم: ${error.message}`, "error");
            }
        };

        
        // ====================================================================
        //                      Real-Time Data Fetching Unit (Firestore)      
        // ====================================================================

        function setupFirestoreListeners() {
            if (!App.userId) return;

            // 1. Products and Inventory
            onSnapshot(collection(App.db, App.getCollectionPath('products')), (snapshot) => {
                App.data.products = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                checkLowStockAlerts();
                if (['products', 'dashboard', 'alerts', 'invoices', 'new_invoice'].includes(App.view)) render(); 
            }, console.error);

            // 2. Customers
            onSnapshot(collection(App.db, App.getCollectionPath('customers')), (snapshot) => {
                App.data.customers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (['customers', 'invoices', 'dashboard', 'new_invoice'].includes(App.view)) render();
            }, console.error);
            
            // 3. Invoices
            onSnapshot(collection(App.db, App.getCollectionPath('invoices')), (snapshot) => {
                App.data.invoices = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (['dashboard', 'invoices'].includes(App.view)) render();
            }, console.error);
            
             // 4. Users
            onSnapshot(collection(App.db, App.getCollectionPath('users')), (snapshot) => {
                App.data.users = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (App.view === 'user_settings') render();
            }, console.error);
            
             // 5. Warehouses
            onSnapshot(collection(App.db, App.getCollectionPath('warehouses')), (snapshot) => {
                App.data.warehouses = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // إعادة عرض صفحات المنتجات والإعدادات التي تعتمد على المخازن
                if (['products', 'general_settings', 'new_invoice'].includes(App.view)) render();
            }, console.error);
        }
        
        // ====================================================================
        //                      Inventory and Alerts Unit (UPDATED)
        // ====================================================================

        // **NEW: Inventory Management Logic**

        // Helper function to update stock
        async function handleUpdateProductStock(productId, field, amount, successMessage) {
            if (amount <= 0) {
                alertUser('الكمية يجب أن تكون أكبر من صفر.', 'error');
                return false;
            }
            const productRef = doc(App.db, App.getCollectionPath('products'), productId);

            try {
                await updateDoc(productRef, {
                    [field]: increment(amount)
                });
                alertUser(successMessage, 'success');
                // document.getElementById('inventory-modal').remove(); // Close modal upon successful operation
                return true;
            } catch (error) {
                console.error(`Error updating ${field}:`, error);
                alertUser(`فشل في تحديث المخزون: ${error.message}`, 'error');
                return false;
            }
        }

        // 1. Transfer from Warehouse to Displayed
        window.handleTransfer = async (e, productId) => {
            e.preventDefault();
            const transferAmount = parseInt(document.getElementById('transfer-amount').value);
            const product = App.data.products.find(p => p.id === productId);

            if (transferAmount <= 0) {
                alertUser('الكمية يجب أن تكون موجبة.', 'error');
                return;
            }
            if ((product.warehouse_stock || 0) < transferAmount) {
                alertUser(`الكمية المراد نقلها (${transferAmount}) أكبر من المتوفر في المخزن الرئيسي (${product.warehouse_stock || 0}).`, 'error');
                return;
            }
            
            const batch = writeBatch(App.db);
            const productRef = doc(App.db, App.getCollectionPath('products'), productId);

            batch.update(productRef, {
                warehouse_stock: increment(-transferAmount),
                displayed_stock: increment(transferAmount)
            });

            try {
                await batch.commit();
                alertUser(`تم نقل ${transferAmount} وحدة من المخزن الرئيسي إلى البضاعة المعروضة.`, 'success');
                document.getElementById('inventory-modal').remove(); // Close modal
                render(); // Force render to update view
            } catch(error) {
                console.error("Batch Transfer failed:", error);
                alertUser(`فشل عملية النقل: ${error.message}`, 'error');
            }
        };

        // 2. Add Stock to Warehouse (New Arrivals)
        window.handleAddStockToWarehouse = async (e, productId) => {
            e.preventDefault();
            const addAmount = parseInt(document.getElementById('add-warehouse-amount').value);
            const success = await handleUpdateProductStock(productId, 'warehouse_stock', addAmount, `تم إضافة ${addAmount} وحدة إلى المخزن الرئيسي بنجاح.`);
            if (success) {
                document.getElementById('inventory-modal').remove(); // Close modal
                render();
            }
        };

        // 3. Add Stock to Displayed (Returns/Direct to Sales Floor)
        window.handleAddDisplayedStock = async (e, productId) => {
            e.preventDefault();
            const addAmount = parseInt(document.getElementById('add-displayed-amount').value);
            const success = await handleUpdateProductStock(productId, 'displayed_stock', addAmount, `تم إضافة ${addAmount} وحدة إلى البضاعة المعروضة (مرتجعات عرض) بنجاح.`);
            if (success) {
                document.getElementById('inventory-modal').remove(); // Close modal
                render();
            }
        };

        // Function to open the Inventory Management Modal
        window.openInventoryModal = (product) => {
            const appRoot = document.getElementById('app-root');
            appRoot.insertAdjacentHTML('beforeend', InventoryManagementModal(product));
            lucide.createIcons();
        };

        // **END: Inventory Management Logic**

        function checkLowStockAlerts() {
            // **UPDATED: Check against displayed_stock only for sales alerts**
            const lowStockProducts = App.data.products.filter(p => (p.displayed_stock || 0) <= (p.lowStockThreshold || 10));
            const alertsContainer = document.getElementById('alerts-container');
            const alertsContainerFull = document.getElementById('alerts-container-full');
            
            const alertHTML = lowStockProducts.length > 0
                ? lowStockProducts.map(p => 
                    `<div class="p-3 mb-2 bg-red-100 text-red-700 rounded-lg shadow-sm flex justify-between items-center text-sm border-r-4 border-red-500">
                        <i data-lucide="alert-triangle" class="w-4 h-4 ml-2"></i>
                        <p>الصنف **${p.name}** منخفض. الكمية المعروضة: **${p.displayed_stock || 0}**</p>
                    </div>`
                ).join('')
                : `<p class="text-gray-500 text-sm p-4 text-center">لا توجد تنبيهات نقص مخزون حالياً.</p>`;
                
            if (alertsContainer) alertsContainer.innerHTML = alertHTML;
            if (alertsContainerFull) alertsContainerFull.innerHTML = alertHTML;
            lucide.createIcons();
        }
        
        // ====================================================================
        //                      Smart Assistant Unit (Gemini API Integration)       
        // = ====================================================================

        window.toggleAssistant = () => {
            const container = document.getElementById('smart-assistant-container');
            container.style.display = container.style.display === 'none' ? 'flex' : 'none'; // Changed to flex for better layout
        };
        
        window.sendAssistantQuery = async () => {
            const input = document.getElementById('chat-input');
            const query = input.value.trim();
            if (!query) return;

            const chatBody = document.getElementById('chat-body');
            // User message
            chatBody.insertAdjacentHTML('afterbegin', `
                <div class="flex justify-start mb-2">
                    <div class="max-w-xs p-3 rounded-xl chat-message-user shadow-md">${query}</div>
                </div>
            `);
            input.value = '';
            
            // Typing indicator
            chatBody.insertAdjacentHTML('afterbegin', `
                <div id="ai-typing-indicator" class="flex justify-end mb-2">
                    <div class="max-w-xs p-3 rounded-xl chat-message-ai shadow-md">... جاري التفكير</div>
                </div>
            `);
            
            const typingIndicator = document.getElementById('ai-typing-indicator');

            // Prepare the model context (System Prompt)
            // **UPDATED: Context to include both stock types**
            const productList = App.data.products.map(p => `ID:${p.id}, Name:${p.name}, Warehouse Stock:${p.warehouse_stock || 0}, Displayed Stock:${p.displayed_stock || 0}, Price:${p.price}, Warehouse:${p.warehouse}, Threshold:${p.lowStockThreshold}`).join('; ');
            const customerList = App.data.customers.map(c => `Name:${c.name}, Distinguished:${c.isDistinguished}, Spent:${c.totalSpent || 0}`).join('; ');

            const systemPrompt = `
                أنت المساعد الذكي لشركة SHAHRAZAD ELECTRIC. مهمتك هي الإجابة على استفسارات المستخدمين باللغة العربية بناءً على البيانات المقدمة.
                - اعتمد على البيانات التالية لتكون إجاباتك دقيقة ومرتبطة ببيانات المخزون والمبيعات.
                - يجب أن تكون الإجابات مهنية وموجزة.

                **بيانات النظام الحالية:**
                - المنتجات والمخزون: [${productList}]
                - العملاء وإجمالي الإنفاق: [${customerList}]
            `;
            
            // NOTE: apiKey MUST be empty string as per environment rules.
            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{ parts: [{ text: query }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            try {
                let resultText = "عذراً، لم أتمكن من الحصول على استجابة.";
                let apiSuccess = false;
                
                // --- START Exponential Backoff Retry Logic (To ensure API Key injection) ---
                for (let attempt = 0; attempt < 3; attempt++) {
                    const response = await fetch(apiUrl, { 
                        method: 'POST', 
                        headers: { 'Content-Type': 'application/json' }, 
                        body: JSON.stringify(payload) 
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        resultText = result.candidates?.[0]?.content?.parts?.[0]?.text || resultText;
                        apiSuccess = true;
                        break; 
                    } 
                    
                    if (response.status === 429) { 
                        // Too Many Requests - Retry with backoff
                        await new Promise(resolve => setTimeout(resolve, Math.pow(2, attempt) * 1000));
                        continue;
                    } else if (response.status === 403 && attempt < 2) {
                        // 403 Forbidden is the typical error when the key is missing. Retry for key injection.
                         await new Promise(resolve => setTimeout(resolve, Math.pow(2, attempt) * 1000));
                         continue;
                    } else { 
                        // Critical error or last 403 failed, break and trigger MOCKING
                        throw new Error(`API error: ${response.status} - Critical failure.`);
                    }
                }
                
                if (!apiSuccess) {
                     // If loop finished without success (e.g., all 403 retries failed), trigger MOCKING.
                     throw new Error("All API attempts failed, falling to mocking.");
                }
                
                // --- END Exponential Backoff Retry Logic ---

                // Remove typing indicator and add AI response
                typingIndicator.remove();
                chatBody.insertAdjacentHTML('afterbegin', `
                    <div class="flex justify-end mb-2">
                        <div class="max-w-xs p-3 rounded-xl chat-message-ai shadow-md">${resultText}</div>
                    </div>
                `);
                
            } catch (error) {
                console.error("Gemini API connection failed, falling back to Mocking Logic:", error);

                // =========================================================
                // START MOCKING LOGIC (Fallback for connection errors)
                // =========================================================
                
                let mockResultText = `
                    <p class="font-bold text-red-600 mb-2">⚠️ **خطأ في الاتصال بالذكاء الاصطناعي.** نظراً لمشكلة في الاتصال (قد تكون بسبب حقن المفتاح)، سأقوم بالرد آلياً الآن اعتماداً على بيانات Firestore المحلية:</p>
                `;

                const lowerQuery = query.toLowerCase();
                
                if (lowerQuery.includes('مخزون') || lowerQuery.includes('نقص') || lowerQuery.includes('منخفض') || lowerQuery.includes('مخزن')) {
                    // **UPDATED: Check against displayed_stock**
                    const lowStockItems = App.data.products.filter(p => (p.displayed_stock || 0) <= (p.lowStockThreshold || 10));
                    
                    if (lowStockItems.length > 0) {
                        mockResultText += `<p>هناك **${lowStockItems.length} صنف** يعاني من نقص في **البضاعة المعروضة** (أقل من ${lowStockItems[0].lowStockThreshold || 10}):</p>`;
                        lowStockItems.slice(0, 3).forEach(item => { // Show top 3
                            mockResultText += `<p class="mt-1 pr-3 border-r-4 border-red-500">**${item.name}**: الكمية المعروضة ${item.displayed_stock || 0}.</p>`;
                        });
                    } else {
                        mockResultText += `<p>**المخزون:** جميع الأصناف تبدو جيدة ولا توجد تنبيهات نقص مخزون حالياً في البضاعة المعروضة.</p>`;
                    }
                } else if (lowerQuery.includes('عميل') || lowerQuery.includes('مميز') || lowerQuery.includes('vip')) {
                    const distinguishedCount = App.data.customers.filter(c => c.isDistinguished).length;
                    const totalCustomers = App.data.customers.length;
                    mockResultText += `<p>**العملاء:** لدينا **${distinguishedCount} عميل مميز (VIP)** من أصل ${totalCustomers} عميل مسجل في النظام.</p>`;
                } else if (lowerQuery.includes('سعر') || lowerQuery.includes('أغلى')) {
                    const mostExpensive = App.data.products.sort((a, b) => b.price - a.price)[0];
                    if (mostExpensive) {
                        mockResultText += `<p>**معلومات السعر:** أغلى صنف مسجل هو **${mostExpensive.name}** بسعر ${mostExpensive.price.toFixed(2)} جنيه سوداني.</p>`;
                    } else {
                        mockResultText += `<p>**معلومات السعر:** لا توجد أصناف مسجلة لحساب السعر.</p>`;
                    }
                } else {
                    mockResultText += `<p>**رسالة عامة:** أنا مستعد لمساعدتك في استعراض بيانات SHAHRAZAD ELECTRIC. يمكنك سؤالي عن "نقص المخزون"، "العملاء المميزون"، أو "سعر صنف معين".</p>`;
                }
                // =========================================================
                // END MOCKING LOGIC
                // =========================================================

                typingIndicator.remove();
                chatBody.insertAdjacentHTML('afterbegin', `
                    <div class="flex justify-end mb-2">
                        <div class="max-w-xs p-3 rounded-xl chat-message-ai shadow-md">${mockResultText}</div>
                    </div>
                `);
            }
        };

        // ====================================================================
        //                      Invoice Management Unit (UPDATED)
        // ====================================================================

        // Helper to calculate totals based on items in App.data.draftInvoice.items
        window.calculateInvoiceTotals = () => {
            let subTotal = 0;
            let totalDiscount = 0;

            App.data.draftInvoice.items.forEach(item => {
                const itemTotalBeforeDiscount = item.quantity * item.unitPrice;
                const discountAmount = itemTotalBeforeDiscount * (item.discount / 100);
                const itemTotal = itemTotalBeforeDiscount - discountAmount;

                item.total = itemTotal.toFixed(2); // Store item total
                subTotal += itemTotalBeforeDiscount;
                totalDiscount += discountAmount;
            });

            App.data.draftInvoice.subTotal = subTotal.toFixed(2);
            App.data.draftInvoice.totalDiscount = totalDiscount.toFixed(2);
            App.data.draftInvoice.grandTotal = (subTotal - totalDiscount).toFixed(2);
        };
        
        // Handles adding a new item row to the draft invoice
        window.handleAddItem = () => {
            const selectElement = document.getElementById('product-select');
            const quantityElement = document.getElementById('item-quantity');
            const priceElement = document.getElementById('item-price');
            const discountElement = document.getElementById('item-discount');

            const productId = selectElement.value;
            const quantity = parseInt(quantityElement.value);
            const unitPrice = parseFloat(priceElement.value);
            const discount = parseFloat(discountElement.value) || 0;

            if (!productId || quantity <= 0 || unitPrice <= 0) {
                alertUser("يرجى اختيار صنف وإدخال كمية وسعر صالحين.", "error");
                return;
            }
            
            const productData = App.data.products.find(p => p.id === productId);
            if (!productData) return;
            // **UPDATED: Check stock against displayed_stock only**
            const availableStock = productData.displayed_stock || 0;

            if (availableStock < quantity) {
                 alertUser(`البضاعة المعروضة المتوفرة من **${productData.name}** هي ${availableStock} فقط.`, "error");
                 return;
            }
            
            // Prevent duplicate product in the draft (or update quantity)
            const existingItemIndex = App.data.draftInvoice.items.findIndex(item => item.productId === productId);

            const newItem = {
                productId: productId,
                productName: productData.name,
                quantity: quantity,
                unitPrice: unitPrice,
                discount: discount,
                total: 0, // Will be calculated
            };

            if (existingItemIndex > -1) {
                // For simplicity, we just add the quantity to the existing one for now
                App.data.draftInvoice.items[existingItemIndex].quantity += quantity;
            } else {
                App.data.draftInvoice.items.push(newItem);
            }
            
            calculateInvoiceTotals();
            render(); 

            // Clear inputs and reset price to selected product's default
            quantityElement.value = 1;
            discountElement.value = 0;
            selectElement.value = "";
            priceElement.value = 0;
        };

        // Removes an item from the draft invoice
        window.handleRemoveItem = (index) => {
            App.data.draftInvoice.items.splice(index, 1);
            calculateInvoiceTotals();
            render();
        };

        // Function to find customer by name or create a new one
        async function findOrCreateCustomer(customerName) {
            const existingCustomer = App.data.customers.find(c => c.name === customerName);
            if (existingCustomer) {
                return existingCustomer.id;
            }

            // Create new customer
            const newCustomerRef = doc(collection(App.db, App.getCollectionPath('customers')));
            await setDoc(newCustomerRef, {
                name: customerName,
                phone: '', 
                email: '',
                totalSpent: 0,
                isDistinguished: false,
                createdAt: new Date().toISOString(),
            });
            return newCustomerRef.id;
        }

        // Function to update stock quantities using a batch write
        async function updateProductStockBatch(items, batch) {
            for (const item of items) {
                const product = App.data.products.find(p => p.id === item.productId);
                const availableStock = product.displayed_stock || 0;

                if (product && availableStock >= item.quantity) {
                    const productRef = doc(App.db, App.getCollectionPath('products'), item.productId);
                    // **UPDATED: Deduct ONLY from displayed_stock**
                    batch.update(productRef, { displayed_stock: increment(-item.quantity) });
                } else {
                    // This error will rollback the entire batch
                    throw new Error(`Quantity requested for product ${item.productName} is more than available displayed stock (${product ? availableStock : 'N/A'}).`);
                }
            }
        }

        // Main function to process and save the new invoice
        window.handleNewInvoice = async (e) => {
            e.preventDefault();
            const form = document.getElementById('new-invoice-form');
            const customerName = form.querySelector('#customer-name').value.trim();
            const invoiceItems = App.data.draftInvoice.items;
            const totalAmount = parseFloat(App.data.draftInvoice.grandTotal);
            const notes = form.querySelector('#invoice-notes').value.trim();

            if (!customerName) {
                alertUser("يرجى إدخال اسم العميل.", "error");
                return;
            }
            if (invoiceItems.length === 0) {
                alertUser("يجب إضافة صنف واحد على الأقل للفاتورة.", "error");
                return;
            }

            const saveBtn = document.getElementById('save-invoice-btn');
            saveBtn.disabled = true;
            saveBtn.innerHTML = `<i data-lucide="loader-circle" class="w-5 h-5 ml-2 inline animate-spin"></i> جاري الحفظ...`;
            lucide.createIcons();

            try {
                // 1. Find or create the customer
                const customerId = await findOrCreateCustomer(customerName);

                // 2. Prepare Firestore Batch
                const batch = writeBatch(App.db);
                // **UPDATED: This function now deducts from displayed_stock**
                await updateProductStockBatch(invoiceItems, batch); // Decrement stock

                // 3. Save Invoice
                const invoiceRef = doc(collection(App.db, App.getCollectionPath('invoices')));
                const newInvoiceData = {
                    invoiceNumber: App.data.invoices.length + 1, // Simple sequential number (for display)
                    customerId: customerId,
                    customerName: customerName,
                    items: invoiceItems.map(item => ({
                        name: item.productName,
                        quantity: item.quantity,
                        unitPrice: item.unitPrice,
                        discount: item.discount,
                        total: item.total
                    })),
                    subTotal: App.data.draftInvoice.subTotal,
                    totalDiscount: App.data.draftInvoice.totalDiscount,
                    grandTotal: totalAmount,
                    notes: notes,
                    date: new Date().toISOString(),
                    createdBy: App.userId,
                };

                batch.set(invoiceRef, newInvoiceData);

                // 4. Commit Batch (updates stock and saves invoice)
                await batch.commit();

                alertUser(`تم إنشاء الفاتورة رقم ${newInvoiceData.invoiceNumber} بنجاح وتحديث المخزون.`, "success");
                
                // Navigate to the print view and clear draft
                App.currentInvoiceForView = { id: invoiceRef.id, ...newInvoiceData };
                App.data.draftInvoice = { items: [], subTotal: 0, totalDiscount: 0, grandTotal: 0 }; 
                App.view = 'invoice_details';
                render();

            } catch (error) {
                console.error("Invoice creation failed:", error);
                alertUser(`فشل إنشاء الفاتورة: ${error.message}`, "error");
            } finally {
                saveBtn.disabled = false;
                saveBtn.innerHTML = `<i data-lucide="save" class="w-5 h-5 ml-2 inline"></i> حفظ وإصدار الفاتورة`;
                lucide.createIcons();
            }
        };

        // Function to trigger printing (PDF download via browser)
        window.generateInvoicePDF = () => {
            // Hide unnecessary elements before printing/PDF generation
            const sidebar = document.getElementById('sidebar');
            const header = document.getElementById('header-bar');
            const assistant = document.getElementById('smart-assistant-container');
            
            if (sidebar) sidebar.style.display = 'none';
            if (header) header.style.display = 'none';
            if (assistant) assistant.style.display = 'none';
            
            // Use the browser's print function to generate a PDF or print directly
            window.print();
            
            // Restore the layout after printing is done (or immediately if print dialog is modal)
            setTimeout(() => {
                if (sidebar) sidebar.style.display = 'block';
                if (header) header.style.display = 'flex';
                if (assistant) assistant.style.display = 'none'; 
                // Return to the main invoices view after print attempt
                navigateTo('invoices');
            }, 500); 
        };
        
        window.onProductSelectChange = () => {
             const selectElement = document.getElementById('product-select');
             const priceElement = document.getElementById('item-price');
             const productId = selectElement.value;
             const productData = App.data.products.find(p => p.id === productId);

             if (productData) {
                 priceElement.value = productData.price;
                 document.getElementById('item-quantity').focus();
             } else {
                 priceElement.value = 0;
             }
        }

        
        // ====================================================================
        //                      Utility Unit (UI & Utils)
        // ====================================================================

        function alertUser(message, type) {
            // Custom message box instead of alert()
            const alertBox = document.getElementById('global-alert');
            alertBox.innerText = message;
            alertBox.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-xl text-white transition-all duration-300 transform ${type === 'success' ? 'bg-green-600' : 'bg-red-600'} translate-y-0 opacity-100`;
            setTimeout(() => {
                alertBox.className += ' -translate-y-20 opacity-0';
            }, 5000);
        }
        
        window.navigateTo = (viewName, data = null) => {
            App.view = viewName;
            if (viewName === 'invoice_details') {
                // If navigating to an existing invoice detail view
                 App.currentInvoiceForView = data;
            } else if (viewName === 'new_invoice') {
                // Initialize draft for new invoice
                App.data.draftInvoice = { items: [], subTotal: 0, totalDiscount: 0, grandTotal: 0 };
            }
            render();
        };

        /** Data Backup and Download **/ 
        window.backupData = async () => {
            const collectionsToBackup = ['products', 'customers', 'invoices', 'users', 'alerts', 'warehouses'];
            const backup = {};
            document.getElementById('backup-btn').innerText = 'جارٍ التجهيز...';
            try {
                for (const colName of collectionsToBackup) {
                    const colPath = App.getCollectionPath(colName);
                    const q = query(collection(App.db, colPath));
                    const snapshot = await getDocs(q);
                    backup[colName] = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                }
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(backup, null, 2));
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", `SHAHRAZAD_backup_${new Date().toISOString().slice(0, 10)}.json`);
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
                alertUser("تم إنشاء النسخة الاحتياطية بنجاح وتنزيل الملف.", "success");
            } catch (error) {
                console.error("Backup failed:", error);
                alertUser(`فشل النسخ الاحتياطي: ${error.message}`, "error");
            } finally {
                document.getElementById('backup-btn').innerText = 'تنزيل نسخة احتياطية';
            }
        };

        // ====================================================================
        //                      View Rendering Unit (HTML Templates)
        // ====================================================================
        
        /** General Layout **/
        const MainLayout = () => `
            <div class="flex h-screen bg-gray-100">
                ${Sidebar()}
                <div class="flex-1 flex flex-col overflow-hidden">
                    ${HeaderBar()}
                    <main class="flex-1 overflow-x-hidden overflow-y-auto p-4 md:p-6">
                        ${App.views[App.view]()}
                    </main>
                    ${SmartAssistantContainer()}
                </div>
            </div>
        `;

        const Sidebar = () => `
            <div id="sidebar" class="w-64 bg-shahrazad text-white space-y-6 py-7 px-2 absolute inset-y-0 right-0 transform translate-x-full md:relative md:translate-x-0 transition duration-200 ease-in-out z-30 shadow-2xl">
                <div class="flex items-center px-4">
                    <i data-lucide="battery-charging" class="w-8 h-8 text-yellow-400"></i>
                    <span class="text-2xl font-black mr-2 tracking-wider">SHAHRAZAD</span>
                </div>
                
                <nav>
                    ${SidebarLink('dashboard', 'الرئيسية', 'home')}
                    ${SidebarLink('products', 'إدارة الأصناف والمخزون', 'box')}
                    ${SidebarLink('invoices', 'إدارة الفواتير', 'receipt')}
                    ${SidebarLink('customers', 'إدارة العملاء', 'users')}
                    ${SidebarLink('alerts', 'تنبيهات المخزون', 'alert-triangle')}
                    <div class="pt-4 border-t border-white border-opacity-20 mt-4"></div>
                    ${SidebarLink('user_settings', 'إدارة المستخدمين', 'lock', App.userRole === 'admin' ? '' : 'hidden')}
                    ${SidebarLink('general_settings', 'إعدادات عامة', 'settings')}
                </nav>

                <div class="absolute bottom-4 w-full px-4">
                    <button onclick="handleLogout()" class="w-full flex items-center p-3 text-red-100 hover:bg-red-700 rounded-lg transition duration-200">
                        <i data-lucide="log-out" class="w-5 h-5 ml-3"></i> تسجيل الخروج
                    </button>
                </div>
            </div>
        `;

        const SidebarLink = (viewName, title, icon, classes = '') => `
            <button onclick="navigateTo('${viewName}')" class="w-full flex items-center p-3 text-white hover:bg-white hover:bg-opacity-10 rounded-lg transition duration-200 ${App.view === viewName ? 'bg-white bg-opacity-20 shadow-md' : ''} ${classes}">
                <i data-lucide="${icon}" class="w-5 h-5 ml-3"></i>
                <span>${title}</span>
            </button>
        `;

        const HeaderBar = () => `
            <header id="header-bar" class="flex items-center justify-between px-6 py-4 bg-white border-b border-gray-200 shadow-sm">
                <h1 class="text-xl font-semibold text-gray-800">${getPageViewTitle()}</h1>
                <div class="flex items-center">
                    <button onclick="toggleAssistant()" class="p-2 ml-3 text-gray-500 hover:text-shahrazad transition duration-150">
                        <i data-lucide="sparkles" class="w-6 h-6"></i>
                    </button>
                    <span class="text-sm font-medium text-shahrazad ml-3">${App.data.users.find(u => u.uid === App.userId)?.name || App.userRole}</span>
                    <i data-lucide="circle-user" class="w-7 h-7 text-gray-500"></i>
                </div>
            </header>
        `;

        const SmartAssistantContainer = () => `
            <div id="smart-assistant-container" class="hidden fixed bottom-4 right-4 w-80 h-auto bg-white rounded-xl shadow-2xl z-40 flex-col transition duration-300">
                <div class="p-3 bg-shahrazad text-white rounded-t-xl flex justify-between items-center">
                    <span class="font-bold">المساعد الذكي (AI)</span>
                    <button onclick="toggleAssistant()" class="p-1 hover:bg-white hover:bg-opacity-20 rounded-full">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
                <div id="chat-body" class="p-3 space-y-2 flex-grow">
                    <div class="flex justify-end mb-2">
                        <div class="max-w-xs p-3 rounded-xl chat-message-ai shadow-md">
                            ${myAssistant.generateGreeting(App.data.users.find(u => u.uid === App.userId)?.name)}
                        </div>
                    </div>
                </div>
                <div class="p-3 border-t">
                    <div class="flex items-center">
                        <input type="text" id="chat-input" placeholder="اكتب استفسارك..." class="flex-grow p-2 border border-gray-300 rounded-lg focus:ring-shahrazad focus:border-shahrazad text-sm" onkeydown="if(event.key === 'Enter') sendAssistantQuery()">
                        <button onclick="sendAssistantQuery()" class="mr-2 p-2 bg-shahrazad text-white rounded-lg hover:bg-blue-700 transition duration-150">
                            <i data-lucide="send" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        // **NEW: Inventory Management Modal Template**
        const InventoryManagementModal = (product) => `
            <div id="inventory-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center">
                <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6 animate-in fade-in zoom-in-50" dir="rtl">
                    <div class="flex justify-between items-center border-b pb-3 mb-4">
                        <h3 class="text-xl font-bold text-shahrazad">إدارة مخزون: ${product.name}</h3>
                        <button onclick="document.getElementById('inventory-modal').remove()" class="p-2 text-gray-400 hover:text-red-600 rounded-full">
                            <i data-lucide="x" class="w-6 h-6"></i>
                        </button>
                    </div>

                    <div class="mb-4 p-4 border rounded-lg bg-gray-50">
                        <p class="font-medium">المخزون الحالي:</p>
                        <p class="text-lg mt-1"><span class="text-blue-600 font-bold">${product.warehouse_stock || 0}</span> وحدة في المخزن الرئيسي</p>
                        <p class="text-lg"><span class="text-green-600 font-bold">${product.displayed_stock || 0}</span> وحدة بضاعة معروضة</p>
                        <p class="text-lg border-t pt-2 mt-2">الإجمالي: <span class="font-bold">${(product.warehouse_stock || 0) + (product.displayed_stock || 0)}</span> وحدة</p>
                    </div>

                    <h4 class="text-lg font-semibold border-b pb-2 mt-4 mb-3">1. نقل من المخزن الرئيسي إلى المعروضة</h4>
                    <form onsubmit="handleTransfer(event, '${product.id}')" class="space-y-3">
                        <label class="block text-sm font-medium text-gray-700">الكمية للنقل:</label>
                        <div class="flex">
                            <input type="number" id="transfer-amount" min="1" value="1" required class="flex-grow p-2 border rounded-r-lg focus:ring-shahrazad focus:border-shahrazad">
                            <button type="submit" class="bg-blue-500 text-white p-2 rounded-l-lg hover:bg-blue-600 transition duration-150 flex items-center">
                                <i data-lucide="chevrons-right" class="w-5 h-5 ml-2"></i> نقل الآن
                            </button>
                        </div>
                    </form>

                    <h4 class="text-lg font-semibold border-b pb-2 mt-6 mb-3">2. إضافة استلام جديد (للمخزن الرئيسي)</h4>
                    <form onsubmit="handleAddStockToWarehouse(event, '${product.id}')" class="space-y-3">
                        <label class="block text-sm font-medium text-gray-700">كمية الاستلام:</label>
                        <div class="flex">
                            <input type="number" id="add-warehouse-amount" min="1" value="1" required class="flex-grow p-2 border rounded-r-lg focus:ring-shahrazad focus:border-shahrazad">
                            <button type="submit" class="bg-orange-500 text-white p-2 rounded-l-lg hover:bg-orange-600 transition duration-150 flex items-center">
                                <i data-lucide="package-plus" class="w-5 h-5 ml-2"></i> إضافة للمخزن
                            </button>
                        </div>
                    </form>

                     <h4 class="text-lg font-semibold border-b pb-2 mt-6 mb-3">3. إضافة مباشرة للمعروضة (مرتجعات عرض)</h4>
                    <form onsubmit="handleAddDisplayedStock(event, '${product.id}')" class="space-y-3">
                        <label class="block text-sm font-medium text-gray-700">كمية الإضافة:</label>
                        <div class="flex">
                            <input type="number" id="add-displayed-amount" min="1" value="1" required class="flex-grow p-2 border rounded-r-lg focus:ring-shahrazad focus:border-shahrazad">
                            <button type="submit" class="bg-green-500 text-white p-2 rounded-l-lg hover:bg-green-600 transition duration-150 flex items-center">
                                <i data-lucide="shopping-cart" class="w-5 h-5 ml-2"></i> إضافة للمعروضة
                            </button>
                        </div>
                    </form>

                </div>
            </div>
        `;


        function getPageViewTitle() {
            const titles = {
                'loading': 'جاري التحميل...',
                'login': 'تسجيل الدخول',
                'dashboard': 'لوحة التحكم الرئيسية',
                'products': 'إدارة الأصناف والمخزون',
                'invoices': 'إدارة الفواتير',
                'new_invoice': 'إنشاء فاتورة مبيعات جديدة',
                'invoice_details': 'معاينة الفاتورة',
                'customers': 'إدارة العملاء',
                'alerts': 'تنبيهات نقص المخزون',
                'general_settings': 'إعدادات عامة',
                'user_settings': 'إدارة المستخدمين',
                'auth_error': 'خطأ في المصادقة',
            };
            return titles[App.view] || 'نظام SHAHRAZAD ELECTRIC';
        }

        /** Utility Component: Input **/
        const Input = ({ label, id, name, type = 'text', value = '', required = false, min = null, classes = '' }) => `
            <div>
                <label for="${id}" class="block text-sm font-medium text-gray-700">${label} ${required ? '<span class="text-red-500">*</span>' : ''}</label>
                <div class="mt-1">
                    <input 
                        id="${id}" 
                        name="${name}" 
                        type="${type}" 
                        value="${value}"
                        ${required ? 'required' : ''}
                        ${min !== null ? `min="${min}"` : ''}
                        class="appearance-none block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-shahrazad focus:border-shahrazad sm:text-sm ${classes}">
                </div>
            </div>
        `;
        
        /** Utility Component: Select **/
        const Select = ({ label, id, name, options, selectedValue, required = false }) => `
            <div>
                <label for="${id}" class="block text-sm font-medium text-gray-700">${label} ${required ? '<span class="text-red-500">*</span>' : ''}</label>
                <div class="mt-1">
                    <select 
                        id="${id}" 
                        name="${name}"
                        ${required ? 'required' : ''}
                        class="block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-shahrazad focus:border-shahrazad sm:text-sm">
                        <option value="">-- اختر --</option>
                        ${options.map(option => `
                            <option value="${option.value}" ${option.value === selectedValue ? 'selected' : ''}>
                                ${option.text}
                            </option>
                        `).join('')}
                    </select>
                </div>
            </div>
        `;
        
        /** Utility Component: Button (simplified version) **/
        const Button = (text, onClick, type, classes = '') => {
            let color = 'bg-gray-500 hover:bg-gray-600';
            if (type === 'primary') color = 'bg-shahrazad hover:bg-blue-700';
            if (type === 'danger') color = 'bg-red-500 hover:bg-red-600';
            if (type === 'success') color = 'bg-green-500 hover:bg-green-600';
            if (type === 'warning') color = 'bg-yellow-500 hover:bg-yellow-600';

            return `
                <button 
                    onclick="${onClick}" 
                    class="inline-flex items-center justify-center px-3 py-1.5 border border-transparent text-sm font-medium rounded-md shadow-sm text-white ${color} transition duration-150 ${classes}"
                >
                    ${text}
                </button>
            `;
        };


        /** View Implementations **/

        // --- 1. Loading View ---
        const LoadingView = () => `
            <div class="flex flex-col items-center justify-center h-full">
                <i data-lucide="loader-circle" class="w-12 h-12 text-shahrazad animate-spin"></i>
                <p class="mt-4 text-gray-600">جاري تحميل البيانات...</p>
            </div>
        `;

        // --- 2. Auth Error View ---
        const AuthErrorView = () => `
            <div class="flex flex-col items-center justify-center h-full bg-red-100 rounded-xl p-8 card">
                <i data-lucide="alert-octagon" class="w-12 h-12 text-red-600"></i>
                <h2 class="mt-4 text-2xl font-bold text-red-800">خطأ حرج في المصادقة</h2>
                <p class="mt-2 text-gray-700 text-center">حدث خطأ أثناء محاولة الاتصال بـ Firebase Auth. يرجى التأكد من إعدادات Firebase وتفعيل طريقة المصادقة المناسبة.</p>
                <button onclick="window.location.reload()" class="mt-6 bg-red-600 text-white p-3 rounded-lg hover:bg-red-700 transition duration-150">إعادة المحاولة</button>
            </div>
        `;
        
        // --- 3. Login View ---
        const LoginView = () => `
            <div class="flex items-center justify-center h-screen bg-gray-100">
                <div class="w-full max-w-md p-8 space-y-6 card">
                    <div class="flex flex-col items-center">
                        <i data-lucide="battery-charging" class="w-10 h-10 text-shahrazad"></i>
                        <h2 class="mt-3 text-3xl font-bold text-gray-900">نظام SHAHRAZAD ELECTRIC</h2>
                        <p class="mt-2 text-sm text-gray-500">الرجاء تسجيل الدخول للمتابعة</p>
                    </div>
                    <form class="space-y-6" onsubmit="handleLoginSubmit(event)">
                        <div>
                            <label for="login-email" class="block text-sm font-medium text-gray-700">البريد الإلكتروني / كلمة المرور للاختبار: test / test</label>
                            <div class="mt-1">
                                <input id="login-email" name="email" type="email" autocomplete="email" required class="appearance-none block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-shahrazad focus:border-shahrazad sm:text-sm">
                            </div>
                        </div>
                        <div>
                            <label for="login-password" class="block text-sm font-medium text-gray-700">كلمة المرور</label>
                            <div class="mt-1">
                                <input id="login-password" name="password" type="password" autocomplete="current-password" required class="appearance-none block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-shahrazad focus:border-shahrazad sm:text-sm">
                            </div>
                        </div>
                        <div class="flex items-center justify-between">
                            <div class="text-sm">
                                <p class="text-gray-600">
                                    <i data-lucide="info" class="w-4 h-4 inline ml-1"></i>
                                    للتجربة: استخدم البريد (test) وكلمة المرور (test).
                                </p>
                            </div>
                        </div>
                        <div>
                            <button id="login-btn" type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-shahrazad hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-shahrazad transition duration-150">
                                <i data-lucide="log-in" class="w-5 h-5 ml-2 inline"></i> تسجيل الدخول
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        `;

        // --- 4. Dashboard View ---
        const DashboardView = () => {
            const totalProducts = App.data.products.length;
            const totalCustomers = App.data.customers.length;
            const totalInvoices = App.data.invoices.length;
            const totalRevenue = App.data.invoices.reduce((sum, inv) => sum + parseFloat(inv.grandTotal || 0), 0);
            const lowStockCount = App.data.products.filter(p => (p.displayed_stock || 0) <= (p.lowStockThreshold || 10)).length;

            const salesData = App.data.invoices.reduce((acc, inv) => {
                const date = new Date(inv.date);
                const monthYear = `${date.getFullYear()}-${date.getMonth() + 1}`;
                acc[monthYear] = (acc[monthYear] || 0) + parseFloat(inv.grandTotal);
                return acc;
            }, {});

            const sortedMonths = Object.keys(salesData).sort();
            const chartLabels = sortedMonths.map(my => {
                const [year, month] = my.split('-');
                return new Date(year, month - 1).toLocaleDateString('ar-EG', { month: 'short', year: 'numeric' });
            });
            const chartData = sortedMonths.map(my => salesData[my]);

            setTimeout(() => {
                if (document.getElementById('sales-chart')) {
                    new Chart(document.getElementById('sales-chart').getContext('2d'), {
                        type: 'line',
                        data: {
                            labels: chartLabels,
                            datasets: [{
                                label: 'إجمالي المبيعات (جنيه)',
                                data: chartData,
                                backgroundColor: 'rgba(0, 77, 153, 0.5)', // #004d99 with opacity
                                borderColor: '#004d99',
                                borderWidth: 2,
                                tension: 0.4,
                                fill: true,
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: { legend: { display: false } },
                            scales: {
                                y: { beginAtZero: true },
                                x: { reverse: true } // Display latest on the right
                            }
                        }
                    });
                }
                lucide.createIcons();
            }, 100);

            return `
                <div class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        ${DashboardCard('إجمالي المبيعات', `${totalRevenue.toLocaleString('en-US', { minimumFractionDigits: 2 })} جنيه`, 'dollar-sign', 'green-600')}
                        ${DashboardCard('إجمالي الأصناف', `${totalProducts.toLocaleString('en-US')}`, 'box', 'blue-600')}
                        ${DashboardCard('إجمالي الفواتير', `${totalInvoices.toLocaleString('en-US')}`, 'receipt', 'purple-600')}
                        ${DashboardCard('إجمالي العملاء', `${totalCustomers.toLocaleString('en-US')}`, 'users', 'orange-600')}
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2 card p-5">
                            <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                                <i data-lucide="bar-chart-2" class="w-5 h-5 ml-2 text-shahrazad"></i> 
                                أداء المبيعات الشهرية
                            </h2>
                            <div class="h-80">
                                <canvas id="sales-chart"></canvas>
                            </div>
                        </div>

                        <div class="lg:col-span-1 space-y-6">
                            <div class="card p-5">
                                <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                                    <i data-lucide="alert-triangle" class="w-5 h-5 ml-2 text-red-500"></i>
                                    تنبيهات نقص المخزون (${lowStockCount})
                                </h2>
                                <div id="alerts-container" class="max-h-60 overflow-y-auto">
                                    ${lowStockCount > 0 ? '' : '<p class="text-gray-500 text-sm p-4 text-center">لا توجد تنبيهات نقص مخزون حالياً.</p>'}
                                </div>
                            </div>
                            
                            <div class="card p-5">
                                <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                                    <i data-lucide="zap" class="w-5 h-5 ml-2 text-yellow-600"></i>
                                    إجراءات سريعة
                                </h2>
                                <div class="grid grid-cols-2 gap-3">
                                    ${Button('فاتورة جديدة', `MapsTo('new_invoice')`, 'success', 'w-full')}
                                    ${Button('إضافة صنف', `MapsTo('products', { editId: 'new' })`, 'primary', 'w-full')}
                                    ${Button('كل الفواتير', `MapsTo('invoices')`, 'warning', 'w-full')}
                                    ${Button('تنبيهات المخزون', `MapsTo('alerts')`, 'danger', 'w-full')}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        };

        const DashboardCard = (title, value, icon, color) => `
            <div class="card p-5 flex items-center justify-between border-b-4 border-${color}">
                <div>
                    <p class="text-sm font-medium text-gray-500">${title}</p>
                    <p class="text-2xl font-bold text-gray-900 mt-1">${value}</p>
                </div>
                <i data-lucide="${icon}" class="w-8 h-8 text-${color} opacity-70"></i>
            </div>
        `;


        // --- 5. Products and Inventory View ---
        
        // **UPDATED: Added 'warehouse_stock' and 'displayed_stock' to the save handler**
        window.handleSaveProduct = async (e) => {
            e.preventDefault();
            const form = e.target;
            const productId = form.dataset.productId;
            const data = Object.fromEntries(new FormData(form).entries());
            
            // Ensure stock fields are numbers
            data.price = parseFloat(data.price) || 0;
            data.lowStockThreshold = parseInt(data.lowStockThreshold) || 10;
            data.warehouse_stock = parseInt(data.warehouse_stock) || 0; // **NEW FIELD**
            data.displayed_stock = parseInt(data.displayed_stock) || 0; // **NEW FIELD**

            // The old 'stock' field is now the sum for backwards compatibility with low stock check
            // Although we rely on displayed_stock for sales, this helps migrate old data.
            data.stock = data.warehouse_stock + data.displayed_stock; 
            
            // Validation: ensure stocks are not negative
            if (data.warehouse_stock < 0 || data.displayed_stock < 0) {
                 alertUser("كميات المخزون يجب أن تكون أصفاراً أو أكبر.", "error");
                 return;
            }

            const saveBtn = form.querySelector('button[type="submit"]');
            saveBtn.disabled = true;
            saveBtn.innerHTML = `<i data-lucide="loader-circle" class="w-5 h-5 ml-2 inline animate-spin"></i> جاري الحفظ...`;
            lucide.createIcons();
            
            try {
                if (productId === 'new') {
                    // Create new product
                    await addDoc(collection(App.db, App.getCollectionPath('products')), {
                        ...data,
                        createdAt: new Date().toISOString(),
                    });
                    alertUser(`تم إضافة الصنف **${data.name}** بنجاح.`, "success");
                } else {
                    // Update existing product
                    const productRef = doc(App.db, App.getCollectionPath('products'), productId);
                    await updateDoc(productRef, data);
                    alertUser(`تم تحديث الصنف **${data.name}** بنجاح.`, "success");
                }
                navigateTo('products'); // Go back to the product list
            } catch (error) {
                console.error("Product save error:", error);
                alertUser(`فشل حفظ الصنف: ${error.message}`, "error");
            } finally {
                saveBtn.disabled = false;
                saveBtn.innerHTML = `حفظ الصنف`;
            }
        };

        window.handleDeleteProduct = async (productId, productName) => {
            if (!confirm(`هل أنت متأكد من حذف الصنف: ${productName}؟ لا يمكن التراجع عن هذا الإجراء!`)) return;

            try {
                await deleteDoc(doc(App.db, App.getCollectionPath('products'), productId));
                alertUser(`تم حذف الصنف **${productName}** بنجاح.`, "success");
            } catch (error) {
                console.error("Product deletion error:", error);
                alertUser(`فشل حذف الصنف: ${error.message}`, "error");
            }
        };

        window.handleEditProduct = (productId) => {
            navigateTo('products', { editId: productId });
        };


        const ProductForm = ({ product = null }) => {
            const isNew = !product || product === 'new';
            const currentProduct = isNew ? {} : App.data.products.find(p => p.id === product.editId) || {};
            const productId = isNew ? 'new' : currentProduct.id;

            const warehouseOptions = App.data.warehouses.map(w => ({ value: w.id, text: w.name }));

            return `
                <div class="card p-6 max-w-4xl mx-auto">
                    <h2 class="text-2xl font-bold text-shahrazad mb-6">
                        ${isNew ? 'إضافة صنف جديد' : `تعديل الصنف: ${currentProduct.name}`}
                    </h2>
                    <form id="product-form" data-product-id="${productId}" onsubmit="handleSaveProduct(event)" class="space-y-6">
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            ${Input({
                                label: 'اسم الصنف',
                                id: 'name',
                                name: 'name',
                                value: currentProduct?.name || '',
                                required: true
                            })}

                            ${Input({
                                label: 'سعر الوحدة (جنيه سوداني)',
                                id: 'price',
                                name: 'price',
                                type: 'number',
                                value: currentProduct?.price || 0,
                                min: 0,
                                required: true
                            })}
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            ${Select({
                                label: 'المخزن الافتراضي',
                                id: 'warehouse',
                                name: 'warehouse',
                                options: warehouseOptions,
                                selectedValue: currentProduct?.warehouse,
                                required: true
                            })}
                            
                            ${Input({
                                label: 'الحد الأدنى للتنبيه (وحدة)',
                                id: 'lowStockThreshold',
                                name: 'lowStockThreshold',
                                type: 'number',
                                value: currentProduct?.lowStockThreshold || 10,
                                min: 0,
                                required: true
                            })}
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 border-t pt-6">
                            <h3 class="text-lg font-semibold col-span-2 text-gray-700">إدارة الكميات المخزنية</h3>

                            <div class="col-span-1">
                                ${Input({
                                    label: 'المخزن الرئيسي (وحدة)',
                                    id: 'warehouse_stock',
                                    name: 'warehouse_stock',
                                    type: 'number',
                                    value: currentProduct?.warehouse_stock || 0,
                                    min: 0,
                                    required: true
                                })}
                            </div>

                            <div class="col-span-1">
                                ${Input({
                                    label: 'البضاعة المعروضة (وحدة)',
                                    id: 'displayed_stock',
                                    name: 'displayed_stock',
                                    type: 'number',
                                    value: currentProduct?.displayed_stock || 0,
                                    min: 0,
                                    required: true
                                })}
                            </div>
                        </div>


                        <div class="flex justify-end space-x-4 space-x-reverse pt-4">
                            ${Button('إلغاء', `MapsTo('products')`, 'default')}
                            <button type="submit" class="inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-shahrazad hover:bg-blue-700 transition duration-150">
                                <i data-lucide="${isNew ? 'plus' : 'save'}" class="w-5 h-5 ml-2"></i> حفظ الصنف
                            </button>
                        </div>
                    </form>
                </div>
            `;
        };

        const ProductsView = () => {
            if (App.viewData && App.viewData.editId) {
                return ProductForm(App.viewData);
            }

            const warehousesMap = App.data.warehouses.reduce((map, w) => { map[w.id] = w; return map; }, {});

            return `
                <div class="space-y-6">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold text-gray-800">قائمة الأصناف</h2>
                        ${Button('إضافة صنف جديد', `handleEditProduct('new')`, 'primary', 'flex items-center')}
                    </div>

                    <div class="card overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="p-3 text-right">الصنف</th>
                                    <th class="p-3 text-center">السعر</th>
                                    <th class="p-3 text-center">المخزن</th>
                                    <th class="p-3 text-center">المخزن الرئيسي</th>
                                    <th class="p-3 text-center">المعروضة (للبيع)</th>
                                    <th class="p-3 text-center">الإجمالي</th>
                                    <th class="p-3 text-center">الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${App.data.products.length === 0 ? `
                                    <tr>
                                        <td colspan="7" class="p-4 text-center text-gray-500">لا توجد أصناف مسجلة حالياً.</td>
                                    </tr>
                                ` : App.data.products.map(p => {
                                    const warehouse = warehousesMap[p.warehouse];
                                    const totalStock = (p.warehouse_stock || 0) + (p.displayed_stock || 0);
                                    // **UPDATED: Low stock check on displayed_stock**
                                    const isLowStock = (p.displayed_stock || 0) <= (p.lowStockThreshold || 10);
                                    
                                    return `
                                        <tr>
                                            <td class="p-3 font-medium">${p.name}</td>
                                            <td class="p-3 text-center">${p.price?.toFixed(2) || '0.00'}</td>
                                            <td class="p-3 text-center">${warehouse?.name || 'غير محدد'}</td>
                                            <td class="p-3 text-center text-blue-600 font-medium">${p.warehouse_stock || 0}</td>
                                            <td class="p-3 text-center ${isLowStock ? 'text-red-500 font-bold' : 'text-green-600 font-bold'}">${p.displayed_stock || 0}</td>
                                            <td class="p-3 text-center font-bold text-gray-800">${totalStock}</td>
                                            <td class="p-3 text-center space-x-2 space-x-reverse flex justify-center items-center">
                                                ${Button('إدارة المخزون', `openInventoryModal(${JSON.stringify(p).replace(/'/g, "\\'")})`, 'warning', 'text-xs')}
                                                ${Button('تعديل', `handleEditProduct('${p.id}')`, 'primary', 'text-xs')}
                                                ${Button('حذف', `handleDeleteProduct('${p.id}', '${p.name}')`, 'danger', 'text-xs')}
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        };
        
        // --- 6. New Invoice View ---
        const NewInvoiceView = () => {
            const productsOptions = App.data.products.map(p => ({ 
                value: p.id, 
                // **UPDATED: Display both stocks in the select option**
                text: `${p.name} (المعروضة: ${p.displayed_stock || 0} | المخزن: ${p.warehouse_stock || 0})`
            }));
            
            return `
                <div class="max-w-6xl mx-auto space-y-6">
                    <h2 class="text-2xl font-bold text-gray-800">إنشاء فاتورة مبيعات جديدة</h2>
                    
                    <form id="new-invoice-form" onsubmit="handleNewInvoice(event)" class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        
                        <div class="lg:col-span-2 space-y-6">
                            
                            <div class="card p-5">
                                <h3 class="text-xl font-semibold border-b pb-2 mb-4 text-shahrazad">تفاصيل العميل</h3>
                                <div class="grid grid-cols-2 gap-4">
                                    ${Input({
                                        label: 'اسم العميل',
                                        id: 'customer-name',
                                        name: 'customer-name',
                                        required: true,
                                        value: ''
                                    })}
                                    <p class="text-sm text-gray-500 pt-8">
                                        (سيتم حفظ العميل تلقائياً إذا كان جديداً)
                                    </p>
                                </div>
                            </div>
                            
                            <div class="card p-5">
                                <h3 class="text-xl font-semibold border-b pb-2 mb-4 text-shahrazad">إضافة أصناف للفاتورة</h3>
                                <div class="grid grid-cols-5 gap-4 items-end">
                                    <div class="col-span-2">
                                        ${Select({
                                            label: 'اختر الصنف',
                                            id: 'product-select',
                                            name: 'product-select',
                                            options: productsOptions,
                                            required: true
                                        })}
                                    </div>
                                    ${Input({
                                        label: 'السعر',
                                        id: 'item-price',
                                        name: 'item-price',
                                        type: 'number',
                                        value: 0,
                                        min: 0,
                                        required: true
                                    })}
                                    ${Input({
                                        label: 'الكمية',
                                        id: 'item-quantity',
                                        name: 'item-quantity',
                                        type: 'number',
                                        value: 1,
                                        min: 1,
                                        required: true
                                    })}
                                    ${Input({
                                        label: 'الخصم (%)',
                                        id: 'item-discount',
                                        name: 'item-discount',
                                        type: 'number',
                                        value: 0,
                                        min: 0
                                    })}
                                </div>
                                <div class="mt-4 flex justify-end">
                                    ${Button('إضافة الصنف', `handleAddItem()`, 'success', 'flex items-center')}
                                </div>
                                <script>
                                    // Attach event listener for price update when product changes
                                    document.getElementById('product-select').addEventListener('change', window.onProductSelectChange);
                                </script>
                            </div>
                            
                            <div class="card p-5">
                                <h3 class="text-xl font-semibold border-b pb-2 mb-4 text-shahrazad">الأصناف المضافة</h3>
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="p-3 text-right">الصنف</th>
                                                <th class="p-3 text-center">السعر</th>
                                                <th class="p-3 text-center">الكمية</th>
                                                <th class="p-3 text-center">الخصم (%)</th>
                                                <th class="p-3 text-right">الإجمالي</th>
                                                <th class="p-3 text-center">حذف</th>
                                            </tr>
                                        </thead>
                                        <tbody class="bg-white divide-y divide-gray-200">
                                            ${App.data.draftInvoice.items.length === 0 ? `
                                                <tr>
                                                    <td colspan="6" class="p-4 text-center text-gray-500">الرجاء إضافة أصناف للفاتورة.</td>
                                                </tr>
                                            ` : App.data.draftInvoice.items.map((item, index) => `
                                                <tr>
                                                    <td class="p-3 font-medium">${item.productName}</td>
                                                    <td class="p-3 text-center">${item.unitPrice.toFixed(2)}</td>
                                                    <td class="p-3 text-center">${item.quantity}</td>
                                                    <td class="p-3 text-center text-red-500">${item.discount.toFixed(0)}%</td>
                                                    <td class="p-3 text-right font-bold">${item.total}</td>
                                                    <td class="p-3 text-center">
                                                        <button type="button" onclick="handleRemoveItem(${index})" class="text-red-600 hover:text-red-800 transition duration-150">
                                                            <i data-lucide="x-circle" class="w-5 h-5"></i>
                                                        </button>
                                                    </td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        
                        <div class="lg:col-span-1 space-y-6 sticky top-6 self-start">
                            
                            <div class="card p-5">
                                <h3 class="text-xl font-semibold border-b pb-2 mb-4 text-shahrazad">ملخص الفاتورة</h3>
                                <div class="space-y-3">
                                    <div class="flex justify-between font-medium">
                                        <span>الإجمالي الفرعي:</span>
                                        <span>${parseFloat(App.data.draftInvoice.subTotal).toFixed(2)}</span>
                                    </div>
                                    <div class="flex justify-between text-red-600">
                                        <span>إجمالي الخصم:</span>
                                        <span>-${parseFloat(App.data.draftInvoice.totalDiscount).toFixed(2)}</span>
                                    </div>
                                    <div class="flex justify-between font-bold text-2xl border-t pt-3 border-gray-300">
                                        <span>الإجمالي النهائي:</span>
                                        <span class="text-green-600">${parseFloat(App.data.draftInvoice.grandTotal).toFixed(2)}</span>
                                    </div>
                                </div>
                            </div>

                            <div class="card p-5 space-y-4">
                                <div>
                                    <label for="invoice-notes" class="block text-sm font-medium text-gray-700">ملاحظات الفاتورة (اختياري)</label>
                                    <textarea id="invoice-notes" name="invoice-notes" rows="3" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-shahrazad focus:border-shahrazad sm:text-sm"></textarea>
                                </div>
                                <button id="save-invoice-btn" type="submit" ${App.data.draftInvoice.items.length === 0 ? 'disabled' : ''} class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-lg text-lg font-bold text-white bg-shahrazad hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-shahrazad transition duration-150 disabled:opacity-50 disabled:cursor-not-allowed">
                                    <i data-lucide="save" class="w-6 h-6 ml-2 inline"></i> حفظ وإصدار الفاتورة
                                </button>
                            </div>
                            
                        </div>
                    </form>
                </div>
            `;
        };
        
        // --- 7. Invoice Detail/Print View ---
        const PrintInvoiceView = () => {
            const invoice = App.currentInvoiceForView;
            if (!invoice) return `<div class="p-6 text-center text-red-500">لم يتم تحديد فاتورة للعرض.</div>`;

            return `
                <div class="print-controls flex justify-center space-x-4 space-x-reverse mb-6">
                    ${Button('العودة للفواتير', `MapsTo('invoices')`, 'default')}
                    ${Button('طباعة / حفظ PDF', `generateInvoicePDF()`, 'success', 'flex items-center')}
                </div>
                
                <div class="print-area max-w-4xl mx-auto card p-8 shadow-xl bg-white">
                    <header class="border-b pb-4 mb-6 flex justify-between items-start">
                        <div>
                            <h1 class="text-3xl font-black text-shahrazad">SHAHRAZAD ELECTRIC</h1>
                            <p class="text-sm text-gray-600 mt-1">نظام إدارة المبيعات والمخزون المتقدم</p>
                        </div>
                        <div class="text-left">
                            <h2 class="text-2xl font-bold text-gray-700">فاتورة مبيعات</h2>
                            <p class="text-lg font-medium text-shahrazad"># ${invoice.invoiceNumber}</p>
                        </div>
                    </header>

                    <section class="grid grid-cols-2 gap-4 mb-8 text-sm">
                        <div>
                            <p class="font-bold text-gray-700">معلومات العميل:</p>
                            <p class="mt-1">${invoice.customerName}</p>
                            <p class="text-gray-500">ID: ${invoice.customerId}</p>
                        </div>
                        <div class="text-left">
                            <p class="font-bold text-gray-700">تاريخ الإصدار:</p>
                            <p class="mt-1">${myAssistant.formatTimestamp(invoice.date)}</p>
                            <p class="text-gray-500">تم بواسطة: ${App.data.users.find(u => u.uid === invoice.createdBy)?.name || 'غير محدد'}</p>
                        </div>
                    </section>

                    <section class="mb-8 overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-300 border border-gray-300">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="p-3 text-right text-sm font-semibold text-gray-700">الصنف</th>
                                    <th class="p-3 text-center text-sm font-semibold text-gray-700">الكمية</th>
                                    <th class="p-3 text-center text-sm font-semibold text-gray-700">سعر الوحدة</th>
                                    <th class="p-3 text-center text-sm font-semibold text-gray-700">الخصم (%)</th>
                                    <th class="p-3 text-right text-sm font-semibold text-gray-700">الإجمالي</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${invoice.items.map(item => `
                                    <tr>
                                        <td class="p-3 text-sm">${item.name}</td>
                                        <td class="p-3 text-center text-sm">${item.quantity}</td>
                                        <td class="p-3 text-center text-sm">${parseFloat(item.unitPrice).toFixed(2)}</td>
                                        <td class="p-3 text-center text-sm">${parseFloat(item.discount).toFixed(0)}%</td>
                                        <td class="p-3 text-right text-sm font-medium">${parseFloat(item.total).toFixed(2)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </section>

                    <footer class="grid grid-cols-2 gap-4">
                        <div>
                            <p class="font-bold text-gray-700 mb-2">ملاحظات:</p>
                            <p class="text-sm text-gray-600 border p-3 rounded-lg bg-gray-50">${invoice.notes || 'لا توجد ملاحظات.'}</p>
                        </div>
                        <div class="text-left space-y-2">
                            <div class="flex justify-between font-medium text-lg border-b pb-1">
                                <span>الإجمالي الفرعي:</span>
                                <span>${parseFloat(invoice.subTotal).toFixed(2)}</span>
                            </div>
                            <div class="flex justify-between text-red-600 font-medium text-lg border-b pb-1">
                                <span>إجمالي الخصم:</span>
                                <span>-${parseFloat(invoice.totalDiscount).toFixed(2)}</span>
                            </div>
                            <div class="flex justify-between font-bold text-3xl pt-2">
                                <span>الإجمالي النهائي:</span>
                                <span class="text-green-600">${parseFloat(invoice.grandTotal).toFixed(2)}</span>
                            </div>
                        </div>
                    </footer>
                    
                    <div class="text-center pt-8 text-xs text-gray-500 border-t mt-8">
                        شكراً لتعاملكم مع SHAHRAZAD ELECTRIC. هذه الفاتورة صدرت بتاريخ ${myAssistant.formatCurrentDate()}.
                    </div>
                </div>
            `;
        };

        // --- 8. Invoices View ---
        const InvoicesView = () => {
            const customerMap = App.data.customers.reduce((map, c) => { map[c.id] = c; return map; }, {});
            const sortedInvoices = App.data.invoices.sort((a, b) => new Date(b.date) - new Date(a.date));

            return `
                <div class="space-y-6">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold text-gray-800">قائمة الفواتير الصادرة (${App.data.invoices.length})</h2>
                        ${Button('إنشاء فاتورة جديدة', `MapsTo('new_invoice')`, 'success', 'flex items-center')}
                    </div>

                    <div class="card overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="p-3 text-right">رقم الفاتورة</th>
                                    <th class="p-3 text-right">العميل</th>
                                    <th class="p-3 text-center">التاريخ</th>
                                    <th class="p-3 text-center">الإجمالي النهائي (جنيه)</th>
                                    <th class="p-3 text-center">الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${App.data.invoices.length === 0 ? `
                                    <tr>
                                        <td colspan="5" class="p-4 text-center text-gray-500">لم يتم إصدار أي فواتير بعد.</td>
                                    </tr>
                                ` : sortedInvoices.map(inv => {
                                    const customer = customerMap[inv.customerId];
                                    return `
                                        <tr>
                                            <td class="p-3 font-bold text-shahrazad"># ${inv.invoiceNumber}</td>
                                            <td class="p-3">${inv.customerName}</td>
                                            <td class="p-3 text-center text-sm">${myAssistant.formatTimestamp(inv.date)}</td>
                                            <td class="p-3 text-center font-bold text-green-600">${parseFloat(inv.grandTotal).toFixed(2)}</td>
                                            <td class="p-3 text-center">
                                                ${Button('عرض الفاتورة', `MapsTo('invoice_details', ${JSON.stringify(inv).replace(/'/g, "\\'")})`, 'primary', 'text-xs')}
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        };
        
        // --- 9. Customers View ---
        const CustomersView = () => {
            const sortedCustomers = App.data.customers.sort((a, b) => (b.totalSpent || 0) - (a.totalSpent || 0));
            
            // Re-calculate Total Spent from invoices for a more accurate view (though Firestore triggers usually keep it up to date)
            const spentMap = App.data.invoices.reduce((acc, inv) => {
                acc[inv.customerId] = (acc[inv.customerId] || 0) + parseFloat(inv.grandTotal);
                return acc;
            }, {});

            return `
                <div class="space-y-6">
                    <h2 class="text-2xl font-bold text-gray-800">قائمة العملاء (${App.data.customers.length})</h2>

                    <div class="card overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="p-3 text-right">العميل</th>
                                    <th class="p-3 text-center">إجمالي الإنفاق (جنيه)</th>
                                    <th class="p-3 text-center">عميل مميز (VIP)</th>
                                    <th class="p-3 text-center">تاريخ التسجيل</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${App.data.customers.length === 0 ? `
                                    <tr>
                                        <td colspan="4" class="p-4 text-center text-gray-500">لا يوجد عملاء مسجلون بعد.</td>
                                    </tr>
                                ` : sortedCustomers.map(c => {
                                    const totalSpent = spentMap[c.id] || parseFloat(c.totalSpent) || 0;
                                    const isDistinguished = totalSpent >= 50000; // Example criteria
                                    
                                    return `
                                        <tr>
                                            <td class="p-3 font-medium">${c.name}</td>
                                            <td class="p-3 text-center font-bold text-blue-600">${totalSpent.toLocaleString('en-US', { minimumFractionDigits: 2 })}</td>
                                            <td class="p-3 text-center">
                                                <span class="px-2 py-1 text-xs font-semibold rounded-full ${isDistinguished ? 'bg-yellow-100 text-yellow-800' : 'bg-gray-100 text-gray-800'}">
                                                    ${isDistinguished ? 'مميز' : 'عادي'}
                                                </span>
                                            </td>
                                            <td class="p-3 text-center text-sm">${myAssistant.formatTimestamp(c.createdAt)}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        };
        
        // --- 10. Alerts View ---
        const AlertsView = () => {
            const lowStockProducts = App.data.products.filter(p => (p.displayed_stock || 0) <= (p.lowStockThreshold || 10));

            return `
                <div class="space-y-6">
                    <h2 class="text-2xl font-bold text-gray-800">تنبيهات نقص المخزون (البضاعة المعروضة)</h2>

                    <div class="card p-6">
                        <p class="text-lg text-red-700 font-semibold mb-4">
                            الأصناف التي تقل كميتها المعروضة عن الحد الأدنى للتنبيه (يتم تعيين الحد الأدنى لكل صنف):
                        </p>
                        <div id="alerts-container-full" class="space-y-3">
                            ${lowStockProducts.length > 0 ? lowStockProducts.map(p => 
                                `<div class="p-4 bg-red-100 text-red-700 rounded-lg shadow-sm flex justify-between items-center border-r-4 border-red-500">
                                    <div class="flex items-center">
                                        <i data-lucide="alert-triangle" class="w-5 h-5 ml-3 flex-shrink-0"></i>
                                        <p class="font-medium">الصنف: **${p.name}**</p>
                                    </div>
                                    <div class="text-left">
                                        <p>الكمية المعروضة: <span class="font-bold">${p.displayed_stock || 0}</span></p>
                                        <p class="text-sm text-red-500">الحد الأدنى: ${p.lowStockThreshold || 10}</p>
                                        ${Button('إدارة المخزون', `openInventoryModal(${JSON.stringify(p).replace(/'/g, "\\'")})`, 'warning', 'text-xs mt-2')}
                                    </div>
                                </div>`
                            ).join('') : `<p class="text-gray-500 text-center p-6">لا توجد تنبيهات نقص مخزون حالياً في البضاعة المعروضة.</p>`}
                        </div>
                    </div>
                </div>
            `;
        };
        
        // --- 11. General Settings View ---
        
        // Warehouse Management Handlers
        window.handleAddWarehouse = async () => {
            const nameInput = document.getElementById('new-warehouse-name');
            const name = nameInput.value.trim();
            if (!name) {
                alertUser('يرجى إدخال اسم المخزن.', 'error');
                return;
            }
            try {
                await addDoc(collection(App.db, App.getCollectionPath('warehouses')), { name: name, createdAt: new Date().toISOString() });
                alertUser(`تم إضافة المخزن **${name}** بنجاح.`, 'success');
                nameInput.value = '';
            } catch (error) {
                alertUser(`فشل إضافة المخزن: ${error.message}`, 'error');
            }
        };

        window.handleDeleteWarehouse = async (id, name) => {
            if (!confirm(`هل أنت متأكد من حذف المخزن: ${name}؟ سيتم فصل الأصناف المرتبطة به.`)) return;
            try {
                await deleteDoc(doc(App.db, App.getCollectionPath('warehouses'), id));
                alertUser(`تم حذف المخزن **${name}** بنجاح.`, 'success');
            } catch (error) {
                alertUser(`فشل حذف المخزن: ${error.message}`, 'error');
            }
        };

        const GeneralSettingsView = () => `
            <div class="space-y-6">
                <h2 class="text-2xl font-bold text-gray-800">الإعدادات العامة</h2>
                
                <div class="card p-6">
                    <h3 class="text-xl font-semibold border-b pb-2 mb-4 text-shahrazad">إدارة المخازن/المستودعات</h3>
                    <div class="space-y-4">
                        <div class="flex space-x-4 space-x-reverse">
                            <input type="text" id="new-warehouse-name" placeholder="اسم المخزن الجديد..." class="flex-grow p-2 border border-gray-300 rounded-md shadow-sm focus:ring-shahrazad focus:border-shahrazad">
                            ${Button('إضافة مخزن', `handleAddWarehouse()`, 'primary', 'flex items-center')}
                        </div>
                        
                        <div class="border-t pt-4 space-y-2 max-h-48 overflow-y-auto">
                            ${App.data.warehouses.length === 0 ? `
                                <p class="text-gray-500">لا توجد مخازن مسجلة حالياً.</p>
                            ` : App.data.warehouses.map(w => `
                                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-md">
                                    <p class="font-medium">${w.name}</p>
                                    ${Button('حذف', `handleDeleteWarehouse('${w.id}', '${w.name}')`, 'danger', 'text-xs')}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>

                <div class="card p-6">
                    <h3 class="text-xl font-semibold border-b pb-2 mb-4 text-shahrazad">إدارة البيانات</h3>
                    <div class="flex justify-between items-center">
                        <p class="text-gray-700">تنزيل نسخة احتياطية كاملة (JSON) لجميع بيانات النظام.</p>
                        <button id="backup-btn" onclick="backupData()" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 transition duration-150">
                            <i data-lucide="download" class="w-5 h-5 ml-2"></i> تنزيل نسخة احتياطية
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        // --- 12. User Settings View (Admin Only) ---
        const UserSettingsView = () => {
            if (App.userRole !== 'admin') {
                return `
                    <div class="card p-6 bg-red-100 text-red-800">
                        <i data-lucide="lock" class="w-6 h-6 inline ml-2"></i>
                        عذراً، هذه الصفحة مخصصة للمدير الأساسي فقط.
                    </div>
                `;
            }

            return `
                <div class="space-y-6">
                    <h2 class="text-2xl font-bold text-gray-800">إدارة المستخدمين (للمدير الأساسي فقط)</h2>
                    
                    <div class="card p-6">
                        <h3 class="text-xl font-semibold border-b pb-2 mb-4 text-shahrazad">إضافة مستخدم جديد</h3>
                        <form id="add-user-form" onsubmit="handleUserCreate(event)" class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                ${Input({ label: 'الاسم (اختياري)', id: 'user-name', name: 'user-name', required: false })}
                                ${Input({ label: 'البريد الإلكتروني', id: 'user-email', name: 'user-email', type: 'email', required: true })}
                                ${Input({ label: 'كلمة المرور', id: 'user-password', name: 'user-password', type: 'password', required: true })}
                                ${Select({ 
                                    label: 'الدور/الصلاحية', 
                                    id: 'user-role', 
                                    name: 'user-role', 
                                    options: [{ value: 'admin', text: 'المدير الأساسي (Admin)' }, { value: 'staff', text: 'موظف (Staff)' }],
                                    selectedValue: 'staff',
                                    required: true
                                })}
                            </div>
                            <div class="flex justify-end">
                                <button type="submit" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-shahrazad hover:bg-blue-700 transition duration-150">
                                    <i data-lucide="user-plus" class="w-5 h-5 ml-2"></i> إضافة مستخدم جديد
                                </button>
                            </div>
                        </form>
                    </div>
                    
                    <div class="card p-6">
                        <h3 class="text-xl font-semibold border-b pb-2 mb-4 text-shahrazad">المستخدمون الحاليون (${App.data.users.length})</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="p-3 text-right">الاسم والبريد</th>
                                        <th class="p-3 text-center">الدور</th>
                                        <th class="p-3 text-center">الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    ${App.data.users.map(u => `
                                        <tr>
                                            <td class="p-3">
                                                <p class="font-medium">${u.name || 'غير محدد'}</p>
                                                <p class="text-sm text-gray-500">${u.email || 'N/A'}</p>
                                            </td>
                                            <td class="p-3 text-center">
                                                <span class="px-2 py-1 text-xs font-semibold rounded-full ${u.role === 'admin' ? 'bg-red-100 text-red-800' : 'bg-blue-100 text-blue-800'}">
                                                    ${u.role === 'admin' ? 'مدير أساسي' : 'موظف'}
                                                </span>
                                            </td>
                                            <td class="p-3 text-center">
                                                ${u.uid === App.userId ? 
                                                    `<span class="text-sm text-gray-500">أنت المستخدم الحالي</span>` : 
                                                    Button('حذف', `handleUserDelete('${u.uid}', '${u.email}')`, 'danger', 'text-xs')
                                                }
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        };


        // ====================================================================
        //                      App Initialization
        // ====================================================================

        App.views = {
            loading: LoadingView,
            auth_error: AuthErrorView,
            login: LoginView,
            dashboard: DashboardView,
            products: ProductsView,
            invoices: InvoicesView,
            new_invoice: NewInvoiceView, // Added new view
            invoice_details: PrintInvoiceView, // Added new view
            customers: CustomersView,
            alerts: AlertsView,
            general_settings: GeneralSettingsView,
            user_settings: UserSettingsView,
        };
        
        // This function handles rendering the current view and is called after state changes.
        function render() {
            const appRoot = document.getElementById('app-root');
            if (appRoot) {
                // Determine if there's any data passed through navigation to keep the state clean
                const data = window.App.viewData;
                window.App.viewData = null; // Clear view data after usage
                
                // If the view requires dynamic data that changes the rendering (like editing a specific product)
                if (window.App.view === 'products' && data) {
                    appRoot.innerHTML = MainLayout();
                } else {
                     appRoot.innerHTML = MainLayout();
                }
                lucide.createIcons();
            }
        }

        // --- Start Application ---

        // 1. Setup global container
        const appContainer = document.createElement('div');
        appContainer.id = 'app-root';
        document.body.appendChild(appContainer);

        // 2. Start Auth Process
        authenticateUser().then(() => { setupAuthStateListener(); });
    </script>
    
    <div id="global-alert" class="fixed top-4 right-4 z-50 p-4 rounded-lg shadow-xl text-white transition-all duration-300 transform -translate-y-20 opacity-0">
        </div>
    
</body>
</html>
