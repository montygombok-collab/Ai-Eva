<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SHAHRAZAD ELECTRIC | نظام إدارة المبيعات المتقدم</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <style>
        /* Custom styles for SHAHRAZAD ELECTRIC identity */
        body { font-family: 'Cairo', sans-serif; background-color: #f4f7fa; }
        /* Brand color (Strong blue) */
        .text-shahrazad { color: #004d99; } 
        .bg-shahrazad { background-color: #004d99; }
        /* Advanced gradient background */
        .gradient-bg { background: linear-gradient(135deg, #004d99 0%, #002d5b 100%); }
        /* Soft-edged cards with high shadow */
        .card { background-color: white; border-radius: 12px; box-shadow: 0 6px 15px rgba(0, 0, 0, 0.08); transition: transform 0.2s; }
        .card:hover { transform: translateY(-3px); box-shadow: 0 12px 25px rgba(0, 0, 0, 0.12); }
        /* Chat box style for the smart assistant */
        #chat-body { height: 300px; overflow-y: auto; display: flex; flex-direction: column-reverse; }
        .chat-message-user { background-color: #dbeafe; border-bottom-right-radius: 0; }
        .chat-message-ai { background-color: #e0f2f1; color: #004d99; border-bottom-left-radius: 0; }
        
        /* Styles for printing the invoice */
        @media print {
            body * {
                visibility: hidden;
            }
            .print-area, .print-area * {
                visibility: visible;
            }
            .print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                margin: 0;
                padding: 0;
            }
            /* Hide print-only buttons */
            .print-controls {
                display: none !important;
            }
        }

        /* Badge styles for customer levels */
        .badge-bronze { background-color: #cd7f32; color: white; }
        .badge-silver { background-color: #c0c0c0; color: black; }
        .badge-gold { background-color: #ffd700; color: black; }
        .badge-platinum { background-color: #e5e4e2; color: black; }
    </style>
</head>
<body>

    <script type="module">
        
        // --- 1. Firebase Configuration ---
        const defaultFirebaseConfig = {
            apiKey: "AIzaSyBtc-pniRx5Mda5UW_kNqS0Zyi8zcKvdlU",
            authDomain: "shahrazad-electric.firebaseapp.com",
            projectId: "shahrazad-electric",
            storageBucket: "shahrazad-electric.firebasestorage.app",
            messagingSenderId: "582314926345",
            appId: "1:582314926345:web:39c2979beadd8b47a133d8",
            measurementId: "G-3RH0BKKW16"
        };
        
        // Fetch global variables from the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-shahrazad-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const firestoreConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : defaultFirebaseConfig;

        // --- 2. Firebase Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // تم إضافة createUserWithEmailAndPassword لاستخدامها في صفحة إدارة المستخدمين
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut, updatePassword, signInWithEmailAndPassword, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, query, where, addDoc, updateDoc, deleteDoc, writeBatch, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- 3. Initialization ---
        const app = initializeApp(firestoreConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        setLogLevel('Debug'); // Enable debug logs

        // --- 4. Global State (App) ---
        window.App = {
            db,
            auth,
            appId,
            userId: null,
            userRole: 'staff',
            view: 'loading',
            data: { products: [], customers: [], invoices: [], users: [], alerts: [], warehouses: [], displayedProducts: [] },
            draftInvoice: { items: [], subTotal: 0, totalDiscount: 0, grandTotal: 0 }, // New state for invoice creation
            currentInvoiceForView: null, // New state for print view
            
            // Public collection path (for products, invoices, users)
            getCollectionPath(collectionName) {
                return `artifacts/${this.appId}/public/data/${collectionName}`;
            },
        };

        // ====================================================================
        //                      MERGED UTILITY CLASS (Assistant) 
        // ====================================================================
        /**
         * Assistant Class (فئة المساعد)
         */
        class Assistant {
            constructor(name = "المساعد الرقمي") {
                this.name = name;
            }

            calculateSum(a, b) {
                if (typeof a !== 'number' || typeof b !== 'number') {
                    return NaN;
                }
                return a + b;
            }

            generateGreeting(userName) {
                if (!userName || typeof userName !== 'string') {
                    userName = "صديقنا العزيز";
                }
                return `أهلاً بك يا ${userName}! ${this.name} في خدمتك.`;
            }

            /**
             * تنسيق التاريخ (Format Date)
             */
            formatCurrentDate() {
                const now = new Date();
                const options = { year: 'numeric', month: 'long', day: 'numeric' };
                // استخدام اللغة العربية في التنسيق
                return now.toLocaleDateString('ar-EG', options);
            }
            
            formatTimestamp(timestamp) {
                if (!timestamp) return 'غير محدد';
                // Check if it's a Firestore Timestamp object or a string
                const date = (timestamp.toDate && typeof timestamp.toDate === 'function') ? timestamp.toDate() : new Date(timestamp);
                const options = { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' };
                return date.toLocaleDateString('ar-EG', options);
            }
        }
        
        const myAssistant = new Assistant("مساعد واجهة المستخدم");
        
        // ====================================================================
        //                      Customer Points & Discount System
        // ====================================================================

        // إعدادات نظام النقاط (يمكن تعديلها)
        const POINTS_CONFIG = {
            pointsPerInvoice: 10,            // نقاط لكل فاتورة
            bronzeThreshold: 50,             // حد البرونز
            silverThreshold: 100,            // حد الفضة
            goldThreshold: 250,              // حد الذهب  
            platinumThreshold: 500,          // حد البلاتين
            bronzeDiscount: 2,               // تخفيض البرونز 2%
            silverDiscount: 5,               // تخفيض الفضة 5%
            goldDiscount: 10,                // تخفيض الذهب 10%
            platinumDiscount: 15             // تخفيض البلاتين 15%
        };

        // تحديث نقاط العميل عند إنشاء فاتورة
        async function updateCustomerPoints(customerId, invoiceAmount) {
            try {
                const customerRef = doc(App.db, App.getCollectionPath('customers'), customerId);
                const customerDoc = await getDoc(customerRef);
                
                if (customerDoc.exists()) {
                    const customerData = customerDoc.data();
                    const currentPoints = customerData.points || 0;
                    const totalInvoices = (customerData.totalInvoices || 0) + 1;
                    
                    // حساب النقاط الجديدة
                    const newPoints = currentPoints + POINTS_CONFIG.pointsPerInvoice;
                    
                    // تحديد مستوى التخفيض
                    let discountLevel = 'عادي';
                    let customerDiscount = 0;
                    
                    if (newPoints >= POINTS_CONFIG.platinumThreshold) {
                        discountLevel = 'بلاتين';
                        customerDiscount = POINTS_CONFIG.platinumDiscount;
                    } else if (newPoints >= POINTS_CONFIG.goldThreshold) {
                        discountLevel = 'ذهبي';
                        customerDiscount = POINTS_CONFIG.goldDiscount;
                    } else if (newPoints >= POINTS_CONFIG.silverThreshold) {
                        discountLevel = 'فضي';
                        customerDiscount = POINTS_CONFIG.silverDiscount;
                    } else if (newPoints >= POINTS_CONFIG.bronzeThreshold) {
                        discountLevel = 'برونزي';
                        customerDiscount = POINTS_CONFIG.bronzeDiscount;
                    }

                    // تحديث بيانات العميل
                    await updateDoc(customerRef, {
                        points: newPoints,
                        totalInvoices: totalInvoices,
                        discountLevel: discountLevel,
                        customerDiscount: customerDiscount,
                        totalSpent: (customerData.totalSpent || 0) + invoiceAmount,
                        lastPurchaseDate: new Date().toISOString()
                    });

                    console.log(`تم تحديث نقاط العميل: ${newPoints} نقطة، مستوى: ${discountLevel}`);
                }
            } catch (error) {
                console.error("Error updating customer points:", error);
            }
        }

        // الحصول على لون البادج حسب المستوى
        function getBadgeColor(level) {
            switch(level) {
                case 'برونزي': return 'badge-bronze';
                case 'فضي': return 'badge-silver';
                case 'ذهبي': return 'badge-gold';
                case 'بلاتين': return 'badge-platinum';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        // الحصول على التخفيض التلقائي للعميل
        function getCustomerDiscount(customerId) {
            const customer = App.data.customers.find(c => c.id === customerId);
            return customer ? (customer.customerDiscount || 0) : 0;
        }

        // ====================================================================
        //                      Auth and Role Management Unit (Auth & Roles)       
        // ====================================================================
        
        async function authenticateUser() {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(App.auth, initialAuthToken);
                } 
                // تم إزالة signInAnonymously() هنا. سيتم تحويل المستخدم إلى صفحة الدخول إذا لم يكن هناك توكن.
            } catch (error) {
                console.error("Critical Firebase authentication error:", error);
                App.view = 'auth_error';
                render();
            }
        }

        function setupAuthStateListener() {
            onAuthStateChanged(App.auth, async (user) => {
                if (user) {
                    App.userId = user.uid;
                    const userDocRef = doc(App.db, App.getCollectionPath('users'), user.uid);
                    const userDoc = await getDoc(userDocRef);
                    
                    if (userDoc.exists()) {
                        App.userRole = userDoc.data().role || 'staff';
                    } else {
                        // Logic to assign 'admin' to the FIRST user in Firestore
                        const usersCollectionRef = collection(App.db, App.getCollectionPath('users'));
                        const usersSnapshot = await getDocs(usersCollectionRef);
                        
                        // If collection is empty, this user is the Admin.
                        if (usersSnapshot.size === 0) {
                             App.userRole = 'admin'; 
                             alertUser("تهانينا! أنت أول مستخدم وتم تعيين دور 'المدير الأساسي' لك تلقائياً.", "success");
                        } else {
                             App.userRole = 'staff'; 
                        }
                        
                        // Save the new user record with assigned role
                        await setDoc(userDocRef, { uid: user.uid, role: App.userRole, createdAt: new Date().toISOString(), email: user.email || 'N/A' }, { merge: true });
                    }

                    setupFirestoreListeners();
                    App.view = 'dashboard'; // Direct routing to dashboard
                } else {
                    // إذا لم يكن هناك مستخدم، اذهب إلى صفحة تسجيل الدخول
                    App.userId = null;
                    App.view = 'login'; 
                }
                render();
            });
        }
        
        window.handleLogout = () => {
             signOut(App.auth).then(() => { 
                alertUser("تم تسجيل الخروج بنجاح.", "success"); 
             }).catch(console.error);
        };
        
        /**
         * معالج تسجيل الدخول: يدعم البريد وكلمة المرور أو وضع الاختبار المجهول
         */
        window.handleLoginSubmit = async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const loginBtn = document.getElementById('login-btn');
            
            loginBtn.disabled = true;
            loginBtn.innerHTML = `<i data-lucide="loader-circle" class="w-5 h-5 ml-2 inline animate-spin"></i> جاري الدخول...`;

            try {
                // وضع الاختبار: تسجيل دخول مجهول
                if (email.toLowerCase() === "test" && password === "test") {
                    await signInAnonymously(App.auth);
                    alertUser("تم تسجيل الدخول بنجاح كـ 'وضع الاختبار المجهول'.", "success");
                } else {
                    // تسجيل الدخول بالبريد وكلمة المرور
                    await signInWithEmailAndPassword(App.auth, email, password);
                    alertUser("تم تسجيل الدخول بنجاح.", "success");
                }
            } catch (error) {
                console.error("Login error:", error);
                
                let errorMessage = "فشل تسجيل الدخول. يرجى التحقق من البريد الإلكتروني وكلمة المرور.";
                if (error.code === 'auth/user-not-found') {
                    errorMessage = "البريد الإلكتروني غير مسجل في النظام. (ربما تحتاج لتسجيل مستخدم جديد في Firebase).";
                } else if (error.code === 'auth/wrong-password') {
                    errorMessage = "كلمة المرور غير صحيحة.";
                } else if (error.code === 'auth/invalid-credential') {
                     errorMessage = "بيانات الاعتماد غير صالحة.";
                }
                
                alertUser(errorMessage, 'error');
            } finally {
                loginBtn.disabled = false;
                loginBtn.innerHTML = `<i data-lucide="log-in" class="w-5 h-5 ml-2 inline"></i> تسجيل الدخول`;
                lucide.createIcons();
            }
        };

        /**
         * معالج إنشاء مستخدم جديد (Admin Only)
         */
        window.handleUserCreate = async (e) => {
            e.preventDefault();
            const form = document.getElementById('add-user-form');
            const email = form.querySelector('#user-email').value;
            const password = form.querySelector('#user-password').value;
            const role = form.querySelector('#user-role').value;
            const name = form.querySelector('#user-name').value;
            const createBtn = form.querySelector('button[type="submit"]');

            if (App.userRole !== 'admin') {
                alertUser("عذراً، يجب أن تكون بـ **صلاحية المدير الأساسي** لإنشاء مستخدمين جدد.", "error");
                return;
            }

            createBtn.disabled = true;
            createBtn.innerHTML = `<i data-lucide="loader-circle" class="w-5 h-5 ml-2 inline animate-spin"></i> جاري الإنشاء...`;
            lucide.createIcons();
            
            try {
                // 1. Create user in Firebase Auth
                const userCredential = await createUserWithEmailAndPassword(App.auth, email, password);
                const user = userCredential.user;
                
                // 2. Save user role and details in Firestore
                const userDocRef = doc(App.db, App.getCollectionPath('users'), user.uid);
                await setDoc(userDocRef, { 
                    uid: user.uid, 
                    role: role, 
                    email: user.email,
                    name: name || 'غير محدد',
                    createdAt: new Date().toISOString(),
                });
                
                alertUser(`تم إنشاء المستخدم **${email}** بنجاح وتعيين دور ${role}.`, "success");
                form.reset();

            } catch (error) {
                console.error("User creation error:", error);
                let errorMessage = "فشل إنشاء المستخدم. يرجى التحقق من البيانات.";
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = "هذا البريد الإلكتروني مستخدم بالفعل.";
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = "كلمة المرور ضعيفة جداً (يجب أن تكون 6 أحرف على الأقل).";
                } else if (error.code === 'auth/operation-not-allowed') {
                    errorMessage = "غير مسموح بإنشاء المستخدمين. يرجى تفعيل (Email/Password) في إعدادات Firebase Authentication.";
                }
                alertUser(errorMessage, 'error');
            } finally {
                createBtn.disabled = false;
                createBtn.innerHTML = `<i data-lucide="user-plus" class="w-5 h-5 ml-2 inline"></i> إضافة مستخدم جديد`;
                lucide.createIcons();
            }
        };

        /**
         * معالج حذف مستخدم (Admin Only)
         */
        window.handleUserDelete = async (userId, userEmail) => {
            if (App.userRole !== 'admin') {
                alertUser("عذراً، يجب أن تكون بـ **صلاحية المدير الأساسي** للحذف.", "error");
                return;
            }
            if (!confirm(`هل أنت متأكد من حذف سجل المستخدم: ${userEmail}؟ لا يمكن التراجع عن هذا الإجراء!`)) return;

            // نحذف السجل من Firestore فقط، لأن حذف المستخدم من Firebase Auth 
            // يتطلب Admin SDK لأسباب أمنية. نعتمد على أن السجل المحذوف 
            // سيمنع المستخدم من الحصول على دور "admin" أو "staff" في هذا التطبيق.
            
            try {
                // حذف سجل المستخدم من Firestore
                await deleteDoc(doc(App.db, App.getCollectionPath('users'), userId));
                alertUser(`تم حذف سجل المستخدم **${userEmail}** من قاعدة بيانات Firestore بنجاح.`, "success");
            } catch (error) {
                console.error("User deletion error:", error);
                alertUser(`فشل حذف المستخدم: ${error.message}`, "error");
            }
        };

        
        // ====================================================================
        //                      Real-Time Data Fetching Unit (Firestore)      
        // ====================================================================

        function setupFirestoreListeners() {
            if (!App.userId) return;

            // 1. Products and Inventory
            onSnapshot(collection(App.db, App.getCollectionPath('products')), (snapshot) => {
                App.data.products = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                checkLowStockAlerts();
                if (['products', 'dashboard', 'alerts', 'invoices', 'new_invoice', 'displayed_products'].includes(App.view)) render(); 
            }, console.error);

            // 2. Customers
            onSnapshot(collection(App.db, App.getCollectionPath('customers')), (snapshot) => {
                App.data.customers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (['customers', 'invoices', 'dashboard', 'new_invoice'].includes(App.view)) render();
            }, console.error);
            
            // 3. Invoices
            onSnapshot(collection(App.db, App.getCollectionPath('invoices')), (snapshot) => {
                App.data.invoices = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (['dashboard', 'invoices'].includes(App.view)) render();
            }, console.error);
            
             // 4. Users
            onSnapshot(collection(App.db, App.getCollectionPath('users')), (snapshot) => {
                App.data.users = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (App.view === 'user_settings') render();
            }, console.error);
            
             // 5. Warehouses
            onSnapshot(collection(App.db, App.getCollectionPath('warehouses')), (snapshot) => {
                App.data.warehouses = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // إعادة عرض صفحات المنتجات والإعدادات التي تعتمد على المخازن
                if (['products', 'general_settings', 'new_invoice', 'displayed_products'].includes(App.view)) render();
            }, console.error);

            // 6. Displayed Products
            onSnapshot(collection(App.db, App.getCollectionPath('displayedProducts')), (snapshot) => {
                App.data.displayedProducts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (['products', 'dashboard', 'displayed_products'].includes(App.view)) render(); 
            }, console.error);
        }
        
        // ====================================================================
        //                      Inventory and Alerts Unit
        // ====================================================================

        function checkLowStockAlerts() {
            const lowStockProducts = App.data.products.filter(p => p.stock <= (p.lowStockThreshold || 10));
            const alertsContainer = document.getElementById('alerts-container');
            const alertsContainerFull = document.getElementById('alerts-container-full');
            
            const alertHTML = lowStockProducts.length > 0
                ? lowStockProducts.map(p => 
                    `<div class="p-3 mb-2 bg-red-100 text-red-700 rounded-lg shadow-sm flex justify-between items-center text-sm border-r-4 border-red-500">
                        <i data-lucide="alert-triangle" class="w-4 h-4 ml-2"></i>
                        <p>الصنف **${p.name}** منخفض. الكمية: **${p.stock}**</p>
                    </div>`
                ).join('')
                : `<p class="text-gray-500 text-sm p-4 text-center">لا توجد تنبيهات نقص مخزون حالياً.</p>`;
                
            if (alertsContainer) alertsContainer.innerHTML = alertHTML;
            if (alertsContainerFull) alertsContainerFull.innerHTML = alertHTML;
            lucide.createIcons();
        }
        
        // ====================================================================
        //                      Smart Assistant Unit (Gemini API Integration)       
        // = ====================================================================

        window.toggleAssistant = () => {
            const container = document.getElementById('smart-assistant-container');
            container.style.display = container.style.display === 'none' ? 'flex' : 'none'; // Changed to flex for better layout
        };
        
        window.sendAssistantQuery = async () => {
            const input = document.getElementById('chat-input');
            const query = input.value.trim();
            if (!query) return;

            const chatBody = document.getElementById('chat-body');
            // User message
            chatBody.insertAdjacentHTML('afterbegin', `
                <div class="flex justify-start mb-2">
                    <div class="max-w-xs p-3 rounded-xl chat-message-user shadow-md">${query}</div>
                </div>
            `);
            input.value = '';
            
            // Typing indicator
            chatBody.insertAdjacentHTML('afterbegin', `
                <div id="ai-typing-indicator" class="flex justify-end mb-2">
                    <div class="max-w-xs p-3 rounded-xl chat-message-ai shadow-md">... جاري التفكير</div>
                </div>
            `);
            
            const typingIndicator = document.getElementById('ai-typing-indicator');

            // Prepare the model context (System Prompt)
            const productList = App.data.products.map(p => `ID:${p.id}, Name:${p.name}, Stock:${p.stock}, Price:${p.price}, Warehouse:${p.warehouse}, Threshold:${p.lowStockThreshold}`).join('; ');
            const customerList = App.data.customers.map(c => `Name:${c.name}, Distinguished:${c.isDistinguished}, Spent:${c.totalSpent || 0}`).join('; ');

            const systemPrompt = `
                أنت المساعد الذكي لشركة SHAHRAZAD ELECTRIC. مهمتك هي الإجابة على استفسارات المستخدمين باللغة العربية بناءً على البيانات المقدمة.
                - اعتمد على البيانات التالية لتكون إجاباتك دقيقة ومرتبطة ببيانات المخزون والمبيعات.
                - يجب أن تكون الإجابات مهنية وموجزة.

                **بيانات النظام الحالية:**
                - المنتجات والمخزون: [${productList}]
                - العملاء وإجمالي الإنفاق: [${customerList}]
            `;
            
            // NOTE: apiKey MUST be empty string as per environment rules.
            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{ parts: [{ text: query }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            try {
                let resultText = "عذراً، لم أتمكن من الحصول على استجابة.";
                let apiSuccess = false;
                
                // --- START Exponential Backoff Retry Logic (To ensure API Key injection) ---
                for (let attempt = 0; attempt < 3; attempt++) {
                    const response = await fetch(apiUrl, { 
                        method: 'POST', 
                        headers: { 'Content-Type': 'application/json' }, 
                        body: JSON.stringify(payload) 
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        resultText = result.candidates?.[0]?.content?.parts?.[0]?.text || resultText;
                        apiSuccess = true;
                        break; 
                    } 
                    
                    if (response.status === 429) { 
                        // Too Many Requests - Retry with backoff
                        await new Promise(resolve => setTimeout(resolve, Math.pow(2, attempt) * 1000));
                        continue;
                    } else if (response.status === 403 && attempt < 2) {
                        // 403 Forbidden is the typical error when the key is missing. Retry for key injection.
                         await new Promise(resolve => setTimeout(resolve, Math.pow(2, attempt) * 1000));
                         continue;
                    } else { 
                        // Critical error or last 403 failed, break and trigger MOCKING
                        throw new Error(`API error: ${response.status} - Critical failure.`);
                    }
                }
                
                if (!apiSuccess) {
                     // If loop finished without success (e.g., all 403 retries failed), trigger MOCKING.
                     throw new Error("All API attempts failed, falling to mocking.");
                }
                
                // --- END Exponential Backoff Retry Logic ---

                // Remove typing indicator and add AI response
                typingIndicator.remove();
                chatBody.insertAdjacentHTML('afterbegin', `
                    <div class="flex justify-end mb-2">
                        <div class="max-w-xs p-3 rounded-xl chat-message-ai shadow-md">${resultText}</div>
                    </div>
                `);
                
            } catch (error) {
                console.error("Gemini API connection failed, falling back to Mocking Logic:", error);

                // =========================================================
                // START MOCKING LOGIC (Fallback for connection errors)
                // =========================================================
                
                let mockResultText = `
                    <p class="font-bold text-red-600 mb-2">⚠️ **خطأ في الاتصال بالذكاء الاصطناعي.** نظراً لمشكلة في الاتصال (قد تكون بسبب حقن المفتاح)، سأقوم بالرد آلياً الآن اعتماداً على بيانات Firestore المحلية:</p>
                `;

                const lowerQuery = query.toLowerCase();
                
                if (lowerQuery.includes('مخزون') || lowerQuery.includes('نقص') || lowerQuery.includes('منخفض') || lowerQuery.includes('مخزن')) {
                    const lowStockItems = App.data.products.filter(p => p.stock <= (p.lowStockThreshold || 10));
                    
                    if (lowStockItems.length > 0) {
                        mockResultText += `<p>هناك **${lowStockItems.length} صنف** يعاني من نقص في المخزون (أقل من ${lowStockItems[0].lowStockThreshold || 10}):</p>`;
                        lowStockItems.slice(0, 3).forEach(item => { // Show top 3
                            mockResultText += `<p class="mt-1 pr-3 border-r-4 border-red-500">**${item.name}**: الكمية ${item.stock} في مخزن ${item.warehouse}.</p>`;
                        });
                    } else {
                        mockResultText += `<p>**المخزون:** جميع الأصناف تبدو جيدة ولا توجد تنبيهات نقص مخزون حالياً.</p>`;
                    }
                } else if (lowerQuery.includes('عميل') || lowerQuery.includes('مميز') || lowerQuery.includes('vip')) {
                    const distinguishedCount = App.data.customers.filter(c => c.isDistinguished).length;
                    const totalCustomers = App.data.customers.length;
                    mockResultText += `<p>**العملاء:** لدينا **${distinguishedCount} عميل مميز (VIP)** من أصل ${totalCustomers} عميل مسجل في النظام.</p>`;
                } else if (lowerQuery.includes('سعر') || lowerQuery.includes('أغلى')) {
                    const mostExpensive = App.data.products.sort((a, b) => b.price - a.price)[0];
                    if (mostExpensive) {
                        mockResultText += `<p>**معلومات السعر:** أغلى صنف مسجل هو **${mostExpensive.name}** بسعر ${mostExpensive.price.toFixed(2)} جنيه سوداني.</p>`;
                    } else {
                        mockResultText += `<p>**معلومات السعر:** لا توجد أصناف مسجلة لحساب السعر.</p>`;
                    }
                } else {
                    mockResultText += `<p>**رسالة عامة:** أنا مستعد لمساعدتك في استعراض بيانات SHAHRAZAD ELECTRIC. يمكنك سؤالي عن "نقص المخزون"، "العملاء المميزون"، أو "سعر صنف معين".</p>`;
                }
                // =========================================================
                // END MOCKING LOGIC
                // =========================================================

                typingIndicator.remove();
                chatBody.insertAdjacentHTML('afterbegin', `
                    <div class="flex justify-end mb-2">
                        <div class="max-w-xs p-3 rounded-xl chat-message-ai shadow-md">${mockResultText}</div>
                    </div>
                `);
            }
        };

        // ====================================================================
        //                      Invoice Management Unit (NEW)
        // ====================================================================

        // Helper to calculate totals based on items in App.data.draftInvoice.items
        window.calculateInvoiceTotals = () => {
            let subTotal = 0;
            let totalDiscount = 0;

            App.data.draftInvoice.items.forEach(item => {
                const itemTotalBeforeDiscount = item.quantity * item.unitPrice;
                const discountAmount = itemTotalBeforeDiscount * (item.discount / 100);
                const itemTotal = itemTotalBeforeDiscount - discountAmount;

                item.total = itemTotal.toFixed(2); // Store item total
                subTotal += itemTotalBeforeDiscount;
                totalDiscount += discountAmount;
            });

            App.data.draftInvoice.subTotal = subTotal.toFixed(2);
            App.data.draftInvoice.totalDiscount = totalDiscount.toFixed(2);
            App.data.draftInvoice.grandTotal = (subTotal - totalDiscount).toFixed(2);
        };
        
        // Handles adding a new item row to the draft invoice
        window.handleAddItem = () => {
            const selectElement = document.getElementById('product-select');
            const quantityElement = document.getElementById('item-quantity');
            const priceElement = document.getElementById('item-price');
            const discountElement = document.getElementById('item-discount');

            const productId = selectElement.value;
            const quantity = parseInt(quantityElement.value);
            const unitPrice = parseFloat(priceElement.value);
            const discount = parseFloat(discountElement.value) || 0;

            if (!productId || quantity <= 0 || unitPrice <= 0) {
                alertUser("يرجى اختيار صنف وإدخال كمية وسعر صالحين.", "error");
                return;
            }
            
            const productData = App.data.products.find(p => p.id === productId);
            if (!productData) return;

            // Check stock
            if (productData.stock < quantity) {
                 alertUser(`المخزون المتوفر من **${productData.name}** هو ${productData.stock} فقط.`, "error");
                 return;
            }
            
            // Prevent duplicate product in the draft (or update quantity)
            const existingItemIndex = App.data.draftInvoice.items.findIndex(item => item.productId === productId);

            const newItem = {
                productId: productId,
                productName: productData.name,
                quantity: quantity,
                unitPrice: unitPrice,
                discount: discount,
                total: 0, // Will be calculated
            };

            if (existingItemIndex > -1) {
                // For simplicity, we just add the quantity to the existing one for now
                App.data.draftInvoice.items[existingItemIndex].quantity += quantity;
            } else {
                App.data.draftInvoice.items.push(newItem);
            }
            
            calculateInvoiceTotals();
            render(); 

            // Clear inputs and reset price to selected product's default
            quantityElement.value = 1;
            discountElement.value = 0;
            selectElement.value = "";
            priceElement.value = 0;
        };

        // Removes an item from the draft invoice
        window.handleRemoveItem = (index) => {
            App.data.draftInvoice.items.splice(index, 1);
            calculateInvoiceTotals();
            render();
        };

        // Function to find customer by name or create a new one
        async function findOrCreateCustomer(customerName) {
            const existingCustomer = App.data.customers.find(c => c.name === customerName);
            if (existingCustomer) {
                return existingCustomer.id;
            }

            // Create new customer
            const newCustomerRef = doc(collection(App.db, App.getCollectionPath('customers')));
            await setDoc(newCustomerRef, {
                name: customerName,
                phone: '', 
                email: '',
                totalSpent: 0,
                points: 0,
                totalInvoices: 0,
                discountLevel: 'عادي',
                customerDiscount: 0,
                isDistinguished: false,
                createdAt: new Date().toISOString(),
            });
            return newCustomerRef.id;
        }

        // Function to update stock quantities using a batch write
        async function updateProductStockBatch(items, batch) {
            for (const item of items) {
                const product = App.data.products.find(p => p.id === item.productId);
                if (product && product.stock >= item.quantity) {
                    const productRef = doc(App.db, App.getCollectionPath('products'), item.productId);
                    const newStock = product.stock - item.quantity;
                    batch.update(productRef, { stock: newStock });
                } else {
                    // This error will rollback the entire batch
                    throw new Error(`Quantity requested for product ${item.productName} is more than available stock (${product ? product.stock : 'N/A'}).`);
                }
            }
        }

        // Main function to process and save the new invoice
        window.handleNewInvoice = async (e) => {
            e.preventDefault();
            const form = document.getElementById('new-invoice-form');
            const customerName = form.querySelector('#customer-name').value.trim();
            const invoiceItems = App.data.draftInvoice.items;
            const totalAmount = parseFloat(App.data.draftInvoice.grandTotal);
            const notes = form.querySelector('#invoice-notes').value.trim();

            if (!customerName) {
                alertUser("يرجى إدخال اسم العميل.", "error");
                return;
            }
            if (invoiceItems.length === 0) {
                alertUser("يجب إضافة صنف واحد على الأقل للفاتورة.", "error");
                return;
            }

            const saveBtn = document.getElementById('save-invoice-btn');
            saveBtn.disabled = true;
            saveBtn.innerHTML = `<i data-lucide="loader-circle" class="w-5 h-5 ml-2 inline animate-spin"></i> جاري الحفظ...`;
            lucide.createIcons();

            try {
                // 1. Find or create the customer
                const customerId = await findOrCreateCustomer(customerName);

                // 2. Prepare Firestore Batch
                const batch = writeBatch(App.db);
                await updateProductStockBatch(invoiceItems, batch); // Decrement stock

                // 3. Save Invoice
                const invoiceRef = doc(collection(App.db, App.getCollectionPath('invoices')));
                const newInvoiceData = {
                    invoiceNumber: App.data.invoices.length + 1, // Simple sequential number (for display)
                    customerId: customerId,
                    customerName: customerName,
                    items: invoiceItems.map(item => ({
                        name: item.productName,
                        quantity: item.quantity,
                        unitPrice: item.unitPrice,
                        discount: item.discount,
                        total: item.total
                    })),
                    subTotal: App.data.draftInvoice.subTotal,
                    totalDiscount: App.data.draftInvoice.totalDiscount,
                    grandTotal: totalAmount,
                    notes: notes,
                    date: new Date().toISOString(),
                    createdBy: App.userId,
                };

                batch.set(invoiceRef, newInvoiceData);

                // 4. Commit Batch (updates stock and saves invoice)
                await batch.commit();

                // 5. Update customer points and discount level
                await updateCustomerPoints(customerId, totalAmount);

                alertUser(`تم إنشاء الفاتورة رقم ${newInvoiceData.invoiceNumber} بنجاح وتحديث المخزون ونقاط العميل.`, "success");
                
                // Navigate to the print view and clear draft
                App.currentInvoiceForView = { id: invoiceRef.id, ...newInvoiceData };
                App.data.draftInvoice = { items: [], subTotal: 0, totalDiscount: 0, grandTotal: 0 }; 
                App.view = 'invoice_details';
                render();

            } catch (error) {
                console.error("Invoice creation failed:", error);
                alertUser(`فشل إنشاء الفاتورة: ${error.message}`, "error");
            } finally {
                saveBtn.disabled = false;
                saveBtn.innerHTML = `<i data-lucide="save" class="w-5 h-5 ml-2 inline"></i> حفظ وإصدار الفاتورة`;
                lucide.createIcons();
            }
        };

        // Function to trigger printing (PDF download via browser)
        window.generateInvoicePDF = () => {
            // Hide unnecessary elements before printing/PDF generation
            const sidebar = document.getElementById('sidebar');
            const header = document.getElementById('header-bar');
            const assistant = document.getElementById('smart-assistant-container');
            
            if (sidebar) sidebar.style.display = 'none';
            if (header) header.style.display = 'none';
            if (assistant) assistant.style.display = 'none';
            
            // Use the browser's print function to generate a PDF or print directly
            window.print();
            
            // Restore the layout after printing is done (or immediately if print dialog is modal)
            setTimeout(() => {
                if (sidebar) sidebar.style.display = 'block';
                if (header) header.style.display = 'flex';
                if (assistant) assistant.style.display = 'none'; 
                // Return to the main invoices view after print attempt
                navigateTo('invoices');
            }, 500); 
        };
        
        window.onProductSelectChange = () => {
             const selectElement = document.getElementById('product-select');
             const priceElement = document.getElementById('item-price');
             const productId = selectElement.value;
             const productData = App.data.products.find(p => p.id === productId);

             if (productData) {
                 priceElement.value = productData.price;
                 document.getElementById('item-quantity').focus();
             } else {
                 priceElement.value = 0;
             }
        }

        
        // ====================================================================
        //                      Utility Unit (UI & Utils)
        // ====================================================================

        function alertUser(message, type) {
            // Custom message box instead of alert()
            const alertBox = document.getElementById('global-alert');
            alertBox.innerText = message;
            alertBox.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-xl text-white transition-all duration-300 transform ${type === 'success' ? 'bg-green-600' : 'bg-red-600'} translate-y-0 opacity-100`;
            setTimeout(() => {
                alertBox.className += ' -translate-y-20 opacity-0';
            }, 5000);
        }
        
        window.navigateTo = (viewName, data = null) => {
            App.view = viewName;
            if (viewName === 'invoice_details') {
                // If navigating to an existing invoice detail view
                 App.currentInvoiceForView = data;
            } else if (viewName === 'new_invoice') {
                // Initialize draft for new invoice
                App.data.draftInvoice = { items: [], subTotal: 0, totalDiscount: 0, grandTotal: 0 };
            }
            render();
        };

        /** Data Backup and Download **/ 
        window.backupData = async () => {
            const collectionsToBackup = ['products', 'customers', 'invoices', 'users', 'alerts', 'warehouses', 'displayedProducts'];
            const backup = {};
            document.getElementById('backup-btn').innerText = 'جارٍ التجهيز...';
            try {
                for (const colName of collectionsToBackup) {
                    const colPath = App.getCollectionPath(colName);
                    const q = query(collection(App.db, colPath));
                    const snapshot = await getDocs(q);
                    backup[colName] = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                }
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(backup, null, 2));
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", `SHAHRAZAD_backup_${new Date().toISOString().slice(0, 10)}.json`);
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
                alertUser("تم إنشاء النسخة الاحتياطية بنجاح وتنزيل الملف.", "success");
            } catch (error) {
                console.error("Backup failed:", error);
                alertUser(`فشل النسخ الاحتياطي: ${error.message}`, "error");
            } finally {
                document.getElementById('backup-btn').innerText = 'تنزيل نسخة احتياطية';
            }
        };

        // ====================================================================
        //                      View Rendering Unit (HTML Templates)
        // ====================================================================
        
        /** General Layout **/
        const MainLayout = () => `
            <div class="flex h-screen bg-gray-100">
                ${Sidebar()}
                <div class="flex-1 flex flex-col overflow-hidden">
                    ${HeaderBar()}
                    <main class="flex-1 overflow-x-hidden overflow-y-auto p-4 md:p-6">
                        ${App.views[App.view]()}
                    </main>
                    ${SmartAssistantContainer()}
                </div>
            </div>
        `;

        const Sidebar = () => `
            <div id="sidebar" class="w-64 bg-shahrazad text-white space-y-6 py-7 px-2 absolute inset-y-0 right-0 transform translate-x-full md:relative md:translate-x-0 transition duration-200 ease-in-out z-30 shadow-2xl">
                <div class="flex items-center px-4">
                    <i data-lucide="battery-charging" class="w-8 h-8 text-yellow-400"></i>
                    <span class="text-2xl font-black mr-2 tracking-wider">SHAHRAZAD</span>
                </div>
                
                <nav>
                    ${SidebarLink('dashboard', 'الرئيسية', 'home')}
                    ${SidebarLink('products', 'إدارة الأصناف والمخزون', 'box')}
                    ${SidebarLink('displayed_products', 'البضاعة المعروضة حالياً', 'shopping-bag')}
                    ${SidebarLink('invoices', 'إدارة الفواتير', 'receipt')}
                    ${SidebarLink('customers', 'إدارة العملاء', 'users')}
                    ${SidebarLink('alerts', 'تنبيهات المخزون', 'alert-triangle')}
                    <div class="pt-4 border-t border-white border-opacity-20 mt-4"></div>
                    ${SidebarLink('user_settings', 'إدارة المستخدمين', 'lock', App.userRole === 'admin' ? '' : 'hidden')}
                    ${SidebarLink('general_settings', 'إعدادات عامة', 'settings')}
                </nav>

                <div class="absolute bottom-4 w-full px-4">
                    <button onclick="handleLogout()" class="w-full flex items-center p-3 text-red-100 hover:bg-red-700 rounded-lg transition duration-200">
                        <i data-lucide="log-out" class="w-5 h-5 ml-3"></i>
                        تسجيل الخروج
                    </button>
                </div>
            </div>
        `;
        
        const SidebarLink = (viewName, title, icon, classes = '') => `
            <button onclick="navigateTo('${viewName}')" class="w-full flex items-center p-3 text-white hover:bg-white hover:bg-opacity-10 rounded-lg transition duration-200 ${App.view === viewName ? 'bg-white bg-opacity-20 shadow-md' : ''} ${classes}">
                <i data-lucide="${icon}" class="w-5 h-5 ml-3"></i>
                <span>${title}</span>
            </button>
        `;

        const HeaderBar = () => `
            <header id="header-bar" class="flex items-center justify-between px-6 py-4 bg-white border-b border-gray-200 shadow-sm">
                <h1 class="text-xl font-semibold text-gray-800">${getPageViewTitle()}</h1>
                <div class="flex items-center">
                    <button onclick="toggleAssistant()" class="p-2 ml-3 text-gray-500 hover:text-shahrazad transition duration-150">
                        <i data-lucide="sparkles" class="w-6 h-6"></i>
                    </button>
                    <span class="text-sm font-medium text-shahrazad ml-3">${App.data.users.find(u => u.uid === App.userId)?.name || App.userRole}</span>
                    <i data-lucide="circle-user" class="w-7 h-7 text-gray-500"></i>
                </div>
            </header>
        `;

        const SmartAssistantContainer = () => `
            <div id="smart-assistant-container" class="hidden fixed bottom-4 right-4 w-80 h-auto bg-white rounded-xl shadow-2xl z-40 flex-col transition duration-300">
                <div class="p-3 bg-shahrazad text-white rounded-t-xl flex justify-between items-center">
                    <span class="font-bold">المساعد الذكي (AI)</span>
                    <button onclick="toggleAssistant()" class="p-1 hover:bg-white hover:bg-opacity-20 rounded-full">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
                <div id="chat-body" class="p-3 space-y-2 flex-grow">
                    <div class="flex justify-end mb-2">
                        <div class="max-w-xs p-3 rounded-xl chat-message-ai shadow-md">
                           ${myAssistant.generateGreeting(App.data.users.find(u => u.uid === App.userId)?.name)}
                        </div>
                    </div>
                </div>
                <div class="p-3 border-t">
                    <div class="flex items-center">
                        <input type="text" id="chat-input" placeholder="اكتب استفسارك..." class="flex-grow p-2 border border-gray-300 rounded-lg focus:ring-shahrazad focus:border-shahrazad text-sm" onkeydown="if(event.key === 'Enter') sendAssistantQuery()">
                        <button onclick="sendAssistantQuery()" class="mr-2 p-2 bg-shahrazad text-white rounded-lg hover:bg-blue-700 transition duration-150">
                            <i data-lucide="send" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        function getPageViewTitle() {
            const titles = {
                'loading': 'جاري التحميل...',
                'login': 'تسجيل الدخول',
                'dashboard': 'لوحة التحكم الرئيسية',
                'products': 'إدارة الأصناف والمخزون',
                'displayed_products': 'البضاعة المعروضة حالياً',
                'invoices': 'إدارة الفواتير',
                'new_invoice': 'إنشاء فاتورة مبيعات جديدة',
                'invoice_details': 'معاينة الفاتورة',
                'customers': 'إدارة العملاء',
                'alerts': 'تنبيهات نقص المخزون',
                'general_settings': 'إعدادات عامة',
                'user_settings': 'إدارة المستخدمين',
                'auth_error': 'خطأ في المصادقة',
            };
            return titles[App.view] || 'نظام SHAHRAZAD ELECTRIC';
        }

        /** View Implementations **/
        
        // --- 1. Loading View ---
        const LoadingView = () => `
            <div class="flex flex-col items-center justify-center h-full">
                <i data-lucide="loader-circle" class="w-12 h-12 text-shahrazad animate-spin"></i>
                <p class="mt-4 text-gray-600">جاري تحميل البيانات...</p>
            </div>
        `;
        
        // --- 2. Auth Error View ---
        const AuthErrorView = () => `
            <div class="flex flex-col items-center justify-center h-full bg-red-100 rounded-xl p-8 card">
                <i data-lucide="alert-octagon" class="w-12 h-12 text-red-600"></i>
                <h2 class="mt-4 text-2xl font-bold text-red-800">خطأ حرج في المصادقة</h2>
                <p class="mt-2 text-gray-700 text-center">حدث خطأ أثناء محاولة الاتصال بـ Firebase Auth. يرجى التأكد من إعدادات Firebase وتفعيل طريقة المصادقة المناسبة.</p>
                <button onclick="window.location.reload()" class="mt-6 bg-red-600 text-white p-3 rounded-lg hover:bg-red-700 transition duration-150">إعادة المحاولة</button>
            </div>
        `;

        // --- 3. Login View ---
        const LoginView = () => `
            <div class="flex items-center justify-center h-screen bg-gray-100">
                <div class="w-full max-w-md p-8 space-y-6 card">
                    <div class="flex flex-col items-center">
                        <i data-lucide="battery-charging" class="w-10 h-10 text-shahrazad"></i>
                        <h2 class="mt-3 text-3xl font-bold text-gray-900">نظام SHAHRAZAD ELECTRIC</h2>
                        <p class="mt-2 text-sm text-gray-500">الرجاء تسجيل الدخول للمتابعة</p>
                    </div>
                    <form class="space-y-6" onsubmit="handleLoginSubmit(event)">
                        <div>
                            <label for="login-email" class="block text-sm font-medium text-gray-700">البريد الإلكتروني</label>
                            <div class="mt-1">
                                <input id="login-email" name="email" type="email" autocomplete="email" required class="appearance-none block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-shahrazad focus:border-shahrazad sm:text-sm">
                            </div>
                        </div>
                        <div>
                            <label for="login-password" class="block text-sm font-medium text-gray-700">كلمة المرور</label>
                            <div class="mt-1">
                                <input id="login-password" name="password" type="password" autocomplete="current-password" required class="appearance-none block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-shahrazad focus:border-shahrazad sm:text-sm">
                            </div>
                        </div>
                        <div>
                            <button id="login-btn" type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-shahrazad hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-shahrazad transition duration-150">
                                <i data-lucide="log-in" class="w-5 h-5 ml-2 inline"></i>
                                تسجيل الدخول
                            </button>
                        </div>
                    </form>
                    <div class="text-center text-xs text-gray-400 pt-4 border-t">
                        للتجربة: البريد: test | كلمة المرور: test
                    </div>
                </div>
            </div>
        `;

        // --- 4. Dashboard View ---
        const DashboardView = () => {
            const totalProducts = App.data.products.length;
            const totalInvoices = App.data.invoices.length;
            const totalCustomers = App.data.customers.length;
            const lowStockCount = App.data.products.filter(p => p.stock <= (p.lowStockThreshold || 10)).length;
            
            // Calculate Daily, Monthly, Yearly Revenue
            const now = new Date();
            const today = now.toISOString().slice(0, 10);
            const thisMonth = now.toISOString().slice(0, 7);
            const thisYear = now.getFullYear();

            const dailyRevenue = App.data.invoices
                .filter(inv => inv.date && inv.date.startsWith(today))
                .reduce((sum, inv) => sum + parseFloat(inv.grandTotal || 0), 0);

            const monthlyRevenue = App.data.invoices
                .filter(inv => inv.date && inv.date.startsWith(thisMonth))
                .reduce((sum, inv) => sum + parseFloat(inv.grandTotal || 0), 0);
                
            const yearlyRevenue = App.data.invoices
                .filter(inv => inv.date && inv.date.startsWith(thisYear.toString()))
                .reduce((sum, inv) => sum + parseFloat(inv.grandTotal || 0), 0);

            // Chart data preparation (Last 7 days revenue)
            const last7DaysData = prepareLast7DaysRevenue(App.data.invoices);
            
            // Top 5 Products
            const productSales = {};
            App.data.invoices.forEach(inv => {
                (inv.items || []).forEach(item => {
                    const productName = item.name;
                    const quantity = item.quantity;
                    productSales[productName] = (productSales[productName] || 0) + quantity;
                });
            });

            const topProducts = Object.entries(productSales)
                .sort(([, a], [, b]) => b - a)
                .slice(0, 5);

            // Render the chart only once in the final HTML
            setTimeout(() => {
                renderDashboardChart('sales-chart', last7DaysData);
            }, 100);

            return `
                <h2 class="text-2xl font-bold text-gray-800 mb-6">مرحباً بك يا ${App.data.users.find(u => u.uid === App.userId)?.name || App.userRole}!</h2>

                ${renderKPIS(totalProducts, totalInvoices, totalCustomers, lowStockCount)}

                <h3 class="text-xl font-semibold text-gray-700 mt-8 mb-4">تقارير الإيرادات</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    ${renderRevenueCard('إيرادات اليوم', dailyRevenue)}
                    ${renderRevenueCard('إيرادات الشهر', monthlyRevenue)}
                    ${renderRevenueCard('إيرادات السنة', yearlyRevenue)}
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mt-8">
                    <div class="lg:col-span-2 card p-6">
                        <h3 class="text-xl font-semibold text-gray-700 mb-4 flex items-center">
                            <i data-lucide="line-chart" class="w-6 h-6 ml-2 text-shahrazad"></i> 
                            إجمالي الإيرادات (آخر 7 أيام)
                        </h3>
                        <div class="h-80">
                            <canvas id="sales-chart"></canvas>
                        </div>
                    </div>

                    <div class="card p-6">
                        <h3 class="text-xl font-semibold text-red-700 mb-4 flex items-center">
                            <i data-lucide="alert-triangle" class="w-6 h-6 ml-2"></i> 
                            تنبيهات نقص المخزون
                        </h3>
                        <div id="alerts-container">
                            </div>
                        <button onclick="navigateTo('alerts')" class="w-full mt-4 text-center text-sm text-shahrazad hover:text-blue-700 transition duration-150">عرض كل التنبيهات</button>
                    </div>
                </div>

                <div class="card p-6 mt-6">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4 flex items-center">
                        <i data-lucide="shopping-bag" class="w-6 h-6 ml-2 text-green-600"></i> 
                        أكثر الأصناف مبيعاً (كمية)
                    </h3>
                    ${topProducts.length > 0 ? `
                    <table class="min-w-full divide-y divide-gray-200">
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${topProducts.map(([name, quantity], index) => `
                                <tr>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${index + 1}. ${name}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${quantity} وحدة</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    ` : `<p class="text-gray-500 text-center py-4">لا توجد بيانات مبيعات لعرضها.</p>`}
                </div>
            `;
        };
        
        // Helper functions for Dashboard
        function renderKPIS(totalProducts, totalInvoices, totalCustomers, lowStockCount) {
            return `
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    ${renderKPICard('إجمالي الأصناف', totalProducts, 'box', 'bg-shahrazad')}
                    ${renderKPICard('إجمالي الفواتير', totalInvoices, 'receipt', 'bg-green-500')}
                    ${renderKPICard('إجمالي العملاء', totalCustomers, 'users', 'bg-purple-500')}
                    ${renderKPICard('أصناف منخفضة', lowStockCount, 'alert-triangle', 'bg-red-500')}
                </div>
            `;
        }

        function renderKPICard(title, value, icon, bgColor) {
            return `
                <div class="card p-5 flex items-center ${bgColor} text-white shadow-lg">
                    <div class="p-3 rounded-full bg-white bg-opacity-20 ml-4">
                        <i data-lucide="${icon}" class="w-6 h-6"></i>
                    </div>
                    <div>
                        <p class="text-sm opacity-80">${title}</p>
                        <p class="text-3xl font-bold">${value}</p>
                    </div>
                </div>
            `;
        }

        function renderRevenueCard(title, revenue) {
             const bgColor = title.includes('اليوم') ? 'bg-indigo-500' : title.includes('الشهر') ? 'bg-teal-500' : 'bg-orange-500';
             return `
                 <div class="card p-5 flex items-center ${bgColor} text-white shadow-lg">
                     <div class="p-3 rounded-full bg-white bg-opacity-20 ml-4">
                         <i data-lucide="wallet" class="w-6 h-6"></i>
                     </div>
                     <div>
                         <p class="text-sm opacity-80">${title}</p>
                         <p class="text-3xl font-bold">${(revenue || 0).toLocaleString('ar-EG', { minimumFractionDigits: 2 })} SDG</p>
                     </div>
                 </div>
             `;
         }
        
        function prepareLast7DaysRevenue(invoices) {
            const days = [];
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                days.push({
                    date: date.toISOString().slice(0, 10),
                    label: date.toLocaleDateString('ar-EG', { weekday: 'short' }),
                    revenue: 0
                });
            }

            invoices.forEach(inv => {
                const invDate = inv.date ? inv.date.slice(0, 10) : null;
                const dayEntry = days.find(d => d.date === invDate);
                if (dayEntry) {
                    dayEntry.revenue += parseFloat(inv.grandTotal || 0);
                }
            });

            return {
                labels: days.map(d => d.label),
                data: days.map(d => d.revenue)
            };
        }

        let salesChartInstance = null;
        function renderDashboardChart(canvasId, data) {
            const ctx = document.getElementById(canvasId);
            if (!ctx) return;

            if (salesChartInstance) {
                salesChartInstance.destroy();
            }

            salesChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: 'الإيرادات (SDG)',
                        data: data.data,
                        borderColor: '#004d99',
                        backgroundColor: 'rgba(0, 77, 153, 0.1)',
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    rtl: true,
                    scales: {
                        x: {
                            reverse: true,
                            grid: { display: false }
                        },
                        y: {
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }
        
        // --- 5. Products View ---
        const ProductsView = () => `
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">إدارة الأصناف والمخزون (${App.data.products.length} صنف)</h2>
                <button onclick="window.showProductModal()" class="bg-shahrazad text-white p-3 rounded-lg flex items-center hover:bg-blue-700 transition duration-150">
                    <i data-lucide="plus" class="w-5 h-5 ml-2"></i>
                    إضافة صنف جديد
                </button>
            </div>
            
            <div class="card p-6">
                 ${renderProductList(App.data.products)}
            </div>
            
            ${renderProductModal()}
        `;
        
        // Product Modal (Simplified - requires full implementation in a real scenario)
        const renderProductModal = () => `
            <div id="product-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 justify-center items-center" onclick="if(event.target.id === 'product-modal') window.hideProductModal()">
                <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-lg mx-auto" onclick="event.stopPropagation()">
                    <h3 class="text-xl font-bold mb-4">إضافة / تعديل صنف</h3>
                    <form id="product-form" onsubmit="window.handleProductSubmit(event)">
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="product-name">اسم الصنف</label>
                            <input type="text" id="product-name" required class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="mb-4">
                                <label class="block text-gray-700 text-sm font-bold mb-2" for="product-price">سعر الوحدة (SDG)</label>
                                <input type="number" id="product-price" step="0.01" required class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                            </div>
                            <div class="mb-4">
                                <label class="block text-gray-700 text-sm font-bold mb-2" for="product-stock">الكمية في المخزون</label>
                                <input type="number" id="product-stock" required class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                             <div class="mb-4">
                                <label class="block text-gray-700 text-sm font-bold mb-2" for="product-warehouse">المخزن</label>
                                <select id="product-warehouse" required class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                                    ${App.data.warehouses.map(w => `<option value="${w.name}">${w.name}</option>`).join('') || '<option value="">لا توجد مخازن</option>'}
                                </select>
                            </div>
                            <div class="mb-4">
                                <label class="block text-gray-700 text-sm font-bold mb-2" for="product-threshold">حد التنبيه (Stock)</label>
                                <input type="number" id="product-threshold" value="10" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                            </div>
                        </div>
                        
                        <div class="flex justify-end mt-6">
                            <button type="button" onclick="window.hideProductModal()" class="bg-gray-300 text-gray-800 p-2 rounded-lg ml-4 hover:bg-gray-400">إلغاء</button>
                            <button type="submit" id="product-submit-btn" class="bg-shahrazad text-white p-2 rounded-lg flex items-center hover:bg-blue-700 transition duration-150">
                                <i data-lucide="save" class="w-5 h-5 ml-2"></i>
                                حفظ الصنف
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        `;
        
        // Helper to render product table
        const renderProductList = (products) => {
            if (products.length === 0) {
                return `<p class="text-gray-500 text-center py-4">لا توجد أصناف مسجلة حالياً.</p>`;
            }
            return `
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">الاسم</th>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">السعر (SDG)</th>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">المخزون</th>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">المخزن</th>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${products.map(p => `
                                <tr class="${p.stock <= (p.lowStockThreshold || 10) ? 'bg-red-50' : ''}">
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${p.name}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${p.price.toLocaleString('ar-EG', { minimumFractionDigits: 2 })}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm ${p.stock <= (p.lowStockThreshold || 10) ? 'text-red-600 font-bold' : 'text-gray-500'}">${p.stock} ${p.stock <= (p.lowStockThreshold || 10) ? '(منخفض!)' : ''}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${p.warehouse || 'الرئيسي'}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                        <button onclick="window.editProduct('${p.id}')" class="text-shahrazad hover:text-blue-700 ml-3">
                                            <i data-lucide="square-pen" class="w-5 h-5"></i>
                                        </button>
                                        <button onclick="window.deleteProduct('${p.id}', '${p.name}')" class="text-red-600 hover:text-red-900 ${App.userRole !== 'admin' ? 'hidden' : ''}">
                                            <i data-lucide="trash-2" class="w-5 h-5"></i>
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        };
        
        // Product CRUD Logic (Simplified for demonstration)
        window.showProductModal = (product = {}) => {
            const modal = document.getElementById('product-modal');
            const form = document.getElementById('product-form');
            form.reset();
            form.dataset.productId = product.id || '';
            document.getElementById('product-name').value = product.name || '';
            document.getElementById('product-price').value = product.price || 0;
            document.getElementById('product-stock').value = product.stock || 0;
            document.getElementById('product-threshold').value = product.lowStockThreshold || 10;
            if (product.warehouse) document.getElementById('product-warehouse').value = product.warehouse;
            
            document.getElementById('product-submit-btn').innerHTML = product.id ? `<i data-lucide="save" class="w-5 h-5 ml-2"></i> حفظ التعديل` : `<i data-lucide="plus" class="w-5 h-5 ml-2"></i> إضافة الصنف`;
            lucide.createIcons();
            modal.style.display = 'flex';
        };

        window.hideProductModal = () => {
            document.getElementById('product-modal').style.display = 'none';
        };

        window.editProduct = (id) => {
            const product = App.data.products.find(p => p.id === id);
            if (product) window.showProductModal(product);
        };
        
        window.handleProductSubmit = async (e) => {
            e.preventDefault();
            const form = e.target;
            const productId = form.dataset.productId;
            const isNew = !productId;
            const name = form.querySelector('#product-name').value;
            const price = parseFloat(form.querySelector('#product-price').value);
            const stock = parseInt(form.querySelector('#product-stock').value);
            const warehouse = form.querySelector('#product-warehouse').value;
            const lowStockThreshold = parseInt(form.querySelector('#product-threshold').value);

            const productData = { name, price, stock, warehouse, lowStockThreshold };
            
            const submitBtn = form.querySelector('#product-submit-btn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = `<i data-lucide="loader-circle" class="w-5 h-5 ml-2 inline animate-spin"></i> جاري الحفظ...`;
            lucide.createIcons();

            try {
                if (isNew) {
                    await addDoc(collection(App.db, App.getCollectionPath('products')), { ...productData, createdAt: new Date().toISOString() });
                    alertUser(`تم إضافة الصنف **${name}** بنجاح.`, "success");
                } else {
                    await updateDoc(doc(App.db, App.getCollectionPath('products'), productId), productData);
                    alertUser(`تم تعديل الصنف **${name}** بنجاح.`, "success");
                }
                window.hideProductModal();
            } catch (error) {
                console.error("Product save failed:", error);
                alertUser(`فشل حفظ الصنف: ${error.message}`, "error");
            } finally {
                submitBtn.disabled = false;
                // Re-rendering happens automatically via onSnapshot listener
            }
        };

        window.deleteProduct = async (id, name) => {
            if (App.userRole !== 'admin') {
                alertUser("عذراً، يجب أن تكون بـ **صلاحية المدير الأساسي** للحذف.", "error");
                return;
            }
            if (!confirm(`هل أنت متأكد من حذف الصنف: ${name}؟ لا يمكن التراجع عن هذا الإجراء!`)) return;

            try {
                await deleteDoc(doc(App.db, App.getCollectionPath('products'), id));
                alertUser(`تم حذف الصنف **${name}** بنجاح.`, "success");
            } catch (error) {
                console.error("Product deletion failed:", error);
                alertUser(`فشل حذف الصنف: ${error.message}`, "error");
            }
        };

        // --- 6. Displayed Products View ---
        const DisplayedProductsView = () => {
            return `
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">إدارة البضاعة المعروضة حالياً (${App.data.displayedProducts.length} صنف)</h2>
                    <div class="flex space-x-3">
                        <button onclick="window.showAddFromWarehouseModal()" class="bg-green-600 text-white p-3 rounded-lg flex items-center hover:bg-green-700 transition duration-150">
                            <i data-lucide="package-plus" class="w-5 h-5 ml-2"></i>
                            إضافة من المخزن
                        </button>
                        <button onclick="window.showAddNewDisplayedModal()" class="bg-shahrazad text-white p-3 rounded-lg flex items-center hover:bg-blue-700 transition duration-150">
                            <i data-lucide="plus" class="w-5 h-5 ml-2"></i>
                            إضافة صنف جديد
                        </button>
                    </div>
                </div>
                
                <div class="card p-6">
                    ${renderDisplayedProductsList(App.data.displayedProducts)}
                </div>
                
                ${renderAddFromWarehouseModal()}
                ${renderAddNewDisplayedModal()}
            `;
        };

        // Helper to render displayed products table
        const renderDisplayedProductsList = (displayedProducts) => {
            if (displayedProducts.length === 0) {
                return `<p class="text-gray-500 text-center py-4">لا توجد بضاعة معروضة حالياً.</p>`;
            }
            return `
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">الاسم</th>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">السعر (SDG)</th>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">الكمية المعروضة</th>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">المخزن المصدر</th>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${displayedProducts.map(p => `
                                <tr>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${p.name}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${p.price.toLocaleString('ar-EG', { minimumFractionDigits: 2 })}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${p.displayedQuantity}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${p.sourceWarehouse || 'مباشر'}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                        <button onclick="window.editDisplayedProduct('${p.id}')" class="text-shahrazad hover:text-blue-700 ml-3">
                                            <i data-lucide="square-pen" class="w-5 h-5"></i>
                                        </button>
                                        <button onclick="window.returnToWarehouse('${p.id}', '${p.name}')" class="text-orange-600 hover:text-orange-900 ml-3">
                                            <i data-lucide="rotate-ccw" class="w-5 h-5"></i>
                                        </button>
                                        <button onclick="window.deleteDisplayedProduct('${p.id}', '${p.name}')" class="text-red-600 hover:text-red-900 ${App.userRole !== 'admin' ? 'hidden' : ''}">
                                            <i data-lucide="trash-2" class="w-5 h-5"></i>
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        };

        // Modal for adding products from warehouse
        const renderAddFromWarehouseModal = () => `
            <div id="add-from-warehouse-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 justify-center items-center" onclick="if(event.target.id === 'add-from-warehouse-modal') window.hideAddFromWarehouseModal()">
                <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-lg mx-auto" onclick="event.stopPropagation()">
                    <h3 class="text-xl font-bold mb-4">إضافة بضاعة من المخزن</h3>
                    <form id="add-from-warehouse-form" onsubmit="window.handleAddFromWarehouse(event)">
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="warehouse-product-select">اختر الصنف من المخزن</label>
                            <select id="warehouse-product-select" required class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                                <option value="">اختر صنف...</option>
                                ${App.data.products.map(p => `<option value="${p.id}" data-stock="${p.stock}" data-price="${p.price}" data-warehouse="${p.warehouse}">${p.name} (مخزون: ${p.stock})</option>`).join('')}
                            </select>
                        </div>
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="displayed-quantity">الكمية المراد عرضها</label>
                            <input type="number" id="displayed-quantity" min="1" required class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        </div>
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="displayed-price">سعر العرض (SDG)</label>
                            <input type="number" id="displayed-price" step="0.01" required class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        </div>
                        
                        <div class="flex justify-end mt-6">
                            <button type="button" onclick="window.hideAddFromWarehouseModal()" class="bg-gray-300 text-gray-800 p-2 rounded-lg ml-4 hover:bg-gray-400">إلغاء</button>
                            <button type="submit" id="add-from-warehouse-btn" class="bg-shahrazad text-white p-2 rounded-lg flex items-center hover:bg-blue-700 transition duration-150">
                                <i data-lucide="package-plus" class="w-5 h-5 ml-2"></i>
                                إضافة للعرض
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        `;

        // Modal for adding new displayed product
        const renderAddNewDisplayedModal = () => `
            <div id="add-new-displayed-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 justify-center items-center" onclick="if(event.target.id === 'add-new-displayed-modal') window.hideAddNewDisplayedModal()">
                <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-lg mx-auto" onclick="event.stopPropagation()">
                    <h3 class="text-xl font-bold mb-4">إضافة صنف جديد للعرض</h3>
                    <form id="add-new-displayed-form" onsubmit="window.handleAddNewDisplayed(event)">
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="new-displayed-name">اسم الصنف</label>
                            <input type="text" id="new-displayed-name" required class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        </div>
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="new-displayed-quantity">الكمية</label>
                            <input type="number" id="new-displayed-quantity" min="1" required class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        </div>
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="new-displayed-price">سعر الوحدة (SDG)</label>
                            <input type="number" id="new-displayed-price" step="0.01" required class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        </div>
                        
                        <div class="flex justify-end mt-6">
                            <button type="button" onclick="window.hideAddNewDisplayedModal()" class="bg-gray-300 text-gray-800 p-2 rounded-lg ml-4 hover:bg-gray-400">إلغاء</button>
                            <button type="submit" id="add-new-displayed-btn" class="bg-shahrazad text-white p-2 rounded-lg flex items-center hover:bg-blue-700 transition duration-150">
                                <i data-lucide="plus" class="w-5 h-5 ml-2"></i>
                                إضافة للعرض
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        `;

        // Displayed Products CRUD Logic
        window.showAddFromWarehouseModal = () => {
            const modal = document.getElementById('add-from-warehouse-modal');
            const form = document.getElementById('add-from-warehouse-form');
            form.reset();
            modal.style.display = 'flex';
        };

        window.hideAddFromWarehouseModal = () => {
            document.getElementById('add-from-warehouse-modal').style.display = 'none';
        };

        window.showAddNewDisplayedModal = () => {
            const modal = document.getElementById('add-new-displayed-modal');
            const form = document.getElementById('add-new-displayed-form');
            form.reset();
            modal.style.display = 'flex';
        };

        window.hideAddNewDisplayedModal = () => {
            document.getElementById('add-new-displayed-modal').style.display = 'none';
        };

        // Handle adding product from warehouse to displayed
        window.handleAddFromWarehouse = async (e) => {
            e.preventDefault();
            const form = e.target;
            const productId = form.querySelector('#warehouse-product-select').value;
            const displayedQuantity = parseInt(form.querySelector('#displayed-quantity').value);
            const displayedPrice = parseFloat(form.querySelector('#displayed-price').value);

            const product = App.data.products.find(p => p.id === productId);
            if (!product) {
                alertUser("لم يتم العثور على الصنف المحدد.", "error");
                return;
            }

            if (displayedQuantity > product.stock) {
                alertUser(`الكمية المطلوبة (${displayedQuantity}) أكبر من المخزون المتوفر (${product.stock}).`, "error");
                return;
            }

            const submitBtn = form.querySelector('#add-from-warehouse-btn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = `<i data-lucide="loader-circle" class="w-5 h-5 ml-2 inline animate-spin"></i> جاري الإضافة...`;
            lucide.createIcons();

            try {
                // Use batch to update both collections atomically
                const batch = writeBatch(App.db);
                
                // Add to displayed products
                const displayedRef = doc(collection(App.db, App.getCollectionPath('displayedProducts')));
                batch.set(displayedRef, {
                    name: product.name,
                    price: displayedPrice,
                    displayedQuantity: displayedQuantity,
                    sourceWarehouse: product.warehouse,
                    sourceProductId: productId,
                    createdAt: new Date().toISOString(),
                });
                
                // Update warehouse stock
                const productRef = doc(App.db, App.getCollectionPath('products'), productId);
                const newStock = product.stock - displayedQuantity;
                batch.update(productRef, { stock: newStock });
                
                await batch.commit();
                
                alertUser(`تم إضافة ${displayedQuantity} من ${product.name} إلى البضاعة المعروضة بنجاح.`, "success");
                window.hideAddFromWarehouseModal();
            } catch (error) {
                console.error("Failed to add product from warehouse:", error);
                alertUser(`فشل إضافة الصنف: ${error.message}`, "error");
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = `<i data-lucide="package-plus" class="w-5 h-5 ml-2"></i> إضافة للعرض`;
                lucide.createIcons();
            }
        };

        // Handle adding new displayed product (not from warehouse)
        window.handleAddNewDisplayed = async (e) => {
            e.preventDefault();
            const form = e.target;
            const name = form.querySelector('#new-displayed-name').value;
            const displayedQuantity = parseInt(form.querySelector('#new-displayed-quantity').value);
            const displayedPrice = parseFloat(form.querySelector('#new-displayed-price').value);

            const submitBtn = form.querySelector('#add-new-displayed-btn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = `<i data-lucide="loader-circle" class="w-5 h-5 ml-2 inline animate-spin"></i> جاري الإضافة...`;
            lucide.createIcons();

            try {
                await addDoc(collection(App.db, App.getCollectionPath('displayedProducts')), {
                    name: name,
                    price: displayedPrice,
                    displayedQuantity: displayedQuantity,
                    sourceWarehouse: null, // Not from warehouse
                    sourceProductId: null,
                    createdAt: new Date().toISOString(),
                });
                
                alertUser(`تم إضافة ${displayedQuantity} من ${name} إلى البضاعة المعروضة بنجاح.`, "success");
                window.hideAddNewDisplayedModal();
            } catch (error) {
                console.error("Failed to add new displayed product:", error);
                alertUser(`فشل إضافة الصنف: ${error.message}`, "error");
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = `<i data-lucide="plus" class="w-5 h-5 ml-2"></i> إضافة للعرض`;
                lucide.createIcons();
            }
        };

        // Return displayed product to warehouse
        window.returnToWarehouse = async (id, name) => {
            const displayedProduct = App.data.displayedProducts.find(p => p.id === id);
            if (!displayedProduct) return;
            
            if (!displayedProduct.sourceProductId) {
                alertUser("لا يمكن إرجاع هذا الصنف إلى المخزن لأنه لم يأتي منه أصلاً.", "error");
                return;
            }

            if (!confirm(`هل تريد إرجاع ${displayedProduct.displayedQuantity} من ${name} إلى المخزن؟`)) return;

            try {
                const batch = writeBatch(App.db);
                
                // Remove from displayed products
                const displayedRef = doc(App.db, App.getCollectionPath('displayedProducts'), id);
                batch.delete(displayedRef);
                
                // Add back to warehouse stock
                const productRef = doc(App.db, App.getCollectionPath('products'), displayedProduct.sourceProductId);
                const product = App.data.products.find(p => p.id === displayedProduct.sourceProductId);
                if (product) {
                    const newStock = product.stock + displayedProduct.displayedQuantity;
                    batch.update(productRef, { stock: newStock });
                }
                
                await batch.commit();
                alertUser(`تم إرجاع ${displayedProduct.displayedQuantity} من ${name} إلى المخزن بنجاح.`, "success");
            } catch (error) {
                console.error("Failed to return product to warehouse:", error);
                alertUser(`فشل إرجاع الصنف: ${error.message}`, "error");
            }
        };

        // Delete displayed product
        window.deleteDisplayedProduct = async (id, name) => {
            if (App.userRole !== 'admin') {
                alertUser("عذراً، يجب أن تكون بـ **صلاحية المدير الأساسي** للحذف.", "error");
                return;
            }
            
            const displayedProduct = App.data.displayedProducts.find(p => p.id === id);
            if (!displayedProduct) return;
            
            if (!confirm(`هل أنت متأكد من حذف الصنف: ${name}؟ لا يمكن التراجع عن هذا الإجراء!`)) return;

            try {
                // If it came from warehouse, we need to return it first
                if (displayedProduct.sourceProductId) {
                    if (!confirm(`هذا الصنف أتى من المخزن. هل تريد إرجاع ${displayedProduct.displayedQuantity} وحدة إلى المخزن قبل الحذف؟`)) {
                        // User chose not to return to warehouse, just delete
                        await deleteDoc(doc(App.db, App.getCollectionPath('displayedProducts'), id));
                    } else {
                        // Return to warehouse then delete
                        const batch = writeBatch(App.db);
                        
                        // Add back to warehouse stock
                        const productRef = doc(App.db, App.getCollectionPath('products'), displayedProduct.sourceProductId);
                        const product = App.data.products.find(p => p.id === displayedProduct.sourceProductId);
                        if (product) {
                            const newStock = product.stock + displayedProduct.displayedQuantity;
                            batch.update(productRef, { stock: newStock });
                        }
                        
                        // Remove from displayed products
                        const displayedRef = doc(App.db, App.getCollectionPath('displayedProducts'), id);
                        batch.delete(displayedRef);
                        
                        await batch.commit();
                    }
                } else {
                    // Just delete if it's not from warehouse
                    await deleteDoc(doc(App.db, App.getCollectionPath('displayedProducts'), id));
                }
                
                alertUser(`تم حذف الصنف **${name}** من البضاعة المعروضة بنجاح.`, "success");
            } catch (error) {
                console.error("Displayed product deletion failed:", error);
                alertUser(`فشل حذف الصنف: ${error.message}`, "error");
            }
        };

        // Edit displayed product
        window.editDisplayedProduct = (id) => {
            const product = App.data.displayedProducts.find(p => p.id === id);
            if (product) {
                // Similar to showProductModal but for displayed products
                // Implementation depends on your specific needs
                alertUser("ميزة التعديل قيد التطوير.", "info");
            }
        };

        // --- 7. Invoices View ---
        const InvoicesView = () => {
            const invoices = App.data.invoices.sort((a, b) => new Date(b.date) - new Date(a.date));
            const totalRevenue = invoices.reduce((sum, inv) => sum + parseFloat(inv.grandTotal || 0), 0);
            
            return `
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">سجل الفواتير (${invoices.length} فاتورة)</h2>
                    <button onclick="navigateTo('new_invoice')" class="bg-green-600 text-white p-3 rounded-lg flex items-center hover:bg-green-700 transition duration-150">
                        <i data-lucide="plus-circle" class="w-5 h-5 ml-2"></i>
                        إنشاء فاتورة جديدة
                    </button>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    ${renderRevenueCard('إجمالي الإيرادات', totalRevenue).replace(/bg-[a-z]+-500/g, 'bg-shahrazad')}
                </div>
                
                <div class="card p-6">
                    ${renderInvoiceList(invoices)}
                </div>
            `;
        };
        
        // Helper to render invoice table
        const renderInvoiceList = (invoices) => {
            if (invoices.length === 0) {
                return `<p class="text-gray-500 text-center py-4">لا توجد فواتير مسجلة حالياً.</p>`;
            }
            return `
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">رقم الفاتورة</th>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">العميل</th>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">التاريخ</th>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">الإجمالي (SDG)</th>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${invoices.map(inv => `
                                <tr>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-shahrazad">${inv.invoiceNumber || 'N/A'}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${inv.customerName || 'عميل غير مسجل'}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${myAssistant.formatTimestamp(inv.date)}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-green-600">${parseFloat(inv.grandTotal || 0).toLocaleString('ar-EG', { minimumFractionDigits: 2 })}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                        <button onclick="navigateTo('invoice_details', ${JSON.stringify(inv).replace(/'/g, "\\'")})" class="text-shahrazad hover:text-blue-700 ml-3">
                                            <i data-lucide="eye" class="w-5 h-5"></i> معاينة
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        };

        // --- 8. New Invoice View (The main new feature) ---
        const NewInvoiceView = () => {
             const products = App.data.products.filter(p => p.stock > 0);

             // Items list HTML
             const itemsListHTML = App.data.draftInvoice.items.map((item, index) => `
                <tr class="border-b">
                    <td class="p-3 text-sm text-gray-700">${item.productName}</td>
                    <td class="p-3 text-sm text-gray-700">${item.quantity}</td>
                    <td class="p-3 text-sm text-gray-700">${parseFloat(item.unitPrice).toLocaleString('ar-EG', { minimumFractionDigits: 2 })}</td>
                    <td class="p-3 text-sm text-gray-700">${item.discount}%</td>
                    <td class="p-3 text-sm font-bold text-green-600">${parseFloat(item.total).toLocaleString('ar-EG', { minimumFractionDigits: 2 })}</td>
                    <td class="p-3 text-sm text-left">
                        <button onclick="handleRemoveItem(${index})" class="text-red-600 hover:text-red-800 p-1 rounded">
                            <i data-lucide="x" class="w-4 h-4"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            
            // Customer Datalist
            const customerDatalist = `<datalist id="customer-names">${App.data.customers.map(c => `<option value="${c.name}">`).join('')}</datalist>`;


            return `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 space-y-6">
                        <div class="card p-6">
                            <h3 class="text-xl font-bold mb-4 flex items-center"><i data-lucide="receipt" class="w-6 h-6 ml-2 text-shahrazad"></i> تفاصيل العميل والفاتورة</h3>
                            <form id="new-invoice-form">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="mb-4">
                                        <label for="customer-name" class="block text-sm font-medium text-gray-700 mb-1">اسم العميل (سيحفظ تلقائياً)</label>
                                        <input list="customer-names" id="customer-name" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-shahrazad focus:border-shahrazad" placeholder="اسم العميل...">
                                        ${customerDatalist}
                                    </div>
                                    <div class="mb-4">
                                        <label for="invoice-date" class="block text-sm font-medium text-gray-700 mb-1">التاريخ</label>
                                        <input type="text" id="invoice-date" value="${myAssistant.formatCurrentDate()}" disabled class="w-full p-2 border border-gray-300 bg-gray-50 rounded-lg">
                                    </div>
                                </div>
                                <div class="mb-4">
                                    <label for="invoice-notes" class="block text-sm font-medium text-gray-700 mb-1">ملاحظات الفاتورة</label>
                                    <textarea id="invoice-notes" rows="2" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-shahrazad focus:border-shahrazad" placeholder="ملاحظات إضافية (اختياري)"></textarea>
                                </div>
                            </form>
                        </div>

                        <div class="card p-6">
                            <h3 class="text-xl font-bold mb-4 flex items-center"><i data-lucide="package" class="w-6 h-6 ml-2 text-shahrazad"></i> إضافة صنف للفاتورة</h3>
                            <div class="grid grid-cols-1 sm:grid-cols-5 gap-4 items-end">
                                <div class="sm:col-span-2">
                                    <label for="product-select" class="block text-sm font-medium text-gray-700 mb-1">الصنف</label>
                                    <select id="product-select" onchange="onProductSelectChange()" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-shahrazad focus:border-shahrazad">
                                        <option value="">اختر صنف...</option>
                                        ${products.map(p => `<option value="${p.id}">${p.name} (مخزون: ${p.stock})</option>`).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label for="item-quantity" class="block text-sm font-medium text-gray-700 mb-1">الكمية</label>
                                    <input type="number" id="item-quantity" value="1" min="1" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-shahrazad focus:border-shahrazad">
                                </div>
                                <div>
                                    <label for="item-price" class="block text-sm font-medium text-gray-700 mb-1">سعر الوحدة</label>
                                    <input type="number" id="item-price" step="0.01" value="0" min="0" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-shahrazad focus:border-shahrazad">
                                </div>
                                <div>
                                    <label for="item-discount" class="block text-sm font-medium text-gray-700 mb-1">خصم (%)</label>
                                    <input type="number" id="item-discount" step="0.1" value="0" min="0" max="100" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-shahrazad focus:border-shahrazad">
                                </div>
                                
                            </div>
                            <div class="mt-4 flex justify-end">
                                <button type="button" onclick="handleAddItem()" class="bg-green-600 text-white p-2 rounded-lg flex items-center hover:bg-green-700 transition duration-150">
                                    <i data-lucide="plus" class="w-5 h-5 ml-2"></i>
                                    إضافة
                                </button>
                            </div>
                        </div>

                        <div class="card p-6">
                            <h3 class="text-xl font-bold mb-4 flex items-center"><i data-lucide="list-ordered" class="w-6 h-6 ml-2 text-shahrazad"></i> قائمة الأصناف المضافة</h3>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="p-3 text-right text-xs font-medium text-gray-500 uppercase">الصنف</th>
                                            <th class="p-3 text-right text-xs font-medium text-gray-500 uppercase">الكمية</th>
                                            <th class="p-3 text-right text-xs font-medium text-gray-500 uppercase">سعر الوحدة</th>
                                            <th class="p-3 text-right text-xs font-medium text-gray-500 uppercase">الخصم</th>
                                            <th class="p-3 text-right text-xs font-medium text-gray-500 uppercase">الإجمالي</th>
                                            <th class="p-3 text-right text-xs font-medium text-gray-500 uppercase">حذف</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200">
                                        ${itemsListHTML.length > 0 ? itemsListHTML : `<tr><td colspan="6" class="p-4 text-center text-gray-500">لا توجد أصناف مضافة بعد.</td></tr>`}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div class="lg:col-span-1 space-y-6">
                        <div class="card p-6 sticky top-6">
                            <h3 class="text-xl font-bold mb-4 flex items-center"><i data-lucide="dollar-sign" class="w-6 h-6 ml-2 text-shahrazad"></i> ملخص الفاتورة</h3>
                            <div class="space-y-3">
                                <div class="flex justify-between border-b pb-2">
                                    <span class="text-gray-600">الإجمالي قبل الخصم:</span>
                                    <span class="font-medium">${parseFloat(App.data.draftInvoice.subTotal).toLocaleString('ar-EG', { minimumFractionDigits: 2 })} SDG</span>
                                </div>
                                <div class="flex justify-between border-b pb-2">
                                    <span class="text-red-500">إجمالي الخصم:</span>
                                    <span class="font-medium text-red-500">(${parseFloat(App.data.draftInvoice.totalDiscount).toLocaleString('ar-EG', { minimumFractionDigits: 2 })}) SDG</span>
                                </div>
                                <div class="flex justify-between pt-3 border-t-2 border-shahrazad">
                                    <span class="text-2xl font-bold text-gray-800">صافي المبلغ المطلوب:</span>
                                    <span class="text-2xl font-bold text-green-700">${parseFloat(App.data.draftInvoice.grandTotal).toLocaleString('ar-EG', { minimumFractionDigits: 2 })} SDG</span>
                                </div>
                            </div>

                            <button id="save-invoice-btn" onclick="handleNewInvoice(event)" form="new-invoice-form" type="submit" class="w-full mt-6 flex justify-center py-3 px-4 rounded-lg shadow-lg text-lg font-bold text-white bg-green-600 hover:bg-green-700 transition duration-150">
                                <i data-lucide="save" class="w-5 h-5 ml-2"></i>
                                حفظ وإصدار الفاتورة
                            </button>
                        </div>
                    </div>
                </div>
            `;
        };

        // --- 9. Print/View Invoice Details ---
        const PrintInvoiceView = () => {
            const inv = App.currentInvoiceForView;
            if (!inv) return `<p class="text-center text-red-500">عذراً، لم يتم العثور على بيانات الفاتورة.</p>`;

            // Helper to get the user who created the invoice
            const createdByUser = App.data.users.find(u => u.uid === inv.createdBy)?.name || 'النظام';
            
            return `
                <div class="print-controls mb-6 flex justify-between items-center">
                     <button onclick="navigateTo('invoices')" class="bg-gray-500 text-white p-2 rounded-lg flex items-center hover:bg-gray-600 transition duration-150">
                        <i data-lucide="arrow-right" class="w-5 h-5 ml-2"></i>
                        العودة إلى الفواتير
                    </button>
                    <button onclick="generateInvoicePDF()" class="bg-shahrazad text-white p-3 rounded-lg flex items-center hover:bg-blue-700 transition duration-150">
                        <i data-lucide="download" class="w-5 h-5 ml-2"></i>
                        طباعة / تنزيل PDF
                    </button>
                </div>

                <div id="invoice-print-view" class="print-area card p-8 shadow-xl max-w-4xl mx-auto bg-white">
                    <div class="flex justify-between items-center border-b-2 border-shahrazad pb-4 mb-6">
                        <div>
                            <h1 class="text-3xl font-black text-shahrazad">SHAHRAZAD ELECTRIC</h1>
                            <p class="text-sm text-gray-600 mt-1">نظام إدارة المبيعات المتقدم</p>
                        </div>
                        <div class="text-left">
                            <h2 class="text-xl font-bold text-gray-800">فاتورة مبيعات</h2>
                            <p class="text-sm text-gray-600">رقم الفاتورة: <span class="font-bold">${inv.invoiceNumber || inv.id.substring(0, 8)}</span></p>
                            <p class="text-sm text-gray-600">التاريخ: ${myAssistant.formatTimestamp(inv.date)}</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4 text-sm mb-8">
                        <div>
                            <p class="font-bold text-shahrazad mb-1">معلومات العميل:</p>
                            <p>الاسم: ${inv.customerName || 'عميل غير مسجل'}</p>
                            <p>هاتف: N/A</p>
                        </div>
                        <div class="text-left">
                            <p class="font-bold text-shahrazad mb-1">معلومات البائع:</p>
                            <p>الموظف: ${createdByUser}</p>
                            <p>الفرع: الخرطوم</p>
                        </div>
                    </div>

                    <div class="overflow-x-auto mb-6 border border-gray-200 rounded-lg">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="px-4 py-2 text-right text-xs font-bold text-gray-600 uppercase">الصنف</th>
                                    <th class="px-4 py-2 text-right text-xs font-bold text-gray-600 uppercase">الكمية</th>
                                    <th class="px-4 py-2 text-right text-xs font-bold text-gray-600 uppercase">سعر الوحدة (SDG)</th>
                                    <th class="px-4 py-2 text-right text-xs font-bold text-gray-600 uppercase">الخصم (%)</th>
                                    <th class="px-4 py-2 text-right text-xs font-bold text-gray-600 uppercase">الإجمالي (SDG)</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200 text-sm">
                                ${inv.items.map(item => `
                                    <tr>
                                        <td class="px-4 py-2 text-gray-800">${item.name}</td>
                                        <td class="px-4 py-2">${item.quantity}</td>
                                        <td class="px-4 py-2">${parseFloat(item.unitPrice).toLocaleString('ar-EG', { minimumFractionDigits: 2 })}</td>
                                        <td class="px-4 py-2">${item.discount || 0}%</td>
                                        <td class="px-4 py-2 font-medium text-green-700">${parseFloat(item.total).toLocaleString('ar-EG', { minimumFractionDigits: 2 })}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>

                    <div class="flex justify-between">
                        <div class="w-1/2">
                            <p class="text-sm font-bold text-shahrazad mb-2">ملاحظات:</p>
                            <p class="text-sm text-gray-700">${inv.notes || 'لا توجد ملاحظات.'}</p>
                        </div>
                        <div class="w-1/2 text-left space-y-2">
                            <div class="flex justify-between">
                                <span class="text-gray-600">الإجمالي:</span>
                                <span class="font-medium">${parseFloat(inv.subTotal).toLocaleString('ar-EG', { minimumFractionDigits: 2 })} SDG</span>
                            </div>
                             <div class="flex justify-between">
                                <span class="text-red-500">الخصم الإجمالي:</span>
                                <span class="font-medium text-red-500">(${parseFloat(inv.totalDiscount).toLocaleString('ar-EG', { minimumFractionDigits: 2 })}) SDG</span>
                            </div>
                            <div class="flex justify-between pt-2 border-t font-bold text-lg">
                                <span class="text-gray-800">صافي المبلغ:</span>
                                <span class="text-green-700">${parseFloat(inv.grandTotal).toLocaleString('ar-EG', { minimumFractionDigits: 2 })} SDG</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="text-center mt-10 pt-4 border-t border-gray-300">
                        <p class="text-xs text-gray-500">شكراً لتعاملكم مع SHAHRAZAD ELECTRIC</p>
                    </div>
                </div>
            `;
        };

        // --- 10. Customers View ---
        const CustomersView = () => {
            const customers = App.data.customers.sort((a, b) => new Date(b.lastPurchaseDate || b.createdAt) - new Date(a.lastPurchaseDate || a.createdAt));
            return `
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">إدارة العملاء (${customers.length} عميل)</h2>
                    <button onclick="window.showCustomerModal()" class="bg-shahrazad text-white p-3 rounded-lg flex items-center hover:bg-blue-700 transition duration-150">
                        <i data-lucide="user-plus" class="w-5 h-5 ml-2"></i>
                        إضافة عميل جديد
                    </button>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                    <div class="card p-5 flex items-center bg-gradient-to-r from-yellow-400 to-yellow-600 text-white shadow-lg">
                        <div class="p-3 rounded-full bg-white bg-opacity-20 ml-4">
                            <i data-lucide="crown" class="w-6 h-6"></i>
                        </div>
                        <div>
                            <p class="text-sm opacity-80">العملاء البلاتين</p>
                            <p class="text-3xl font-bold">${customers.filter(c => c.discountLevel === 'بلاتين').length}</p>
                        </div>
                    </div>
                    <div class="card p-5 flex items-center bg-gradient-to-r from-yellow-500 to-yellow-700 text-white shadow-lg">
                        <div class="p-3 rounded-full bg-white bg-opacity-20 ml-4">
                            <i data-lucide="award" class="w-6 h-6"></i>
                        </div>
                        <div>
                            <p class="text-sm opacity-80">العملاء الذهبيين</p>
                            <p class="text-3xl font-bold">${customers.filter(c => c.discountLevel === 'ذهبي').length}</p>
                        </div>
                    </div>
                    <div class="card p-5 flex items-center bg-gradient-to-r from-gray-400 to-gray-600 text-white shadow-lg">
                        <div class="p-3 rounded-full bg-white bg-opacity-20 ml-4">
                            <i data-lucide="star" class="w-6 h-6"></i>
                        </div>
                        <div>
                            <p class="text-sm opacity-80">العملاء الفضي</p>
                            <p class="text-3xl font-bold">${customers.filter(c => c.discountLevel === 'فضي').length}</p>
                        </div>
                    </div>
                    <div class="card p-5 flex items-center bg-gradient-to-r from-orange-600 to-orange-800 text-white shadow-lg">
                        <div class="p-3 rounded-full bg-white bg-opacity-20 ml-4">
                            <i data-lucide="user" class="w-6 h-6"></i>
                        </div>
                        <div>
                            <p class="text-sm opacity-80">العملاء البرونزي</p>
                            <p class="text-3xl font-bold">${customers.filter(c => c.discountLevel === 'برونزي').length}</p>
                        </div>
                    </div>
                </div>
                
                <div class="card p-6">
                    ${renderCustomerList(customers)}
                </div>

                ${renderCustomerModal()}
            `;
        };

        const renderCustomerList = (customers) => {
            if (customers.length === 0) {
                 return `<p class="text-gray-500 text-center py-4">لا توجد عملاء مسجلين حالياً.</p>`;
            }
             return `
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">الاسم</th>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">هاتف</th>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">النقاط</th>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">المستوى</th>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">التخفيض</th>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">الإجمالي المنفق (SDG)</th>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${customers.map(c => `
                                <tr>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${c.name}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${c.phone || 'N/A'}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-blue-600">${c.points || 0}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${getBadgeColor(c.discountLevel || 'عادي')}">
                                            ${c.discountLevel || 'عادي'}
                                        </span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-green-600">${c.customerDiscount || 0}%</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-green-600 font-bold">${(c.totalSpent || 0).toLocaleString('ar-EG', { minimumFractionDigits: 2 })}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                        <button onclick="window.editCustomer('${c.id}')" class="text-shahrazad hover:text-blue-700 ml-3">
                                            <i data-lucide="square-pen" class="w-5 h-5"></i>
                                        </button>
                                        <button onclick="window.deleteCustomer('${c.id}', '${c.name}')" class="text-red-600 hover:text-red-900 ${App.userRole !== 'admin' ? 'hidden' : ''}">
                                            <i data-lucide="trash-2" class="w-5 h-5"></i>
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        };
        
        // Customer CRUD Logic (Simplified for demonstration)
        const renderCustomerModal = () => `
            <div id="customer-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 justify-center items-center" onclick="if(event.target.id === 'customer-modal') window.hideCustomerModal()">
                <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-lg mx-auto" onclick="event.stopPropagation()">
                    <h3 class="text-xl font-bold mb-4">إضافة / تعديل عميل</h3>
                    <form id="customer-form" onsubmit="window.handleCustomerSubmit(event)">
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="customer-modal-name">اسم العميل</label>
                            <input type="text" id="customer-modal-name" required class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        </div>
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="customer-phone">رقم الهاتف</label>
                            <input type="text" id="customer-phone" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        </div>
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="customer-points">النقاط</label>
                            <input type="number" id="customer-points" value="0" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        </div>
                        <div class="mb-4">
                            <input type="checkbox" id="customer-is-distinguished" class="mr-2 leading-tight">
                            <label class="text-sm" for="customer-is-distinguished">عميل مميز (VIP)</label>
                        </div>
                        
                        <div class="flex justify-end mt-6">
                            <button type="button" onclick="window.hideCustomerModal()" class="bg-gray-300 text-gray-800 p-2 rounded-lg ml-4 hover:bg-gray-400">إلغاء</button>
                            <button type="submit" id="customer-submit-btn" class="bg-shahrazad text-white p-2 rounded-lg flex items-center hover:bg-blue-700 transition duration-150">
                                <i data-lucide="save" class="w-5 h-5 ml-2"></i>
                                حفظ العميل
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        `;
        
        window.showCustomerModal = (customer = {}) => {
            const modal = document.getElementById('customer-modal');
            const form = document.getElementById('customer-form');
            form.reset();
            form.dataset.customerId = customer.id || '';
            document.getElementById('customer-modal-name').value = customer.name || '';
            document.getElementById('customer-phone').value = customer.phone || '';
            document.getElementById('customer-points').value = customer.points || 0;
            document.getElementById('customer-is-distinguished').checked = customer.isDistinguished || false;

            document.getElementById('customer-submit-btn').innerHTML = customer.id ? `<i data-lucide="save" class="w-5 h-5 ml-2"></i> حفظ التعديل` : `<i data-lucide="user-plus" class="w-5 h-5 ml-2"></i> إضافة العميل`;
            lucide.createIcons();
            modal.style.display = 'flex';
        };

        window.hideCustomerModal = () => {
            document.getElementById('customer-modal').style.display = 'none';
        };

        window.editCustomer = (id) => {
            const customer = App.data.customers.find(c => c.id === id);
            if (customer) window.showCustomerModal(customer);
        };
        
        window.handleCustomerSubmit = async (e) => {
            e.preventDefault();
            const form = e.target;
            const customerId = form.dataset.customerId;
            const isNew = !customerId;
            const name = form.querySelector('#customer-modal-name').value;
            const phone = form.querySelector('#customer-phone').value;
            const points = parseInt(form.querySelector('#customer-points').value) || 0;
            const isDistinguished = form.querySelector('#customer-is-distinguished').checked;

            // تحديد مستوى التخفيض بناءً على النقاط
            let discountLevel = 'عادي';
            let customerDiscount = 0;
            
            if (points >= POINTS_CONFIG.platinumThreshold) {
                discountLevel = 'بلاتين';
                customerDiscount = POINTS_CONFIG.platinumDiscount;
            } else if (points >= POINTS_CONFIG.goldThreshold) {
                discountLevel = 'ذهبي';
                customerDiscount = POINTS_CONFIG.goldDiscount;
            } else if (points >= POINTS_CONFIG.silverThreshold) {
                discountLevel = 'فضي';
                customerDiscount = POINTS_CONFIG.silverDiscount;
            } else if (points >= POINTS_CONFIG.bronzeThreshold) {
                discountLevel = 'برونزي';
                customerDiscount = POINTS_CONFIG.bronzeDiscount;
            }

            const customerData = { 
                name, 
                phone, 
                points,
                discountLevel,
                customerDiscount,
                isDistinguished, 
                totalSpent: 0,
                totalInvoices: 0
            };
            
            const submitBtn = form.querySelector('#customer-submit-btn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = `<i data-lucide="loader-circle" class="w-5 h-5 ml-2 inline animate-spin"></i> جاري الحفظ...`;
            lucide.createIcons();

            try {
                if (isNew) {
                    await addDoc(collection(App.db, App.getCollectionPath('customers')), { ...customerData, createdAt: new Date().toISOString() });
                    alertUser(`تم إضافة العميل **${name}** بنجاح.`, "success");
                } else {
                    await updateDoc(doc(App.db, App.getCollectionPath('customers'), customerId), customerData);
                    alertUser(`تم تعديل العميل **${name}** بنجاح.`, "success");
                }
                window.hideCustomerModal();
            } catch (error) {
                console.error("Customer save failed:", error);
                alertUser(`فشل حفظ العميل: ${error.message}`, "error");
            } finally {
                submitBtn.disabled = false;
            }
        };

        window.deleteCustomer = async (id, name) => {
            if (App.userRole !== 'admin') {
                alertUser("عذراً، يجب أن تكون بـ **صلاحية المدير الأساسي** للحذف.", "error");
                return;
            }
            if (!confirm(`هل أنت متأكد من حذف العميل: ${name}؟ لا يمكن التراجع عن هذا الإجراء!`)) return;

            try {
                await deleteDoc(doc(App.db, App.getCollectionPath('customers'), id));
                alertUser(`تم حذف العميل **${name}** بنجاح.`, "success");
            } catch (error) {
                console.error("Customer deletion failed:", error);
                alertUser(`فشل حذف العميل: ${error.message}`, "error");
            }
        };

        // --- 11. Alerts View ---
        const AlertsView = () => {
            return `
                <h2 class="text-2xl font-bold text-red-800 mb-6 flex items-center">
                    <i data-lucide="alert-triangle" class="w-7 h-7 ml-3"></i>
                    تنبيهات نقص المخزون
                </h2>
                
                <div class="card p-6">
                    <p class="text-gray-700 mb-4">قائمة بجميع الأصناف التي تقل كميتها في المخزون عن حد التنبيه المحدد لها (افتراضياً 10 وحدات).</p>
                    <div id="alerts-container-full">
                        </div>
                </div>
            `;
        };

        // --- 12. General Settings View ---
        const GeneralSettingsView = () => {
            const warehouses = App.data.warehouses.sort((a, b) => (a.name || '').localeCompare(b.name || ''));

            return `
                <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                    <i data-lucide="settings" class="w-7 h-7 ml-3"></i>
                    الإعدادات العامة وإدارة النظام
                </h2>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    
                    <div class="card p-6">
                        <div class="flex justify-between items-center border-b pb-3 mb-4">
                            <h3 class="text-xl font-semibold text-shahrazad flex items-center"><i data-lucide="warehouse" class="w-5 h-5 ml-2"></i> إدارة المخازن</h3>
                            <button onclick="window.showWarehouseModal()" class="bg-green-600 text-white p-2 rounded-lg flex items-center hover:bg-green-700 transition duration-150">
                                <i data-lucide="plus" class="w-5 h-5 ml-2"></i> إضافة مخزن
                            </button>
                        </div>
                        
                        ${warehouses.length > 0 ? `
                            <ul class="space-y-3">
                                ${warehouses.map(w => `
                                    <li class="flex justify-between items-center p-3 border rounded-lg shadow-sm">
                                        <span class="font-medium text-gray-800">${w.name}</span>
                                        <button onclick="window.deleteWarehouse('${w.id}', '${w.name}')" class="text-red-600 hover:text-red-900 ${App.userRole !== 'admin' ? 'hidden' : ''}">
                                            <i data-lucide="trash-2" class="w-5 h-5"></i>
                                        </button>
                                    </li>
                                `).join('')}
                            </ul>
                        ` : '<p class="text-gray-500 text-center py-4">لا توجد مخازن مسجلة.</p>'}
                    </div>

                    <div class="card p-6">
                        <div class="border-b pb-3 mb-4">
                            <h3 class="text-xl font-semibold text-shahrazad flex items-center"><i data-lucide="trophy" class="w-5 h-5 ml-2"></i> إعدادات نظام النقاط</h3>
                        </div>
                        <div class="space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">نقاط لكل فاتورة</label>
                                    <input type="number" value="${POINTS_CONFIG.pointsPerInvoice}" class="w-full p-2 border rounded-lg" disabled>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">حد البرونز</label>
                                    <input type="number" value="${POINTS_CONFIG.bronzeThreshold}" class="w-full p-2 border rounded-lg" disabled>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">حد الفضة</label>
                                    <input type="number" value="${POINTS_CONFIG.silverThreshold}" class="w-full p-2 border rounded-lg" disabled>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">حد الذهب</label>
                                    <input type="number" value="${POINTS_CONFIG.goldThreshold}" class="w-full p-2 border rounded-lg" disabled>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">حد البلاتين</label>
                                    <input type="number" value="${POINTS_CONFIG.platinumThreshold}" class="w-full p-2 border rounded-lg" disabled>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">تخفيض البلاتين</label>
                                    <input type="number" value="${POINTS_CONFIG.platinumDiscount}" class="w-full p-2 border rounded-lg" disabled>
                                </div>
                            </div>
                        </div>
                        <p class="text-sm text-gray-500 mt-4">💡 يمكن تعديل هذه الإعدادات في كود النظام</p>
                    </div>

                    <div class="card p-6">
                        <div class="border-b pb-3 mb-4">
                            <h3 class="text-xl font-semibold text-shahrazad flex items-center"><i data-lucide="database" class="w-5 h-5 ml-2"></i> إدارة البيانات</h3>
                        </div>
                        <p class="text-gray-700 mb-4">قم بتنزيل نسخة احتياطية من جميع بيانات النظام (الأصناف، الفواتير، العملاء، المستخدمين) كملف JSON.</p>
                        <button id="backup-btn" onclick="window.backupData()" class="w-full bg-orange-600 text-white p-3 rounded-lg flex items-center justify-center hover:bg-orange-700 transition duration-150">
                            <i data-lucide="download" class="w-5 h-5 ml-2"></i> تنزيل نسخة احتياطية
                        </button>
                    </div>

                </div>

                ${renderWarehouseModal()}
            `;
        };

        // Warehouse CRUD Logic (Simplified for demonstration)
        const renderWarehouseModal = () => `
            <div id="warehouse-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 justify-center items-center" onclick="if(event.target.id === 'warehouse-modal') window.hideWarehouseModal()">
                <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-lg mx-auto" onclick="event.stopPropagation()">
                    <h3 class="text-xl font-bold mb-4">إضافة مخزن جديد</h3>
                    <form id="warehouse-form" onsubmit="window.handleWarehouseSubmit(event)">
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="warehouse-name">اسم المخزن</label>
                            <input type="text" id="warehouse-name" required class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="مثال: مخزن الخرطوم الرئيسي">
                        </div>
                        
                        <div class="flex justify-end mt-6">
                            <button type="button" onclick="window.hideWarehouseModal()" class="bg-gray-300 text-gray-800 p-2 rounded-lg ml-4 hover:bg-gray-400">إلغاء</button>
                            <button type="submit" id="warehouse-submit-btn" class="bg-shahrazad text-white p-2 rounded-lg flex items-center hover:bg-blue-700 transition duration-150">
                                <i data-lucide="plus" class="w-5 h-5 ml-2"></i>
                                إضافة المخزن
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        `;

        window.showWarehouseModal = () => {
             const modal = document.getElementById('warehouse-modal');
             document.getElementById('warehouse-form').reset();
             document.getElementById('warehouse-submit-btn').innerHTML = `<i data-lucide="plus" class="w-5 h-5 ml-2"></i> إضافة المخزن`;
             lucide.createIcons();
             modal.style.display = 'flex';
        };

        window.hideWarehouseModal = () => {
            document.getElementById('warehouse-modal').style.display = 'none';
        };

        window.handleWarehouseSubmit = async (e) => {
            e.preventDefault();
            const form = e.target;
            const name = form.querySelector('#warehouse-name').value;

            const submitBtn = form.querySelector('#warehouse-submit-btn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = `<i data-lucide="loader-circle" class="w-5 h-5 ml-2 inline animate-spin"></i> جاري الحفظ...`;
            lucide.createIcons();

            try {
                await addDoc(collection(App.db, App.getCollectionPath('warehouses')), { name, createdAt: new Date().toISOString() });
                alertUser(`تم إضافة المخزن **${name}** بنجاح.`, "success");
                window.hideWarehouseModal();
            } catch (error) {
                console.error("Warehouse save failed:", error);
                alertUser(`فشل حفظ المخزن: ${error.message}`, "error");
            } finally {
                submitBtn.disabled = false;
            }
        };

        window.deleteWarehouse = async (id, name) => {
             if (App.userRole !== 'admin') {
                alertUser("عذراً، يجب أن تكون بـ **صلاحية المدير الأساسي** للحذف.", "error");
                return;
            }
            
            // Check if any product is linked to this warehouse
            const productsInWarehouse = App.data.products.filter(p => p.warehouse === name);
            if (productsInWarehouse.length > 0) {
                 alertUser(`لا يمكن حذف المخزن **${name}**. يرجى نقل أو حذف ${productsInWarehouse.length} صنف مرتبط به أولاً.`, "error");
                 return;
            }

            if (!confirm(`هل أنت متأكد من حذف المخزن: ${name}؟ لا يمكن التراجع عن هذا الإجراء!`)) return;

            try {
                await deleteDoc(doc(App.db, App.getCollectionPath('warehouses'), id));
                alertUser(`تم حذف المخزن **${name}** بنجاح.`, "success");
            } catch (error) {
                console.error("Warehouse deletion failed:", error);
                alertUser(`فشل حذف المخزن: ${error.message}`, "error");
            }
        };


        // --- 13. User Settings View ---
        const UserSettingsView = () => {
            const users = App.data.users.sort((a, b) => (a.role === 'admin' ? -1 : 1));
            return `
                <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                    <i data-lucide="lock" class="w-7 h-7 ml-3"></i>
                    إدارة المستخدمين والصلاحيات
                </h2>
                
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    
                    <div class="lg:col-span-1 card p-6">
                        <h3 class="text-xl font-semibold text-shahrazad mb-4">إضافة مستخدم جديد</h3>
                        ${App.userRole !== 'admin' ? `
                            <p class="text-red-500 font-bold text-center p-4 bg-red-100 rounded-lg">عذراً، هذه الميزة مخصصة للمدير الأساسي فقط.</p>
                        ` : `
                        <form id="add-user-form" onsubmit="handleUserCreate(event)">
                            <div class="mb-4">
                                <label for="user-name" class="block text-sm font-medium text-gray-700">الاسم</label>
                                <input type="text" id="user-name" required class="w-full p-2 border rounded-lg">
                            </div>
                            <div class="mb-4">
                                <label for="user-email" class="block text-sm font-medium text-gray-700">البريد الإلكتروني</label>
                                <input type="email" id="user-email" required class="w-full p-2 border rounded-lg">
                            </div>
                            <div class="mb-4">
                                <label for="user-password" class="block text-sm font-medium text-gray-700">كلمة المرور (6+ أحرف)</label>
                                <input type="password" id="user-password" required minlength="6" class="w-full p-2 border rounded-lg">
                            </div>
                            <div class="mb-4">
                                <label for="user-role" class="block text-sm font-medium text-gray-700">الصلاحية</label>
                                <select id="user-role" required class="w-full p-2 border rounded-lg">
                                    <option value="staff">موظف (Staff)</option>
                                    <option value="admin">مدير أساسي (Admin)</option>
                                </select>
                            </div>
                            <button type="submit" class="w-full mt-4 bg-shahrazad text-white p-2 rounded-lg flex items-center justify-center hover:bg-blue-700 transition duration-150">
                                <i data-lucide="user-plus" class="w-5 h-5 ml-2"></i>
                                إضافة مستخدم جديد
                            </button>
                        </form>
                        `}
                    </div>

                    <div class="lg:col-span-2 card p-6">
                        <h3 class="text-xl font-semibold text-shahrazad mb-4">قائمة المستخدمين الحاليين (${users.length})</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">الاسم / البريد</th>
                                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">الصلاحية</th>
                                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    ${users.map(u => `
                                        <tr>
                                            <td class="px-6 py-4 whitespace-nowrap">
                                                <div class="text-sm font-medium text-gray-900">${u.name || u.email}</div>
                                                <div class="text-xs text-gray-500">${u.email}</div>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap">
                                                <span class="inline-flex items-center px-3 py-0.5 rounded-full text-sm font-medium ${u.role === 'admin' ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}">
                                                    ${u.role === 'admin' ? 'مدير أساسي' : 'موظف'}
                                                </span>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                                ${u.uid !== App.userId && u.role !== 'admin' && App.userRole === 'admin' ? `
                                                    <button onclick="window.handleUserDelete('${u.uid}', '${u.email}')" class="text-red-600 hover:text-red-900">
                                                        <i data-lucide="trash-2" class="w-5 h-5"></i> حذف
                                                    </button>
                                                ` : u.uid === App.userId ? `<span class="text-gray-400">أنت!</span>` : `<span class="text-gray-400">مدير أساسي</span>`}
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>

                </div>
            `;
        };
        
        // ====================================================================
        //                      App Initialization
        // ====================================================================

        App.views = {
            loading: LoadingView,
            auth_error: AuthErrorView,
            login: LoginView,
            dashboard: DashboardView,
            products: ProductsView,
            displayed_products: DisplayedProductsView,
            invoices: InvoicesView,
            new_invoice: NewInvoiceView, // Added new view
            invoice_details: PrintInvoiceView, // Added new view
            customers: CustomersView,
            alerts: AlertsView,
            general_settings: GeneralSettingsView,
            user_settings: UserSettingsView,
        };

        function render() {
            const appRoot = document.getElementById('app-root');
            if (appRoot) {
                appRoot.innerHTML = MainLayout();
                lucide.createIcons();
            }
        }

        // --- Start Application ---\n
        // 1. Setup global container
        const appContainer = document.createElement('div');
        appContainer.id = 'app-root';
        document.body.appendChild(appContainer);

        // 2. Start Auth Process
        authenticateUser().then(() => { setupAuthStateListener(); });
    </script>
    
    <div id="global-alert" class="fixed top-4 right-4 z-50 p-4 rounded-lg shadow-xl text-white transition-all duration-300 transform -translate-y-20 opacity-0">
        </div>
    
</body>
</html>
