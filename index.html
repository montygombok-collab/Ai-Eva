<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SHAHRAZAD ELECTRIC | نظام إدارة المبيعات المتقدم</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <style>
        /* Custom styles for SHAHRAZAD ELECTRIC identity */
        body { font-family: 'Cairo', sans-serif; background-color: #f4f7fa; }
        /* Brand color (Strong blue) */
        .text-shahrazad { color: #004d99; } 
        .bg-shahrazad { background-color: #004d99; }
        /* Advanced gradient background */
        .gradient-bg { background: linear-gradient(135deg, #004d99 0%, #002d5b 100%); }
        /* Soft-edged cards with high shadow */
        .card { background-color: white; border-radius: 12px; box-shadow: 0 6px 15px rgba(0, 0, 0, 0.08); transition: transform 0.2s; }
        .card:hover { transform: translateY(-3px); box-shadow: 0 12px 25px rgba(0, 0, 0, 0.12); }
        /* Chat box style for the smart assistant */
        #chat-body { height: 300px; overflow-y: auto; display: flex; flex-direction: column-reverse; }
        .chat-message-user { background-color: #dbeafe; border-bottom-right-radius: 0; }
        .chat-message-ai { background-color: #e0f2f1; color: #004d99; border-bottom-left-radius: 0; }
        
        /* Styles for printing the invoice */
        @media print {
            body * {
                visibility: hidden;
            }
            .print-area, .print-area * {
                visibility: visible;
            }
            .print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                margin: 0;
                padding: 0;
            }
            /* Hide print-only buttons */
            .print-controls {
                display: none !important;
            }
        }
    </style>
</head>
<body>

    <script type="module">
        
        // --- 1. Firebase Configuration ---
        const defaultFirebaseConfig = {
            apiKey: "AIzaSyBtc-pniRx5Mda5UW_kNqS0Zyi8zcKvdlU",
            authDomain: "shahrazad-electric.firebaseapp.com",
            projectId: "shahrazad-electric",
            storageBucket: "shahrazad-electric.firebasestorage.app",
            messagingSenderId: "582314926345",
            appId: "1:582314926345:web:39c2979beadd8b47a133d8",
            measurementId: "G-3RH0BKKW16"
        };
        
        // Fetch global variables from the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-shahrazad-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const firestoreConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : defaultFirebaseConfig;

        // --- 2. Firebase Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // تم إضافة createUserWithEmailAndPassword لاستخدامها في صفحة إدارة المستخدمين
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut, updatePassword, signInWithEmailAndPassword, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, query, where, addDoc, updateDoc, deleteDoc, writeBatch, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- 3. Initialization ---
        const app = initializeApp(firestoreConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        setLogLevel('Debug'); // Enable debug logs

        // --- 4. Global State (App) ---
        window.App = {
            db,
            auth,
            appId,
            userId: null,
            userRole: 'staff',
            view: 'loading',
            data: { products: [], customers: [], invoices: [], users: [], alerts: [], warehouses: [] },
            draftInvoice: { items: [], subTotal: 0, totalDiscount: 0, grandTotal: 0 }, // New state for invoice creation
            currentInvoiceForView: null, // New state for print view
            
            // Public collection path (for products, invoices, users)
            getCollectionPath(collectionName) {
                return `artifacts/${this.appId}/public/data/${collectionName}`;
            },
        };

        // ====================================================================
        //                      MERGED UTILITY CLASS (Assistant) 
        // ====================================================================
        /**
         * Assistant Class (فئة المساعد)
         */
        class Assistant {
            constructor(name = "المساعد الرقمي") {
                this.name = name;
            }

            calculateSum(a, b) {
                if (typeof a !== 'number' || typeof b !== 'number') {
                    return NaN;
                }
                return a + b;
            }

            generateGreeting(userName) {
                if (!userName || typeof userName !== 'string') {
                    userName = "صديقنا العزيز";
                }
                return `أهلاً بك يا ${userName}! ${this.name} في خدمتك.`;
            }

            /**
             * تنسيق التاريخ (Format Date)
             */
            formatCurrentDate() {
                const now = new Date();
                const options = { year: 'numeric', month: 'long', day: 'numeric' };
                // استخدام اللغة العربية في التنسيق
                return now.toLocaleDateString('ar-EG', options);
            }
            
            formatTimestamp(timestamp) {
                if (!timestamp) return 'غير محدد';
                // Check if it's a Firestore Timestamp object or a string
                const date = (timestamp.toDate && typeof timestamp.toDate === 'function') ? timestamp.toDate() : new Date(timestamp);
                const options = { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' };
                return date.toLocaleDateString('ar-EG', options);
            }
        }
        
        const myAssistant = new Assistant("مساعد واجهة المستخدم");
        
        // ====================================================================
        //                      Auth and Role Management Unit (Auth & Roles)       
        // ====================================================================
        
        async function authenticateUser() {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(App.auth, initialAuthToken);
                } 
                // تم إزالة signInAnonymously() هنا. سيتم تحويل المستخدم إلى صفحة الدخول إذا لم يكن هناك توكن.
            } catch (error) {
                console.error("Critical Firebase authentication error:", error);
                App.view = 'auth_error';
                render();
            }
        }

        function setupAuthStateListener() {
            onAuthStateChanged(App.auth, async (user) => {
                if (user) {
                    App.userId = user.uid;
                    const userDocRef = doc(App.db, App.getCollectionPath('users'), user.uid);
                    const userDoc = await getDoc(userDocRef);
                    
                    if (userDoc.exists()) {
                        App.userRole = userDoc.data().role || 'staff';
                    } else {
                        // Logic to assign 'admin' to the FIRST user in Firestore
                        const usersCollectionRef = collection(App.db, App.getCollectionPath('users'));
                        const usersSnapshot = await getDocs(usersCollectionRef);
                        
                        // If collection is empty, this user is the Admin.
                        if (usersSnapshot.size === 0) {
                             App.userRole = 'admin'; 
                             alertUser("تهانينا! أنت أول مستخدم وتم تعيين دور 'المدير الأساسي' لك تلقائياً.", "success");
                        } else {
                             App.userRole = 'staff'; 
                        }
                        
                        // Save the new user record with assigned role
                        await setDoc(userDocRef, { uid: user.uid, role: App.userRole, createdAt: new Date().toISOString(), email: user.email || 'N/A' }, { merge: true });
                    }

                    setupFirestoreListeners();
                    App.view = 'dashboard'; // Direct routing to dashboard
                } else {
                    // إذا لم يكن هناك مستخدم، اذهب إلى صفحة تسجيل الدخول
                    App.userId = null;
                    App.view = 'login'; 
                }
                render();
            });
        }
        
        window.handleLogout = () => {
             signOut(App.auth).then(() => { 
                alertUser("تم تسجيل الخروج بنجاح.", "success"); 
             }).catch(console.error);
        };
        
        /**
         * معالج تسجيل الدخول: يدعم البريد وكلمة المرور أو وضع الاختبار المجهول
         */
        window.handleLoginSubmit = async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const loginBtn = document.getElementById('login-btn');
            
            loginBtn.disabled = true;
            loginBtn.innerHTML = `<i data-lucide="loader-circle" class="w-5 h-5 ml-2 inline animate-spin"></i> جاري الدخول...`;

            try {
                // وضع الاختبار: تسجيل دخول مجهول
                if (email.toLowerCase() === "test" && password === "test") {
                    await signInAnonymously(App.auth);
                    alertUser("تم تسجيل الدخول بنجاح كـ 'وضع الاختبار المجهول'.", "success");
                } else {
                    // تسجيل الدخول بالبريد وكلمة المرور
                    await signInWithEmailAndPassword(App.auth, email, password);
                    alertUser("تم تسجيل الدخول بنجاح.", "success");
                }
            } catch (error) {
                console.error("Login error:", error);
                
                let errorMessage = "فشل تسجيل الدخول. يرجى التحقق من البريد الإلكتروني وكلمة المرور.";
                if (error.code === 'auth/user-not-found') {
                    errorMessage = "البريد الإلكتروني غير مسجل في النظام. (ربما تحتاج لتسجيل مستخدم جديد في Firebase).";
                } else if (error.code === 'auth/wrong-password') {
                    errorMessage = "كلمة المرور غير صحيحة.";
                } else if (error.code === 'auth/invalid-credential') {
                     errorMessage = "بيانات الاعتماد غير صالحة.";
                }
                
                alertUser(errorMessage, 'error');
            } finally {
                loginBtn.disabled = false;
                loginBtn.innerHTML = `<i data-lucide="log-in" class="w-5 h-5 ml-2 inline"></i> تسجيل الدخول`;
                lucide.createIcons();
            }
        };

        /**
         * معالج إنشاء مستخدم جديد (Admin Only)
         */
        window.handleUserCreate = async (e) => {
            e.preventDefault();
            const form = document.getElementById('add-user-form');
            const email = form.querySelector('#user-email').value;
            const password = form.querySelector('#user-password').value;
            const role = form.querySelector('#user-role').value;
            const name = form.querySelector('#user-name').value;
            const createBtn = form.querySelector('button[type="submit"]');

            if (App.userRole !== 'admin') {
                alertUser("عذراً، يجب أن تكون بـ **صلاحية المدير الأساسي** لإنشاء مستخدمين جدد.", "error");
                return;
            }

            createBtn.disabled = true;
            createBtn.innerHTML = `<i data-lucide="loader-circle" class="w-5 h-5 ml-2 inline animate-spin"></i> جاري الإنشاء...`;
            lucide.createIcons();
            
            try {
                // 1. Create user in Firebase Auth
                const userCredential = await createUserWithEmailAndPassword(App.auth, email, password);
                const user = userCredential.user;
                
                // 2. Save user role and details in Firestore
                const userDocRef = doc(App.db, App.getCollectionPath('users'), user.uid);
                await setDoc(userDocRef, { 
                    uid: user.uid, 
                    role: role, 
                    email: user.email,
                    name: name || 'غير محدد',
                    createdAt: new Date().toISOString(),
                });
                
                alertUser(`تم إنشاء المستخدم **${email}** بنجاح وتعيين دور ${role}.`, "success");
                form.reset();

            } catch (error) {
                console.error("User creation error:", error);
                let errorMessage = "فشل إنشاء المستخدم. يرجى التحقق من البيانات.";
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = "هذا البريد الإلكتروني مستخدم بالفعل.";
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = "كلمة المرور ضعيفة جداً (يجب أن تكون 6 أحرف على الأقل).";
                } else if (error.code === 'auth/operation-not-allowed') {
                    errorMessage = "غير مسموح بإنشاء المستخدمين. يرجى تفعيل (Email/Password) في إعدادات Firebase Authentication.";
                }
                alertUser(errorMessage, 'error');
            } finally {
                createBtn.disabled = false;
                createBtn.innerHTML = `<i data-lucide="user-plus" class="w-5 h-5 ml-2 inline"></i> إضافة مستخدم جديد`;
                lucide.createIcons();
            }
        };

        /**
         * معالج حذف مستخدم (Admin Only)
         */
        window.handleUserDelete = async (userId, userEmail) => {
            if (App.userRole !== 'admin') {
                alertUser("عذراً، يجب أن تكون بـ **صلاحية المدير الأساسي** للحذف.", "error");
                return;
            }
            if (!confirm(`هل أنت متأكد من حذف سجل المستخدم: ${userEmail}؟ لا يمكن التراجع عن هذا الإجراء!`)) return;

            // نحذف السجل من Firestore فقط، لأن حذف المستخدم من Firebase Auth 
            // يتطلب Admin SDK لأسباب أمنية. نعتمد على أن السجل المحذوف 
            // سيمنع المستخدم من الحصول على دور "admin" أو "staff" في هذا التطبيق.
            
            try {
                // حذف سجل المستخدم من Firestore
                await deleteDoc(doc(App.db, App.getCollectionPath('users'), userId));
                alertUser(`تم حذف سجل المستخدم **${userEmail}** من قاعدة بيانات Firestore بنجاح.`, "success");
            } catch (error) {
                console.error("User deletion error:", error);
                alertUser(`فشل حذف المستخدم: ${error.message}`, "error");
            }
        };

        
        // ====================================================================
        //                      Real-Time Data Fetching Unit (Firestore)      
        // ====================================================================

        function setupFirestoreListeners() {
            if (!App.userId) return;

            // 1. Products and Inventory
            onSnapshot(collection(App.db, App.getCollectionPath('products')), (snapshot) => {
                App.data.products = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                checkLowStockAlerts();
                if (['products', 'dashboard', 'alerts', 'invoices', 'new_invoice'].includes(App.view)) render(); 
            }, console.error);

            // 2. Customers
            onSnapshot(collection(App.db, App.getCollectionPath('customers')), (snapshot) => {
                App.data.customers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (['customers', 'invoices', 'dashboard', 'new_invoice'].includes(App.view)) render();
            }, console.error);
            
            // 3. Invoices
            onSnapshot(collection(App.db, App.getCollectionPath('invoices')), (snapshot) => {
                App.data.invoices = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (['dashboard', 'invoices'].includes(App.view)) render();
            }, console.error);
            
             // 4. Users
            onSnapshot(collection(App.db, App.getCollectionPath('users')), (snapshot) => {
                App.data.users = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (App.view === 'user_settings') render();
            }, console.error);
            
             // 5. Warehouses
            onSnapshot(collection(App.db, App.getCollectionPath('warehouses')), (snapshot) => {
                App.data.warehouses = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // إعادة عرض صفحات المنتجات والإعدادات التي تعتمد على المخازن
                if (['products', 'general_settings', 'new_invoice'].includes(App.view)) render();
            }, console.error);
        }
        
        // ====================================================================
        //                      Inventory and Alerts Unit (UPDATED)
        // ====================================================================

        /**
         * دالة التحقق من تنبيهات نقص المخزون (تشمل المخزن الرئيسي والبضاعة المعروضة)
         */
        function checkLowStockAlerts() {
            const lowStockProducts = App.data.products.filter(p => {
                // NEW: check combined stock (stock + displayed_stock)
                const totalStock = (p.stock || 0) + (p.displayed_stock || 0); 
                return totalStock <= (p.lowStockThreshold || 10);
            });
            
            const alertsContainer = document.getElementById('alerts-container');
            const alertsContainerFull = document.getElementById('alerts-container-full');
            
            const alertHTML = lowStockProducts.length > 0
                ? lowStockProducts.map(p => 
                    `<div class="p-3 mb-2 bg-red-100 text-red-700 rounded-lg shadow-sm flex justify-between items-center text-sm border-r-4 border-red-500">
                        <i data-lucide="alert-triangle" class="w-4 h-4 ml-2"></i>
                        <p>الصنف **${p.name}** منخفض. الكمية الإجمالية: **${(p.stock || 0) + (p.displayed_stock || 0)}**</p>
                    </div>`
                ).join('')
                : `<p class="text-gray-500 text-sm p-4 text-center">لا توجد تنبيهات نقص مخزون حالياً.</p>`;
                
            if (alertsContainer) alertsContainer.innerHTML = alertHTML;
            if (alertsContainerFull) alertsContainerFull.innerHTML = alertHTML;
            lucide.createIcons();
        }

        // ====================================================================
        //                      Inventory and Transfer Unit (NEW)
        // ====================================================================

        /**
         * دالة تحويل البضاعة من المخزن (stock) إلى المعروضة (displayed_stock)
         * (اضافه بضاعه من المخزن)
         * @param {string} productId - معرف الصنف
         * @param {number} quantity - الكمية المراد تحويلها
         */
        window.handleTransferToDisplayed = async (productId, quantity) => {
            const product = App.data.products.find(p => p.id === productId);

            if (!product) {
                alertUser("الصنف غير موجود.", "error");
                return;
            }
            
            const currentStock = product.stock || 0;
            const currentDisplayedStock = product.displayed_stock || 0;

            if (quantity <= 0 || quantity > currentStock) {
                alertUser(`كمية النقل غير صالحة. المخزون المتاح في المخزن هو ${currentStock}.`, "error");
                return;
            }

            try {
                const productRef = doc(App.db, App.getCollectionPath('products'), productId);
                await updateDoc(productRef, {
                    stock: currentStock - quantity, // خصم من المخزن
                    displayed_stock: currentDisplayedStock + quantity // إضافة إلى المعروضة
                });
                alertUser(`تم تحويل ${quantity} وحدة من **${product.name}** من المخزن إلى البضاعة المعروضة بنجاح.`, "success");
            } catch (error) {
                console.error("Transfer error:", error);
                alertUser("فشل في عملية التحويل. " + error.message, "error");
            }
        };

        /**
         * دالة إضافة بضاعة جديدة للمخزن (Stock Inward)
         * (اما المخزن ممكن اضيف ليهو اصناف كمان)
         * @param {string} productId - معرف الصنف
         * @param {number} quantity - الكمية المراد إضافتها
         */
        window.handleAddStockToWarehouse = async (productId, quantity) => {
            const product = App.data.products.find(p => p.id === productId);

            if (!product) {
                alertUser("الصنف غير موجود.", "error");
                return;
            }

            if (quantity <= 0) {
                alertUser("كمية الإضافة يجب أن تكون أكبر من صفر.", "error");
                return;
            }

            try {
                const productRef = doc(App.db, App.getCollectionPath('products'), productId);
                
                await updateDoc(productRef, {
                    stock: (product.stock || 0) + quantity // إضافة إلى المخزن
                });
                alertUser(`تمت إضافة ${quantity} وحدة جديدة من **${product.name}** إلى المخزن بنجاح.`, "success");
            } catch (error) {
                console.error("Add stock error:", error);
                alertUser("فشل في عملية إضافة المخزون. " + error.message, "error");
            }
        };


        /**
         * دالة إضافة بضاعة (مباشرة) للبضاعة المعروضة (Displayed Stock Inward)
         * (اضافه بضاعه معروضة حاليا)
         * @param {string} productId - معرف الصنف
         * @param {number} quantity - الكمية المراد إضافتها
         */
        window.handleAddDisplayedStock = async (productId, quantity) => {
            const product = App.data.products.find(p => p.id === productId);

            if (!product) {
                alertUser("الصنف غير موجود.", "error");
                return;
            }

            if (quantity <= 0) {
                alertUser("كمية الإضافة يجب أن تكون أكبر من صفر.", "error");
                return;
            }

            try {
                const productRef = doc(App.db, App.getCollectionPath('products'), productId);
                
                await updateDoc(productRef, {
                    displayed_stock: (product.displayed_stock || 0) + quantity // إضافة مباشرة إلى البضاعة المعروضة
                });
                alertUser(`تمت إضافة ${quantity} وحدة من **${product.name}** مباشرة إلى البضاعة المعروضة بنجاح.`, "success");
            } catch (error) {
                console.error("Add displayed stock error:", error);
                alertUser("فشل في عملية إضافة البضاعة المعروضة. " + error.message, "error");
            }
        };
        
        /**
         * لفتح النافذة المنبثقة لإدارة المخزون
         */
        window.openStockManagementModal = (productId) => {
            const product = App.data.products.find(p => p.id === productId);
            if (!product) return;
            
            // Remove any existing modal for this product to ensure fresh state
            document.getElementById('stock-modal-' + product.id)?.remove();
            
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = StockManagementModal(product);
            document.body.appendChild(tempDiv.firstChild);

            // Show the modal and initialize lucide icons
            document.getElementById('stock-modal-' + product.id).classList.remove('hidden');
            lucide.createIcons();
        };

        
        // ====================================================================
        //                      Smart Assistant Unit (Gemini API Integration)       
        // = ====================================================================

        window.toggleAssistant = () => {
            const container = document.getElementById('smart-assistant-container');
            container.style.display = container.style.display === 'none' ? 'flex' : 'none'; // Changed to flex for better layout
        };
        
        window.sendAssistantQuery = async () => {
            const input = document.getElementById('chat-input');
            const query = input.value.trim();
            if (!query) return;

            const chatBody = document.getElementById('chat-body');
            // User message
            chatBody.insertAdjacentHTML('afterbegin', `
                <div class="flex justify-start mb-2">
                    <div class="max-w-xs p-3 rounded-xl chat-message-user shadow-md">${query}</div>
                </div>
            `);
            input.value = '';
            
            // Typing indicator
            chatBody.insertAdjacentHTML('afterbegin', `
                <div id="ai-typing-indicator" class="flex justify-end mb-2">
                    <div class="max-w-xs p-3 rounded-xl chat-message-ai shadow-md">... جاري التفكير</div>
                </div>
            `);
            
            const typingIndicator = document.getElementById('ai-typing-indicator');

            // Prepare the model context (System Prompt)
            // Updated product list to include displayed_stock
            const productList = App.data.products.map(p => `ID:${p.id}, Name:${p.name}, Stock:${(p.stock || 0)}, DisplayedStock:${(p.displayed_stock || 0)}, Price:${p.price}, Warehouse:${p.warehouse}, Threshold:${p.lowStockThreshold}`).join('; ');
            const customerList = App.data.customers.map(c => `Name:${c.name}, Distinguished:${c.isDistinguished}, Spent:${c.totalSpent || 0}`).join('; ');

            const systemPrompt = `
                أنت المساعد الذكي لشركة SHAHRAZAD ELECTRIC. مهمتك هي الإجابة على استفسارات المستخدمين باللغة العربية بناءً على البيانات المقدمة.
                - اعتمد على البيانات التالية لتكون إجاباتك دقيقة ومرتبطة ببيانات المخزون والمبيعات.
                - يجب أن تكون الإجابات مهنية وموجزة.

                **بيانات النظام الحالية:**
                - المنتجات والمخزون: [${productList}]
                - العملاء وإجمالي الإنفاق: [${customerList}]
            `;
            
            // NOTE: apiKey MUST be empty string as per environment rules.
            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{ parts: [{ text: query }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            try {
                let resultText = "عذراً، لم أتمكن من الحصول على استجابة.";
                let apiSuccess = false;
                
                // --- START Exponential Backoff Retry Logic (To ensure API Key injection) ---
                for (let attempt = 0; attempt < 3; attempt++) {
                    const response = await fetch(apiUrl, { 
                        method: 'POST', 
                        headers: { 'Content-Type': 'application/json' }, 
                        body: JSON.stringify(payload) 
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        resultText = result.candidates?.[0]?.content?.parts?.[0]?.text || resultText;
                        apiSuccess = true;
                        break; 
                    } 
                    
                    if (response.status === 429) { 
                        // Too Many Requests - Retry with backoff
                        await new Promise(resolve => setTimeout(resolve, Math.pow(2, attempt) * 1000));
                        continue;
                    } else if (response.status === 403 && attempt < 2) {
                        // 403 Forbidden is the typical error when the key is missing. Retry for key injection.
                         await new Promise(resolve => setTimeout(resolve, Math.pow(2, attempt) * 1000));
                         continue;
                    } else { 
                        // Critical error or last 403 failed, break and trigger MOCKING
                        throw new Error(`API error: ${response.status} - Critical failure.`);
                    }
                }
                
                if (!apiSuccess) {
                     // If loop finished without success (e.g., all 403 retries failed), trigger MOCKING.
                     throw new Error("All API attempts failed, falling to mocking.");
                }
                
                // --- END Exponential Backoff Retry Logic ---

                // Remove typing indicator and add AI response
                typingIndicator.remove();
                chatBody.insertAdjacentHTML('afterbegin', `
                    <div class="flex justify-end mb-2">
                        <div class="max-w-xs p-3 rounded-xl chat-message-ai shadow-md">${resultText}</div>
                    </div>
                `);
                
            } catch (error) {
                console.error("Gemini API connection failed, falling back to Mocking Logic:", error);

                // =========================================================
                // START MOCKING LOGIC (Fallback for connection errors)
                // =========================================================
                
                let mockResultText = `
                    <p class="font-bold text-red-600 mb-2">⚠️ **خطأ في الاتصال بالذكاء الاصطناعي.** نظراً لمشكلة في الاتصال (قد تكون بسبب حقن المفتاح)، سأقوم بالرد آلياً الآن اعتماداً على بيانات Firestore المحلية:</p>
                `;

                const lowerQuery = query.toLowerCase();
                
                if (lowerQuery.includes('مخزون') || lowerQuery.includes('نقص') || lowerQuery.includes('منخفض') || lowerQuery.includes('مخزن')) {
                     const lowStockItems = App.data.products.filter(p => ((p.stock || 0) + (p.displayed_stock || 0)) <= (p.lowStockThreshold || 10));
                    
                    if (lowStockItems.length > 0) {
                        mockResultText += `<p>هناك **${lowStockItems.length} صنف** يعاني من نقص في المخزون (أقل من ${lowStockItems[0].lowStockThreshold || 10}):</p>`;
                        lowStockItems.slice(0, 3).forEach(item => { // Show top 3
                            const totalStock = (item.stock || 0) + (item.displayed_stock || 0);
                            mockResultText += `<p class="mt-1 pr-3 border-r-4 border-red-500">**${item.name}**: الكمية الإجمالية ${totalStock} (المعروضة: ${item.displayed_stock || 0}).</p>`;
                        });
                    } else {
                        mockResultText += `<p>**المخزون:** جميع الأصناف تبدو جيدة ولا توجد تنبيهات نقص مخزون حالياً.</p>`;
                    }
                } else if (lowerQuery.includes('عميل') || lowerQuery.includes('مميز') || lowerQuery.includes('vip')) {
                    const distinguishedCount = App.data.customers.filter(c => c.isDistinguished).length;
                    const totalCustomers = App.data.customers.length;
                    mockResultText += `<p>**العملاء:** لدينا **${distinguishedCount} عميل مميز (VIP)** من أصل ${totalCustomers} عميل مسجل في النظام.</p>`;
                } else if (lowerQuery.includes('سعر') || lowerQuery.includes('أغلى')) {
                    const mostExpensive = App.data.products.sort((a, b) => b.price - a.price)[0];
                    if (mostExpensive) {
                        mockResultText += `<p>**معلومات السعر:** أغلى صنف مسجل هو **${mostExpensive.name}** بسعر ${mostExpensive.price.toFixed(2)} جنيه سوداني.</p>`;
                    } else {
                        mockResultText += `<p>**معلومات السعر:** لا توجد أصناف مسجلة لحساب السعر.</p>`;
                    }
                } else {
                    mockResultText += `<p>**رسالة عامة:** أنا مستعد لمساعدتك في استعراض بيانات SHAHRAZAD ELECTRIC. يمكنك سؤالي عن "نقص المخزون"، "العملاء المميزون"، أو "سعر صنف معين".</p>`;
                }
                // =========================================================
                // END MOCKING LOGIC
                // =========================================================

                typingIndicator.remove();
                chatBody.insertAdjacentHTML('afterbegin', `
                    <div class="flex justify-end mb-2">
                        <div class="max-w-xs p-3 rounded-xl chat-message-ai shadow-md">${mockResultText}</div>
                    </div>
                `);
            }
        };

        // ====================================================================
        //                      Invoice Management Unit (UPDATED)
        // ====================================================================

        // Helper to calculate totals based on items in App.data.draftInvoice.items
        window.calculateInvoiceTotals = () => {
            let subTotal = 0;
            let totalDiscount = 0;

            App.data.draftInvoice.items.forEach(item => {
                const itemTotalBeforeDiscount = item.quantity * item.unitPrice;
                const discountAmount = itemTotalBeforeDiscount * (item.discount / 100);
                const itemTotal = itemTotalBeforeDiscount - discountAmount;

                item.total = itemTotal.toFixed(2); // Store item total
                subTotal += itemTotalBeforeDiscount;
                totalDiscount += discountAmount;
            });

            App.data.draftInvoice.subTotal = subTotal.toFixed(2);
            App.data.draftInvoice.totalDiscount = totalDiscount.toFixed(2);
            App.data.draftInvoice.grandTotal = (subTotal - totalDiscount).toFixed(2);
        };
        
        // Handles adding a new item row to the draft invoice
        window.handleAddItem = () => {
            const selectElement = document.getElementById('product-select');
            const quantityElement = document.getElementById('item-quantity');
            const priceElement = document.getElementById('item-price');
            const discountElement = document.getElementById('item-discount');

            const productId = selectElement.value;
            const quantity = parseInt(quantityElement.value);
            const unitPrice = parseFloat(priceElement.value);
            const discount = parseFloat(discountElement.value) || 0;

            if (!productId || quantity <= 0 || unitPrice <= 0) {
                alertUser("يرجى اختيار صنف وإدخال كمية وسعر صالحين.", "error");
                return;
            }
            
            const productData = App.data.products.find(p => p.id === productId);
            if (!productData) return;

            // NEW: Check displayed_stock instead of main stock
            const availableStock = productData.displayed_stock !== undefined ? productData.displayed_stock : productData.stock;
            if (availableStock < quantity) {
                 alertUser(`المخزون المتوفر من **${productData.name}** (البضاعة المعروضة) هو ${availableStock} فقط.`, "error");
                 return;
            }
            
            // Prevent duplicate product in the draft (or update quantity)
            const existingItemIndex = App.data.draftInvoice.items.findIndex(item => item.productId === productId);

            const newItem = {
                productId: productId,
                productName: productData.name,
                quantity: quantity,
                unitPrice: unitPrice,
                discount: discount,
                total: 0, // Will be calculated
            };

            if (existingItemIndex > -1) {
                // For simplicity, we just add the quantity to the existing one for now
                App.data.draftInvoice.items[existingItemIndex].quantity += quantity;
            } else {
                App.data.draftInvoice.items.push(newItem);
            }
            
            calculateInvoiceTotals();
            render(); 

            // Clear inputs and reset price to selected product's default
            quantityElement.value = 1;
            discountElement.value = 0;
            selectElement.value = "";
            priceElement.value = 0;
        };

        // Removes an item from the draft invoice
        window.handleRemoveItem = (index) => {
            App.data.draftInvoice.items.splice(index, 1);
            calculateInvoiceTotals();
            render();
        };

        // Function to find customer by name or create a new one
        async function findOrCreateCustomer(customerName) {
            const existingCustomer = App.data.customers.find(c => c.name === customerName);
            if (existingCustomer) {
                return existingCustomer.id;
            }

            // Create new customer
            const newCustomerRef = doc(collection(App.db, App.getCollectionPath('customers')));
            await setDoc(newCustomerRef, {
                name: customerName,
                phone: '', 
                email: '',
                totalSpent: 0,
                isDistinguished: false,
                createdAt: new Date().toISOString(),
            });
            return newCustomerRef.id;
        }

        /**
         * UPDATED: Function to update stock quantities using a batch write.
         * Now deducts from 'displayed_stock'.
         */
        async function updateProductStockBatch(items, batch) {
            for (const item of items) {
                const product = App.data.products.find(p => p.id === item.productId);
                
                // Check displayed_stock first, fall back to general stock if not defined
                const availableStock = product.displayed_stock !== undefined ? product.displayed_stock : product.stock; 
                
                if (product && availableStock >= item.quantity) {
                    const productRef = doc(App.db, App.getCollectionPath('products'), item.productId);
                    
                    if (product.displayed_stock !== undefined) {
                         const newDisplayedStock = availableStock - item.quantity;
                         // Deduction from displayed_stock (البضاعة المعروضة)
                         batch.update(productRef, { displayed_stock: newDisplayedStock }); 
                    } else {
                         // Fallback: Deduct from old 'stock' field (for legacy data)
                         const newStock = product.stock - item.quantity;
                         batch.update(productRef, { stock: newStock });
                    }
                } else {
                    // This error will rollback the entire batch
                    throw new Error(`Quantity requested for product ${item.productName} is more than available stock (${availableStock} available).`);
                }
            }
        }

        // Main function to process and save the new invoice
        window.handleNewInvoice = async (e) => {
            e.preventDefault();
            const form = document.getElementById('new-invoice-form');
            const customerName = form.querySelector('#customer-name').value.trim();
            const invoiceItems = App.data.draftInvoice.items;
            const totalAmount = parseFloat(App.data.draftInvoice.grandTotal);
            const notes = form.querySelector('#invoice-notes').value.trim();

            if (!customerName) {
                alertUser("يرجى إدخال اسم العميل.", "error");
                return;
            }
            if (invoiceItems.length === 0) {
                alertUser("يجب إضافة صنف واحد على الأقل للفاتورة.", "error");
                return;
            }

            const saveBtn = document.getElementById('save-invoice-btn');
            saveBtn.disabled = true;
            saveBtn.innerHTML = `<i data-lucide="loader-circle" class="w-5 h-5 ml-2 inline animate-spin"></i> جاري الحفظ...`;
            lucide.createIcons();

            try {
                // 1. Find or create the customer
                const customerId = await findOrCreateCustomer(customerName);

                // 2. Prepare Firestore Batch
                const batch = writeBatch(App.db);
                await updateProductStockBatch(invoiceItems, batch); // Decrement stock (now from displayed_stock)

                // 3. Save Invoice
                const invoiceRef = doc(collection(App.db, App.getCollectionPath('invoices')));
                const newInvoiceData = {
                    invoiceNumber: App.data.invoices.length + 1, // Simple sequential number (for display)
                    customerId: customerId,
                    customerName: customerName,
                    items: invoiceItems.map(item => ({
                        name: item.productName,
                        quantity: item.quantity,
                        unitPrice: item.unitPrice,
                        discount: item.discount,
                        total: item.total
                    })),
                    subTotal: App.data.draftInvoice.subTotal,
                    totalDiscount: App.data.draftInvoice.totalDiscount,
                    grandTotal: totalAmount,
                    notes: notes,
                    date: new Date().toISOString(),
                    createdBy: App.userId,
                };

                batch.set(invoiceRef, newInvoiceData);

                // 4. Commit Batch (updates stock and saves invoice)
                await batch.commit();

                alertUser(`تم إنشاء الفاتورة رقم ${newInvoiceData.invoiceNumber} بنجاح وتحديث المخزون.`, "success");
                
                // Navigate to the print view and clear draft
                App.currentInvoiceForView = { id: invoiceRef.id, ...newInvoiceData };
                App.data.draftInvoice = { items: [], subTotal: 0, totalDiscount: 0, grandTotal: 0 }; 
                App.view = 'invoice_details';
                render();

            } catch (error) {
                console.error("Invoice creation failed:", error);
                alertUser(`فشل إنشاء الفاتورة: ${error.message}`, "error");
            } finally {
                saveBtn.disabled = false;
                saveBtn.innerHTML = `<i data-lucide="save" class="w-5 h-5 ml-2 inline"></i> حفظ وإصدار الفاتورة`;
                lucide.createIcons();
            }
        };

        // Function to trigger printing (PDF download via browser)
        window.generateInvoicePDF = () => {
            // Hide unnecessary elements before printing/PDF generation
            const sidebar = document.getElementById('sidebar');
            const header = document.getElementById('header-bar');
            const assistant = document.getElementById('smart-assistant-container');
            
            if (sidebar) sidebar.style.display = 'none';
            if (header) header.style.display = 'none';
            if (assistant) assistant.style.display = 'none';
            
            // Use the browser's print function to generate a PDF or print directly
            window.print();
            
            // Restore the layout after printing is done (or immediately if print dialog is modal)
            setTimeout(() => {
                if (sidebar) sidebar.style.display = 'block';
                if (header) header.style.display = 'flex';
                if (assistant) assistant.style.display = 'none'; 
                // Return to the main invoices view after print attempt
                navigateTo('invoices');
            }, 500); 
        };
        
        window.onProductSelectChange = () => {
             const selectElement = document.getElementById('product-select');
             const priceElement = document.getElementById('item-price');
             const productId = selectElement.value;
             const productData = App.data.products.find(p => p.id === productId);

             if (productData) {
                 priceElement.value = productData.price;
                 document.getElementById('item-quantity').focus();
             } else {
                 priceElement.value = 0;
             }
        }

        
        // ====================================================================
        //                      Utility Unit (UI & Utils)
        // ====================================================================

        function alertUser(message, type) {
            // Custom message box instead of alert()
            const alertBox = document.getElementById('global-alert');
            alertBox.innerText = message;
            alertBox.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-xl text-white transition-all duration-300 transform ${type === 'success' ? 'bg-green-600' : 'bg-red-600'} translate-y-0 opacity-100`;
            setTimeout(() => {
                alertBox.className += ' -translate-y-20 opacity-0';
            }, 5000);
        }
        
        window.navigateTo = (viewName, data = null) => {
            App.view = viewName;
            if (viewName === 'invoice_details') {
                // If navigating to an existing invoice detail view
                 App.currentInvoiceForView = data;
            } else if (viewName === 'new_invoice') {
                // Initialize draft for new invoice
                App.data.draftInvoice = { items: [], subTotal: 0, totalDiscount: 0, grandTotal: 0 };
            }
            render();
        };

        /** Data Backup and Download **/ 
        window.backupData = async () => {
            const collectionsToBackup = ['products', 'customers', 'invoices', 'users', 'alerts', 'warehouses'];
            const backup = {};
            document.getElementById('backup-btn').innerText = 'جارٍ التجهيز...';
            try {
                for (const colName of collectionsToBackup) {
                    const colPath = App.getCollectionPath(colName);
                    const q = query(collection(App.db, colPath));
                    const snapshot = await getDocs(q);
                    backup[colName] = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                }
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(backup, null, 2));
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", `SHAHRAZAD_backup_${new Date().toISOString().slice(0, 10)}.json`);
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
                alertUser("تم إنشاء النسخة الاحتياطية بنجاح وتنزيل الملف.", "success");
            } catch (error) {
                console.error("Backup failed:", error);
                alertUser(`فشل النسخ الاحتياطي: ${error.message}`, "error");
            } finally {
                document.getElementById('backup-btn').innerText = 'تنزيل نسخة احتياطية';
            }
        };

        // ====================================================================
        //                      View Rendering Unit (HTML Templates)
        // ====================================================================
        
        /** General Layout **/
        const MainLayout = () => `
            <div class="flex h-screen bg-gray-100">
                ${Sidebar()}
                <div class="flex-1 flex flex-col overflow-hidden">
                    ${HeaderBar()}
                    <main class="flex-1 overflow-x-hidden overflow-y-auto p-4 md:p-6">
                        ${App.views[App.view]()}
                    </main>
                    ${SmartAssistantContainer()}
                </div>
            </div>
        `;

        const Sidebar = () => `
            <div id="sidebar" class="w-64 bg-shahrazad text-white space-y-6 py-7 px-2 absolute inset-y-0 right-0 transform translate-x-full md:relative md:translate-x-0 transition duration-200 ease-in-out z-30 shadow-2xl">
                <div class="flex items-center px-4">
                    <i data-lucide="battery-charging" class="w-8 h-8 text-yellow-400"></i>
                    <span class="text-2xl font-black mr-2 tracking-wider">SHAHRAZAD</span>
                </div>
                
                <nav>
                    ${SidebarLink('dashboard', 'الرئيسية', 'home')}
                    ${SidebarLink('products', 'إدارة الأصناف والمخزون', 'box')}
                    ${SidebarLink('invoices', 'إدارة الفواتير', 'receipt')}
                    ${SidebarLink('customers', 'إدارة العملاء', 'users')}
                    ${SidebarLink('alerts', 'تنبيهات المخزون', 'alert-triangle')}
                    <div class="pt-4 border-t border-white border-opacity-20 mt-4"></div>
                    ${SidebarLink('user_settings', 'إدارة المستخدمين', 'lock', App.userRole === 'admin' ? '' : 'hidden')}
                    ${SidebarLink('general_settings', 'إعدادات عامة', 'settings')}
                </nav>

                <div class="absolute bottom-4 w-full px-4">
                    <button onclick="handleLogout()" class="w-full flex items-center p-3 text-red-100 hover:bg-red-700 rounded-lg transition duration-200">
                        <i data-lucide="log-out" class="w-5 h-5 ml-3"></i>
                        تسجيل الخروج
                    </button>
                </div>
            </div>
        `;
        
        const SidebarLink = (viewName, title, icon, classes = '') => `
            <button onclick="navigateTo('${viewName}')" class="w-full flex items-center p-3 text-white hover:bg-white hover:bg-opacity-10 rounded-lg transition duration-200 ${App.view === viewName ? 'bg-white bg-opacity-20 shadow-md' : ''} ${classes}">
                <i data-lucide="${icon}" class="w-5 h-5 ml-3"></i>
                <span>${title}</span>
            </button>
        `;

        const HeaderBar = () => `
            <header id="header-bar" class="flex items-center justify-between px-6 py-4 bg-white border-b border-gray-200 shadow-sm">
                <h1 class="text-xl font-semibold text-gray-800">${getPageViewTitle()}</h1>
                <div class="flex items-center">
                    <button onclick="toggleAssistant()" class="p-2 ml-3 text-gray-500 hover:text-shahrazad transition duration-150">
                        <i data-lucide="sparkles" class="w-6 h-6"></i>
                    </button>
                    <span class="text-sm font-medium text-shahrazad ml-3">${App.data.users.find(u => u.uid === App.userId)?.name || App.userRole}</span>
                    <i data-lucide="circle-user" class="w-7 h-7 text-gray-500"></i>
                </div>
            </header>
        `;

        const SmartAssistantContainer = () => `
            <div id="smart-assistant-container" class="hidden fixed bottom-4 right-4 w-80 h-auto bg-white rounded-xl shadow-2xl z-40 flex-col transition duration-300">
                <div class="p-3 bg-shahrazad text-white rounded-t-xl flex justify-between items-center">
                    <span class="font-bold">المساعد الذكي (AI)</span>
                    <button onclick="toggleAssistant()" class="p-1 hover:bg-white hover:bg-opacity-20 rounded-full">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
                <div id="chat-body" class="p-3 space-y-2 flex-grow">
                    <div class="flex justify-end mb-2">
                        <div class="max-w-xs p-3 rounded-xl chat-message-ai shadow-md">
                            ${myAssistant.generateGreeting(App.data.users.find(u => u.uid === App.userId)?.name)}
                        </div>
                    </div>
                </div>
                <div class="p-3 border-t">
                    <div class="flex items-center">
                        <input type="text" id="chat-input" placeholder="اكتب استفسارك..." class="flex-grow p-2 border border-gray-300 rounded-lg focus:ring-shahrazad focus:border-shahrazad text-sm" onkeydown="if(event.key === 'Enter') sendAssistantQuery()">
                        <button onclick="sendAssistantQuery()" class="mr-2 p-2 bg-shahrazad text-white rounded-lg hover:bg-blue-700 transition duration-150">
                            <i data-lucide="send" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;

        function getPageViewTitle() {
            const titles = {
                'loading': 'جاري التحميل...',
                'login': 'تسجيل الدخول',
                'dashboard': 'لوحة التحكم الرئيسية',
                'products': 'إدارة الأصناف والمخزون',
                'invoices': 'إدارة الفواتير',
                'new_invoice': 'إنشاء فاتورة مبيعات جديدة',
                'invoice_details': 'معاينة الفاتورة',
                'customers': 'إدارة العملاء',
                'alerts': 'تنبيهات نقص المخزون',
                'general_settings': 'إعدادات عامة',
                'user_settings': 'إدارة المستخدمين',
                'auth_error': 'خطأ في المصادقة',
            };
            return titles[App.view] || 'نظام SHAHRAZAD ELECTRIC';
        }

        /** View Implementations **/
        // --- 1. Loading View ---
        const LoadingView = () => `
            <div class="flex flex-col items-center justify-center h-full">
                <i data-lucide="loader-circle" class="w-12 h-12 text-shahrazad animate-spin"></i>
                <p class="mt-4 text-gray-600">جاري تحميل البيانات...</p>
            </div>
        `;

        // --- 2. Auth Error View ---
        const AuthErrorView = () => `
            <div class="flex flex-col items-center justify-center h-full bg-red-100 rounded-xl p-8 card">
                <i data-lucide="alert-octagon" class="w-12 h-12 text-red-600"></i>
                <h2 class="mt-4 text-2xl font-bold text-red-800">خطأ حرج في المصادقة</h2>
                <p class="mt-2 text-gray-700 text-center">حدث خطأ أثناء محاولة الاتصال بـ Firebase Auth. يرجى التأكد من إعدادات Firebase وتفعيل طريقة المصادقة المناسبة.</p>
                <button onclick="window.location.reload()" class="mt-6 bg-red-600 text-white p-3 rounded-lg hover:bg-red-700 transition duration-150">إعادة المحاولة</button>
            </div>
        `;

        // --- 3. Login View ---
        const LoginView = () => `
            <div class="flex items-center justify-center h-screen bg-gray-100">
                <div class="w-full max-w-md p-8 space-y-6 card">
                    <div class="flex flex-col items-center">
                        <i data-lucide="battery-charging" class="w-10 h-10 text-shahrazad"></i>
                        <h2 class="mt-3 text-3xl font-bold text-gray-900">نظام SHAHRAZAD ELECTRIC</h2>
                        <p class="mt-2 text-sm text-gray-500">الرجاء تسجيل الدخول للمتابعة</p>
                    </div>
                    <form class="space-y-6" onsubmit="handleLoginSubmit(event)">
                        <div>
                            <label for="login-email" class="block text-sm font-medium text-gray-700">البريد الإلكتروني</label>
                            <div class="mt-1">
                                <input id="login-email" name="email" type="email" autocomplete="email" required class="appearance-none block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-shahrazad focus:border-shahrazad sm:text-sm">
                            </div>
                        </div>
                        <div>
                            <label for="login-password" class="block text-sm font-medium text-gray-700">كلمة المرور</label>
                            <div class="mt-1">
                                <input id="login-password" name="password" type="password" autocomplete="current-password" required class="appearance-none block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-shahrazad focus:border-shahrazad sm:text-sm">
                            </div>
                        </div>
                        <div>
                            <button id="login-btn" type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-shahrazad hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-shahrazad transition duration-150">
                                <i data-lucide="log-in" class="w-5 h-5 ml-2 inline"></i> تسجيل الدخول
                            </button>
                        </div>
                    </form>
                    <div class="pt-4 border-t text-center">
                        <p class="text-xs text-gray-400">للدخول السريع في وضع الاختبار: بريد 'test'، كلمة مرور 'test'.</p>
                    </div>
                </div>
            </div>
        `;

        // --- 4. Dashboard View (Simplified) ---
        const DashboardView = () => {
            const totalProducts = App.data.products.length;
            const totalInvoices = App.data.invoices.length;
            const totalCustomers = App.data.customers.length;
            const lowStockCount = App.data.products.filter(p => ((p.stock || 0) + (p.displayed_stock || 0)) <= (p.lowStockThreshold || 10)).length;
            
            const totalSalesValue = App.data.invoices.reduce((sum, inv) => sum + parseFloat(inv.grandTotal || 0), 0);
            
            // Placeholder for Chart.js
            setTimeout(() => {
                const ctx = document.getElementById('salesChart')?.getContext('2d');
                if (ctx) {
                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: ['يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو'],
                            datasets: [{
                                label: 'إجمالي المبيعات (ألف ج.س)',
                                data: [120, 190, 300, 500, 200, 300], // Mock Data
                                borderColor: '#004d99',
                                backgroundColor: 'rgba(0, 77, 153, 0.1)',
                                tension: 0.4,
                                fill: true,
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: { display: false }
                            },
                            scales: {
                                y: { beginAtZero: true }
                            }
                        }
                    });
                }
            }, 100);

            return `
                <div class="space-y-6">
                    <h2 class="text-2xl font-bold text-gray-800">مرحباً بعودتك، ${App.data.users.find(u => u.uid === App.userId)?.name || App.userRole}!</h2>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                        ${StatCard('إجمالي الأصناف', totalProducts, 'box', 'text-shahrazad')}
                        ${StatCard('إجمالي العملاء', totalCustomers, 'users', 'text-green-500')}
                        ${StatCard('الفواتير الصادرة', totalInvoices, 'receipt', 'text-yellow-500')}
                        ${StatCard('قيمة المبيعات الإجمالية', `${totalSalesValue.toFixed(2)} ج.س`, 'banknote', 'text-red-500')}
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="card p-6 md:col-span-2">
                            <h3 class="text-lg font-semibold text-gray-700 mb-4 border-b pb-2 flex items-center">
                                <i data-lucide="line-chart" class="w-5 h-5 ml-2"></i>
                                أداء المبيعات (الشهور الستة الماضية)
                            </h3>
                            <canvas id="salesChart" class="h-64 w-full"></canvas>
                        </div>
                        
                        <div class="card p-6">
                            <h3 class="text-lg font-semibold text-gray-700 mb-4 border-b pb-2 flex items-center">
                                <i data-lucide="alert-triangle" class="w-5 h-5 ml-2 text-red-600"></i>
                                تنبيهات المخزون (${lowStockCount})
                            </h3>
                            <div id="alerts-container" class="space-y-2">
                                </div>
                            <button onclick="navigateTo('alerts')" class="mt-4 w-full text-sm text-shahrazad hover:text-blue-700 transition duration-150">
                                عرض كل التنبيهات <i data-lucide="arrow-left" class="w-4 h-4 inline mr-1"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        };

        const StatCard = (title, value, icon, color) => `
            <div class="card p-5 flex items-center">
                <div class="p-3 bg-gray-100 rounded-full ${color}">
                    <i data-lucide="${icon}" class="w-6 h-6"></i>
                </div>
                <div class="mr-4">
                    <p class="text-sm text-gray-500">${title}</p>
                    <p class="text-xl font-bold text-gray-800">${value}</p>
                </div>
            </div>
        `;

        // --- 5. Products View (UPDATED) ---
        
        /**
         * NEW: Modal HTML template for Stock Management
         */
        const StockManagementModal = (product) => {
            // Ensure product has the new fields, initialize if missing
            const warehouseStock = product.stock || 0;
            const displayedStock = product.displayed_stock || 0;
            
            return `
                <div id="stock-modal-${product.id}" class="fixed inset-0 bg-gray-600 bg-opacity-50 z-50 hidden flex items-center justify-center">
                    <div class="bg-white p-6 rounded-lg shadow-2xl w-full max-w-lg card animate-in fade-in zoom-in">
                        <div class="flex justify-between items-center border-b pb-3 mb-4">
                            <h3 class="text-xl font-bold text-shahrazad">إدارة مخزون: ${product.name}</h3>
                            <button onclick="document.getElementById('stock-modal-${product.id}').classList.add('hidden')" class="text-gray-500 hover:text-gray-700">
                                <i data-lucide="x" class="w-6 h-6"></i>
                            </button>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4 text-center mb-6">
                            <div class="p-3 bg-blue-50 rounded-lg">
                                <p class="text-sm text-gray-600">المخزن (الرئيسي)</p>
                                <p class="text-2xl font-bold text-gray-800">${warehouseStock}</p>
                            </div>
                            <div class="p-3 bg-yellow-50 rounded-lg">
                                <p class="text-sm text-gray-600">البضاعة المعروضة</p>
                                <p class="text-2xl font-bold text-yellow-700">${displayedStock}</p>
                            </div>
                        </div>
                        
                        <div class="p-4 border border-blue-200 rounded-lg mb-4">
                            <h4 class="font-semibold text-shahrazad mb-2 flex items-center">
                                 <i data-lucide="arrow-left-right" class="w-4 h-4 ml-2"></i>
                                تحويل إلى البضاعة المعروضة (من المخزن)
                            </h4>
                            <p class="text-sm text-gray-600 mb-3">لنقل كمية من المخزن الرئيسي إلى المعروضة للبيع المباشر.</p>
                            <div class="flex space-x-2 rtl:space-x-reverse">
                                <input type="number" id="transfer-quantity-${product.id}" placeholder="كمية التحويل" min="1" max="${warehouseStock}" value="1" class="flex-grow p-2 border rounded-md text-sm">
                                <button onclick="handleTransferToDisplayed('${product.id}', parseInt(document.getElementById('transfer-quantity-${product.id}').value)); document.getElementById('stock-modal-${product.id}').classList.add('hidden');" class="bg-blue-600 text-white p-2 rounded-md hover:bg-blue-700 transition duration-150 flex items-center">
                                    <i data-lucide="corner-down-left" class="w-5 h-5 ml-1"></i> نقل
                                </button>
                            </div>
                        </div>

                        <div class="p-4 border border-yellow-200 rounded-lg mb-4">
                            <h4 class="font-semibold text-shahrazad mb-2 flex items-center">
                                 <i data-lucide="monitor" class="w-4 h-4 ml-2"></i>
                                إضافة بضاعة معروضة حالياً (مباشر)
                            </h4>
                            <p class="text-sm text-gray-600 mb-3">لإضافة كمية مباشرة إلى المعروضة (مثلاً بضاعة مرتجعة صالحة للعرض).</p>
                            <div class="flex space-x-2 rtl:space-x-reverse">
                                <input type="number" id="direct-displayed-quantity-${product.id}" placeholder="كمية الإضافة" min="1" value="1" class="flex-grow p-2 border rounded-md text-sm">
                                <button onclick="handleAddDisplayedStock('${product.id}', parseInt(document.getElementById('direct-displayed-quantity-${product.id}').value)); document.getElementById('stock-modal-${product.id}').classList.add('hidden');" class="bg-yellow-600 text-white p-2 rounded-md hover:bg-yellow-700 transition duration-150 flex items-center">
                                     <i data-lucide="plus" class="w-5 h-5 ml-1"></i> إضافة
                                </button>
                            </div>
                        </div>
                        
                        <div class="p-4 border border-green-200 rounded-lg">
                            <h4 class="font-semibold text-shahrazad mb-2 flex items-center">
                                 <i data-lucide="warehouse" class="w-4 h-4 ml-2"></i>
                                إضافة بضاعة إلى المخزن (استلام جديد)
                            </h4>
                            <p class="text-sm text-gray-600 mb-3">لاستلام بضاعة جديدة وإضافتها للمخزن الرئيسي.</p>
                            <div class="flex space-x-2 rtl:space-x-reverse">
                                <input type="number" id="warehouse-add-quantity-${product.id}" placeholder="كمية الإضافة" min="1" value="1" class="flex-grow p-2 border rounded-md text-sm">
                                <button onclick="handleAddStockToWarehouse('${product.id}', parseInt(document.getElementById('warehouse-add-quantity-${product.id}').value)); document.getElementById('stock-modal-${product.id}').classList.add('hidden');" class="bg-green-600 text-white p-2 rounded-md hover:bg-green-700 transition duration-150 flex items-center">
                                    <i data-lucide="package-plus" class="w-5 h-5 ml-1"></i> إضافة
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        };
        
        const ProductsView = () => {
            const products = App.data.products;
            
            // Sort products for display (e.g., by name)
            products.sort((a, b) => a.name.localeCompare(b.name, 'ar'));
            
            return `
                <div class="space-y-6">
                    <h2 class="text-2xl font-bold text-gray-800 border-b pb-2">إدارة الأصناف والمخزون</h2>
                    
                    <div class="flex justify-between items-center">
                        <div class="card p-4 flex-1 mr-4 rtl:ml-4 max-w-lg">
                            <form id="add-product-form" onsubmit="handleAddProduct(event)" class="space-y-3">
                                <h4 class="text-lg font-semibold text-shahrazad">إضافة صنف جديد</h4>
                                <div class="flex space-x-3 rtl:space-x-reverse">
                                    <input type="text" id="product-name" placeholder="اسم الصنف" required class="flex-1 p-2 border rounded-md focus:ring-shahrazad focus:border-shahrazad">
                                    <input type="number" id="product-price" placeholder="سعر البيع" min="0" step="0.01" required class="w-32 p-2 border rounded-md focus:ring-shahrazad focus:border-shahrazad">
                                </div>
                                <div class="flex space-x-3 rtl:space-x-reverse">
                                    <input type="number" id="product-stock" placeholder="كمية المخزن الأولية" min="0" value="1" required class="w-32 p-2 border rounded-md focus:ring-shahrazad focus:border-shahrazad">
                                    <input type="number" id="product-threshold" placeholder="حد النقص" min="1" value="10" class="w-32 p-2 border rounded-md focus:ring-shahrazad focus:border-shahrazad">
                                    <select id="product-warehouse" required class="flex-1 p-2 border rounded-md focus:ring-shahrazad focus:border-shahrazad">
                                        <option value="" disabled selected>اختر المخزن الافتراضي</option>
                                        ${App.data.warehouses.map(w => `<option value="${w.id}">${w.name}</option>`).join('')}
                                    </select>
                                </div>
                                <button type="submit" id="add-product-btn" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 transition duration-150">
                                    <i data-lucide="plus-circle" class="w-5 h-5 ml-2 inline"></i> إضافة الصنف
                                </button>
                            </form>
                        </div>

                        <div class="card p-4 w-60">
                            <h4 class="text-lg font-semibold text-gray-700 mb-2">إحصائيات الأصناف</h4>
                            <p class="text-3xl font-bold text-shahrazad">${products.length}</p>
                            <p class="text-sm text-gray-500">إجمالي الأصناف</p>
                            <p class="mt-2 text-md font-semibold text-red-600">
                                ${products.filter(p => ((p.stock || 0) + (p.displayed_stock || 0)) <= (p.lowStockThreshold || 10)).length} صنف منخفض
                            </p>
                        </div>
                    </div>

                    <div class="card p-6 overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead>
                                <tr>
                                    <th class="px-3 py-3 bg-gray-50 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">الاسم</th>
                                    <th class="px-3 py-3 bg-gray-50 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">السعر (ج.س)</th>
                                    <th class="px-3 py-3 bg-gray-50 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">المخزن (الرئيسي)</th>
                                    <th class="px-3 py-3 bg-gray-50 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">البضاعة المعروضة</th>
                                    <th class="px-3 py-3 bg-gray-50 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">إجمالي الكمية</th>
                                    <th class="px-3 py-3 bg-gray-50 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">المخزن الافتراضي</th>
                                    <th class="px-3 py-3 bg-gray-50 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">إجراءات</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${products.map(p => {
                                    const warehouse = App.data.warehouses.find(w => w.id === p.warehouse);
                                    const totalStock = (p.stock || 0) + (p.displayed_stock || 0); // Combined stock
                                    const isLowStock = totalStock <= (p.lowStockThreshold || 10);
                                    
                                    return `
                                        <tr class="${isLowStock ? 'bg-red-50 hover:bg-red-100' : 'hover:bg-gray-50'}">
                                            <td class="px-3 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${p.name}</td>
                                            <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500">${p.price.toFixed(2)}</td>
                                            <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-800 font-semibold">${p.stock || 0}</td>
                                            <td class="px-3 py-4 whitespace-nowrap text-sm text-yellow-700 font-bold">${p.displayed_stock || 0}</td>
                                            <td class="px-3 py-4 whitespace-nowrap text-sm ${isLowStock ? 'text-red-600 font-bold' : 'text-gray-500'}">${totalStock}</td>
                                            <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500">${warehouse ? warehouse.name : 'غير محدد'}</td>
                                            <td class="px-3 py-4 whitespace-nowrap text-left text-sm font-medium flex space-x-2 rtl:space-x-reverse">
                                                <button onclick="openStockManagementModal('${p.id}')" class="text-shahrazad hover:text-blue-700 p-2 rounded-full hover:bg-gray-100 transition duration-150" title="إدارة المخزون">
                                                    <i data-lucide="layers" class="w-5 h-5"></i>
                                                </button>
                                                <button onclick="handleDeleteProduct('${p.id}', '${p.name}')" class="text-red-600 hover:text-red-900 p-2 rounded-full hover:bg-gray-100 transition duration-150" title="حذف">
                                                    <i data-lucide="trash-2" class="w-5 h-5"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                        ${products.length === 0 ? '<p class="text-center text-gray-500 p-4">لا توجد أصناف مسجلة حالياً.</p>' : ''}
                    </div>
                </div>
            `;
        };

        // --- 6. New Invoice View ---
        const NewInvoiceView = () => {
            const products = App.data.products;
            const draftItems = App.data.draftInvoice.items;
            const draft = App.data.draftInvoice;

            return `
                <div class="space-y-6">
                    <h2 class="text-2xl font-bold text-gray-800 border-b pb-2">إنشاء فاتورة مبيعات جديدة</h2>
                    
                    <form id="new-invoice-form" onsubmit="handleNewInvoice(event)" class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        
                        <div class="lg:col-span-1 space-y-4">
                            <div class="card p-5 space-y-3">
                                <h3 class="text-lg font-semibold text-shahrazad flex items-center">
                                    <i data-lucide="user-check" class="w-5 h-5 ml-2"></i>
                                    بيانات العميل
                                </h3>
                                <input type="text" id="customer-name" placeholder="اسم العميل (مطلوب)" required class="w-full p-3 border rounded-md focus:ring-shahrazad focus:border-shahrazad">
                                <textarea id="invoice-notes" placeholder="ملاحظات الفاتورة (اختياري)" rows="3" class="w-full p-3 border rounded-md focus:ring-shahrazad focus:border-shahrazad"></textarea>
                            </div>

                            <div class="card p-5 space-y-3 bg-gray-50">
                                <h3 class="text-lg font-semibold text-shahrazad flex items-center">
                                    <i data-lucide="calculator" class="w-5 h-5 ml-2"></i>
                                    ملخص الفاتورة
                                </h3>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span>الإجمالي الفرعي:</span>
                                        <span class="font-medium">${draft.subTotal} ج.س</span>
                                    </div>
                                    <div class="flex justify-between text-red-600">
                                        <span>إجمالي الخصم:</span>
                                        <span class="font-medium">-${draft.totalDiscount} ج.س</span>
                                    </div>
                                    <div class="border-t pt-2 flex justify-between text-xl font-bold text-green-700">
                                        <span>المجموع الكلي:</span>
                                        <span>${draft.grandTotal} ج.س</span>
                                    </div>
                                </div>
                                <button type="submit" id="save-invoice-btn" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-600 transition duration-150">
                                    <i data-lucide="save" class="w-5 h-5 ml-2 inline"></i> حفظ وإصدار الفاتورة
                                </button>
                            </div>
                        </div>

                        <div class="lg:col-span-2 space-y-4">
                            <div class="card p-5 space-y-3">
                                <h3 class="text-lg font-semibold text-shahrazad flex items-center">
                                    <i data-lucide="package-plus" class="w-5 h-5 ml-2"></i>
                                    إضافة أصناف للفاتورة
                                </h3>
                                <div class="grid grid-cols-5 gap-3">
                                    <div class="col-span-2">
                                        <select id="product-select" onchange="onProductSelectChange()" class="w-full p-3 border rounded-md focus:ring-shahrazad focus:border-shahrazad">
                                            <option value="" disabled selected>اختر الصنف</option>
                                            ${products.map(p => {
                                                const availableStock = p.displayed_stock !== undefined ? p.displayed_stock : p.stock;
                                                return `<option value="${p.id}" ${availableStock <= 0 ? 'disabled' : ''}>${p.name} (متوفر: ${availableStock})</option>`;
                                            }).join('')}
                                        </select>
                                    </div>
                                    <div>
                                        <input type="number" id="item-quantity" placeholder="الكمية" min="1" value="1" required class="w-full p-3 border rounded-md focus:ring-shahrazad focus:border-shahrazad">
                                    </div>
                                    <div>
                                        <input type="number" id="item-price" placeholder="سعر الوحدة" min="0" step="0.01" value="0" required class="w-full p-3 border rounded-md focus:ring-shahrazad focus:border-shahrazad">
                                    </div>
                                    <div>
                                        <input type="number" id="item-discount" placeholder="الخصم (%)" min="0" max="100" value="0" class="w-full p-3 border rounded-md focus:ring-shahrazad focus:border-shahrazad">
                                    </div>
                                </div>
                                <button type="button" onclick="handleAddItem()" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-shahrazad hover:bg-blue-700 transition duration-150">
                                    <i data-lucide="plus" class="w-5 h-5 ml-2 inline"></i> أضف الصنف إلى القائمة
                                </button>
                            </div>

                            <div class="card p-5">
                                <h3 class="text-lg font-semibold text-gray-700 mb-3">قائمة أصناف الفاتورة (${draftItems.length} صنف)</h3>
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead>
                                            <tr>
                                                <th class="px-3 py-3 bg-gray-50 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">الصنف</th>
                                                <th class="px-3 py-3 bg-gray-50 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">الكمية</th>
                                                <th class="px-3 py-3 bg-gray-50 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">السعر/الوحدة</th>
                                                <th class="px-3 py-3 bg-gray-50 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">الخصم (%)</th>
                                                <th class="px-3 py-3 bg-gray-50 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">الإجمالي</th>
                                                <th class="px-3 py-3 bg-gray-50 text-right text-xs font-medium text-gray-500 uppercase tracking-wider"></th>
                                            </tr>
                                        </thead>
                                        <tbody class="bg-white divide-y divide-gray-200">
                                            ${draftItems.map((item, index) => `
                                                <tr class="hover:bg-gray-50">
                                                    <td class="px-3 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.productName}</td>
                                                    <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500">${item.quantity}</td>
                                                    <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500">${item.unitPrice.toFixed(2)}</td>
                                                    <td class="px-3 py-4 whitespace-nowrap text-sm text-red-500">${item.discount.toFixed(0)}%</td>
                                                    <td class="px-3 py-4 whitespace-nowrap text-sm font-bold text-gray-800">${item.total}</td>
                                                    <td class="px-3 py-4 whitespace-nowrap text-right text-sm font-medium">
                                                        <button type="button" onclick="handleRemoveItem(${index})" class="text-red-600 hover:text-red-900 p-1 rounded-full hover:bg-gray-100 transition duration-150">
                                                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                                                        </button>
                                                    </td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                    ${draftItems.length === 0 ? '<p class="text-center text-gray-500 p-4">الرجاء إضافة أصناف للفاتورة.</p>' : ''}
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            `;
        };

        // --- 7. Print Invoice View ---
        const PrintInvoiceView = () => {
             const invoice = App.currentInvoiceForView;

             if (!invoice) {
                 return `
                     <div class="flex flex-col items-center justify-center h-full">
                         <i data-lucide="info" class="w-12 h-12 text-yellow-600"></i>
                         <p class="mt-4 text-gray-600">لا توجد فاتورة لعرضها حالياً. الرجاء إنشاء فاتورة أولاً.</p>
                         <button onclick="navigateTo('new_invoice')" class="mt-6 bg-shahrazad text-white p-3 rounded-lg hover:bg-blue-700 transition duration-150">إنشاء فاتورة جديدة</button>
                     </div>
                 `;
             }

             // Find the user who created the invoice
             const createdUser = App.data.users.find(u => u.uid === invoice.createdBy)?.name || 'النظام';
             const invoiceDate = myAssistant.formatTimestamp(invoice.date);

             return `
                 <div class="space-y-6 print-area max-w-4xl mx-auto p-4 md:p-8 bg-white shadow-xl rounded-xl">
                     <div class="print-controls mb-4 flex justify-end space-x-3 rtl:space-x-reverse">
                         <button onclick="generateInvoicePDF()" class="flex items-center bg-shahrazad text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-150">
                             <i data-lucide="printer" class="w-5 h-5 ml-2"></i> طباعة / PDF
                         </button>
                         <button onclick="navigateTo('invoices')" class="flex items-center bg-gray-500 text-white py-2 px-4 rounded-lg hover:bg-gray-600 transition duration-150">
                             <i data-lucide="list-checks" class="w-5 h-5 ml-2"></i> العودة للقائمة
                         </button>
                     </div>

                     <header class="text-center border-b-4 border-shahrazad pb-4 mb-6">
                         <h1 class="text-3xl font-black text-shahrazad">SHAHRAZAD ELECTRIC</h1>
                         <p class="text-md text-gray-600">نظام إدارة المبيعات المتقدم</p>
                     </header>

                     <div class="grid grid-cols-2 gap-4 text-sm mb-6 border p-4 rounded-lg bg-gray-50">
                         <div>
                             <p class="font-bold text-gray-700">العميل:</p>
                             <p class="text-gray-900 font-bold text-lg">${invoice.customerName}</p>
                         </div>
                         <div class="text-left">
                             <p class="font-bold text-gray-700">رقم الفاتورة:</p>
                             <p class="text-xl font-extrabold text-shahrazad">INV-${invoice.invoiceNumber.toString().padStart(5, '0')}</p>
                         </div>
                         <div>
                             <p class="font-bold text-gray-700">تاريخ الإصدار:</p>
                             <p class="text-gray-900">${invoiceDate}</p>
                         </div>
                         <div class="text-left">
                             <p class="font-bold text-gray-700">تم بواسطة:</p>
                             <p class="text-gray-900">${createdUser}</p>
                         </div>
                     </div>

                     <div class="overflow-x-auto mb-6">
                         <table class="min-w-full border border-gray-300">
                             <thead>
                                 <tr class="bg-gray-100">
                                     <th class="p-3 border-r text-right text-xs font-bold text-gray-600 uppercase tracking-wider">الصنف</th>
                                     <th class="p-3 border-r text-right text-xs font-bold text-gray-600 uppercase tracking-wider w-16">الكمية</th>
                                     <th class="p-3 border-r text-right text-xs font-bold text-gray-600 uppercase tracking-wider w-20">السعر</th>
                                     <th class="p-3 border-r text-right text-xs font-bold text-gray-600 uppercase tracking-wider w-20">الخصم</th>
                                     <th class="p-3 text-right text-xs font-bold text-gray-600 uppercase tracking-wider w-24">الإجمالي (ج.س)</th>
                                 </tr>
                             </thead>
                             <tbody>
                                 ${invoice.items.map(item => `
                                     <tr class="border-b hover:bg-gray-50">
                                         <td class="p-3 border-r whitespace-nowrap text-sm text-gray-900">${item.name}</td>
                                         <td class="p-3 border-r whitespace-nowrap text-sm text-gray-700">${item.quantity}</td>
                                         <td class="p-3 border-r whitespace-nowrap text-sm text-gray-700">${parseFloat(item.unitPrice).toFixed(2)}</td>
                                         <td class="p-3 border-r whitespace-nowrap text-sm text-red-600">${item.discount}%</td>
                                         <td class="p-3 whitespace-nowrap text-sm font-bold text-gray-800">${parseFloat(item.total).toFixed(2)}</td>
                                     </tr>
                                 `).join('')}
                             </tbody>
                         </table>
                     </div>

                     <div class="grid grid-cols-2 gap-4">
                         <div>
                             <p class="font-bold text-gray-700 mb-2">ملاحظات:</p>
                             <p class="text-sm text-gray-600 p-2 border rounded-md h-24">${invoice.notes || 'لا توجد ملاحظات.'}</p>
                         </div>
                         <div class="space-y-2 text-sm max-w-xs ml-auto rtl:mr-auto">
                             <div class="flex justify-between border-b pb-1">
                                 <span>الإجمالي الفرعي:</span>
                                 <span class="font-medium">${parseFloat(invoice.subTotal).toFixed(2)} ج.س</span>
                             </div>
                             <div class="flex justify-between text-red-600 border-b pb-1">
                                 <span>إجمالي الخصم:</span>
                                 <span class="font-medium">-${parseFloat(invoice.totalDiscount).toFixed(2)} ج.س</span>
                             </div>
                             <div class="border-t pt-2 flex justify-between text-xl font-bold text-green-700">
                                 <span>المجموع الكلي:</span>
                                 <span>${parseFloat(invoice.grandTotal).toFixed(2)} ج.س</span>
                             </div>
                         </div>
                     </div>
                     
                     <footer class="text-center pt-6 border-t mt-6">
                          <p class="text-xs text-gray-500">شكراً لتعاملكم مع SHAHRAZAD ELECTRIC. هذه الفاتورة تم إنشاؤها عبر نظام إدارة المبيعات المتقدم.</p>
                     </footer>
                 </div>
             `;
        };

        // --- 8. Invoices View ---
        const InvoicesView = () => {
            const invoices = App.data.invoices;

            // Sort by invoice number descending
            invoices.sort((a, b) => (b.invoiceNumber || 0) - (a.invoiceNumber || 0));

            return `
                <div class="space-y-6">
                    <h2 class="text-2xl font-bold text-gray-800 border-b pb-2">إدارة الفواتير</h2>

                    <div class="flex justify-between items-center">
                        <button onclick="navigateTo('new_invoice')" class="flex items-center bg-shahrazad text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-150 shadow-md">
                            <i data-lucide="file-plus" class="w-5 h-5 ml-2"></i> إنشاء فاتورة جديدة
                        </button>
                        <p class="text-lg font-semibold text-gray-600">إجمالي الفواتير: ${invoices.length}</p>
                    </div>

                    <div class="card p-6 overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead>
                                <tr>
                                    <th class="px-3 py-3 bg-gray-50 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">رقم الفاتورة</th>
                                    <th class="px-3 py-3 bg-gray-50 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">العميل</th>
                                    <th class="px-3 py-3 bg-gray-50 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">التاريخ</th>
                                    <th class="px-3 py-3 bg-gray-50 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">المبلغ الكلي (ج.س)</th>
                                    <th class="px-3 py-3 bg-gray-50 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">تم بواسطة</th>
                                    <th class="px-3 py-3 bg-gray-50 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">إجراءات</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${invoices.map(inv => {
                                    const createdUser = App.data.users.find(u => u.uid === inv.createdBy)?.name || 'النظام';
                                    const formattedDate = myAssistant.formatTimestamp(inv.date);
                                    
                                    return `
                                        <tr class="hover:bg-gray-50 cursor-pointer" onclick="navigateTo('invoice_details', ${JSON.stringify(inv).replace(/"/g, '&quot;')})">
                                            <td class="px-3 py-4 whitespace-nowrap text-sm font-extrabold text-shahrazad">INV-${(inv.invoiceNumber || '0').toString().padStart(5, '0')}</td>
                                            <td class="px-3 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${inv.customerName}</td>
                                            <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500">${formattedDate}</td>
                                            <td class="px-3 py-4 whitespace-nowrap text-sm font-bold text-green-700">${parseFloat(inv.grandTotal).toFixed(2)}</td>
                                            <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500">${createdUser}</td>
                                            <td class="px-3 py-4 whitespace-nowrap text-left text-sm font-medium">
                                                <button onclick="event.stopPropagation(); navigateTo('invoice_details', ${JSON.stringify(inv).replace(/"/g, '&quot;')})" class="text-shahrazad hover:text-blue-700 p-2 rounded-full hover:bg-gray-100 transition duration-150" title="معاينة">
                                                    <i data-lucide="eye" class="w-5 h-5"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                        ${invoices.length === 0 ? '<p class="text-center text-gray-500 p-4">لم يتم إصدار أي فواتير بعد.</p>' : ''}
                    </div>
                </div>
            `;
        };

        // --- 9. Customers View ---
        const CustomersView = () => {
             const customers = App.data.customers;
             
             // Sort customers by total spent descending
             customers.sort((a, b) => (b.totalSpent || 0) - (a.totalSpent || 0));

             return `
                 <div class="space-y-6">
                     <h2 class="text-2xl font-bold text-gray-800 border-b pb-2">إدارة العملاء</h2>
                     
                     <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                         ${StatCard('إجمالي العملاء', customers.length, 'users', 'text-shahrazad')}
                         ${StatCard('عملاء مميزون (VIP)', customers.filter(c => c.isDistinguished).length, 'star', 'text-yellow-500')}
                         ${StatCard('إجمالي الإنفاق (تقريبي)', `${customers.reduce((sum, c) => sum + (c.totalSpent || 0), 0).toFixed(2)} ج.س`, 'wallet', 'text-green-500')}
                     </div>

                     <div class="card p-6 overflow-x-auto">
                         <h3 class="text-lg font-semibold text-gray-700 mb-4">قائمة العملاء المسجلين</h3>
                         <table class="min-w-full divide-y divide-gray-200">
                             <thead>
                                 <tr>
                                     <th class="px-3 py-3 bg-gray-50 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">الاسم</th>
                                     <th class="px-3 py-3 bg-gray-50 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">مميز؟</th>
                                     <th class="px-3 py-3 bg-gray-50 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">إجمالي الإنفاق (ج.س)</th>
                                     <th class="px-3 py-3 bg-gray-50 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">تاريخ التسجيل</th>
                                     <th class="px-3 py-3 bg-gray-50 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">إجراءات</th>
                                 </tr>
                             </thead>
                             <tbody class="bg-white divide-y divide-gray-200">
                                 ${customers.map(c => `
                                     <tr class="hover:bg-gray-50">
                                         <td class="px-3 py-4 whitespace-nowrap text-sm font-medium text-gray-900 flex items-center">
                                            ${c.isDistinguished ? '<i data-lucide="star" class="w-4 h-4 ml-1 text-yellow-500"></i>' : ''}
                                            ${c.name}
                                         </td>
                                         <td class="px-3 py-4 whitespace-nowrap text-sm ${c.isDistinguished ? 'text-green-600 font-bold' : 'text-red-500'}">
                                             ${c.isDistinguished ? 'نعم' : 'لا'}
                                         </td>
                                         <td class="px-3 py-4 whitespace-nowrap text-sm font-bold text-gray-800">${(c.totalSpent || 0).toFixed(2)}</td>
                                         <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500">${myAssistant.formatTimestamp(c.createdAt)}</td>
                                         <td class="px-3 py-4 whitespace-nowrap text-left text-sm font-medium">
                                              <button onclick="alertUser('ميزة عرض تفاصيل العميل غير مفعلة في هذا الإصدار.', 'error')" class="text-shahrazad hover:text-blue-700 p-2 rounded-full hover:bg-gray-100 transition duration-150" title="تفاصيل">
                                                 <i data-lucide="folder-open" class="w-5 h-5"></i>
                                             </button>
                                         </td>
                                     </tr>
                                 `).join('')}
                             </tbody>
                         </table>
                         ${customers.length === 0 ? '<p class="text-center text-gray-500 p-4">لا توجد عملاء مسجلون حالياً.</p>' : ''}
                     </div>
                 </div>
             `;
        };

        // --- 10. Alerts View ---
        const AlertsView = () => `
            <div class="space-y-6">
                <h2 class="text-2xl font-bold text-gray-800 border-b pb-2">تنبيهات نقص المخزون الحرجة</h2>
                <div class="card p-6">
                    <h3 class="text-lg font-semibold text-red-700 mb-4 flex items-center">
                        <i data-lucide="alert-triangle" class="w-5 h-5 ml-2 text-red-600"></i>
                        قائمة الأصناف التي وصلت أو تجاوزت حد النقص
                    </h3>
                    <div id="alerts-container-full" class="space-y-3">
                        </div>
                </div>
            </div>
        `;

        // --- 11. General Settings View ---
        const GeneralSettingsView = () => {
             const warehouses = App.data.warehouses;
             
             // Function to add a new warehouse (simple implementation)
             window.handleAddWarehouse = async (e) => {
                 e.preventDefault();
                 const name = document.getElementById('warehouse-name').value.trim();
                 if (!name) {
                     alertUser("يرجى إدخال اسم المخزن.", "error");
                     return;
                 }
                 try {
                     const newWarehouseRef = collection(App.db, App.getCollectionPath('warehouses'));
                     await addDoc(newWarehouseRef, {
                         name: name,
                         createdAt: new Date().toISOString(),
                     });
                     alertUser(`تم إضافة المخزن **${name}** بنجاح.`, "success");
                     document.getElementById('warehouse-name').value = '';
                 } catch (error) {
                     console.error("Add warehouse error:", error);
                     alertUser("فشل إضافة المخزن. " + error.message, "error");
                 }
             };

             // Function to delete a warehouse
             window.handleDeleteWarehouse = async (id, name) => {
                 if (App.userRole !== 'admin') {
                      alertUser("عذراً، يجب أن تكون بـ **صلاحية المدير الأساسي** للحذف.", "error");
                      return;
                 }
                 if (!confirm(`هل أنت متأكد من حذف المخزن: ${name}؟ سيؤثر هذا على الأصناف المرتبطة به!`)) return;

                 try {
                     await deleteDoc(doc(App.db, App.getCollectionPath('warehouses'), id));
                     alertUser(`تم حذف المخزن **${name}** بنجاح.`, "success");
                 } catch (error) {
                     console.error("Delete warehouse error:", error);
                     alertUser("فشل حذف المخزن. " + error.message, "error");
                 }
             };

            return `
                 <div class="space-y-6">
                    <h2 class="text-2xl font-bold text-gray-800 border-b pb-2">الإعدادات العامة</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="card p-5 space-y-4">
                            <h3 class="text-lg font-semibold text-shahrazad border-b pb-2 flex items-center">
                                <i data-lucide="warehouse" class="w-5 h-5 ml-2"></i>
                                إدارة المخازن (المستودعات)
                            </h3>
                            <form onsubmit="handleAddWarehouse(event)" class="flex space-x-2 rtl:space-x-reverse">
                                <input type="text" id="warehouse-name" placeholder="اسم المخزن الجديد" required class="flex-grow p-2 border rounded-md focus:ring-shahrazad focus:border-shahrazad">
                                <button type="submit" class="bg-green-600 text-white p-2 rounded-md hover:bg-green-700 transition duration-150">
                                    <i data-lucide="plus" class="w-5 h-5"></i>
                                </button>
                            </form>
                            
                            <ul class="divide-y divide-gray-200 mt-4">
                                ${warehouses.map(w => `
                                    <li class="flex justify-between items-center py-2 hover:bg-gray-50 px-2 rounded-md">
                                        <span class="text-gray-700">${w.name}</span>
                                        <button onclick="handleDeleteWarehouse('${w.id}', '${w.name}')" class="text-red-500 hover:text-red-700 p-1 rounded-full hover:bg-red-100 transition duration-150" title="حذف">
                                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                                        </button>
                                    </li>
                                `).join('')}
                                ${warehouses.length === 0 ? '<li class="text-center text-gray-500 p-2">لا توجد مخازن مضافة.</li>' : ''}
                            </ul>
                        </div>
                        
                        <div class="card p-5 space-y-4">
                            <h3 class="text-lg font-semibold text-shahrazad border-b pb-2 flex items-center">
                                <i data-lucide="cloud-download" class="w-5 h-5 ml-2"></i>
                                النسخ الاحتياطي للبيانات
                            </h3>
                            <p class="text-gray-600 text-sm">قم بتنزيل نسخة احتياطية كاملة لبيانات الأصناف، العملاء، والفواتير بصيغة JSON.</p>
                            <button id="backup-btn" onclick="backupData()" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700 transition duration-150">
                                <i data-lucide="download" class="w-5 h-5 ml-2 inline"></i> تنزيل نسخة احتياطية
                            </button>
                        </div>
                    </div>
                </div>
            `;
        };

        // --- 12. User Settings View (Admin Only) ---
        const UserSettingsView = () => {
            if (App.userRole !== 'admin') {
                return `
                    <div class="card p-8 text-center bg-red-100 border border-red-300">
                        <i data-lucide="lock" class="w-12 h-12 text-red-600 mx-auto mb-4"></i>
                        <h2 class="text-2xl font-bold text-red-800">وصول ممنوع</h2>
                        <p class="text-gray-700 mt-2">عذراً، هذه الصفحة متاحة فقط للمستخدمين بـ **صلاحية المدير الأساسي**.</p>
                    </div>
                `;
            }

            const users = App.data.users;

            return `
                <div class="space-y-6">
                    <h2 class="text-2xl font-bold text-gray-800 border-b pb-2">إدارة المستخدمين والصلاحيات</h2>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        
                        <div class="card p-5 md:col-span-1 space-y-4">
                            <h3 class="text-lg font-semibold text-shahrazad border-b pb-2 flex items-center">
                                <i data-lucide="user-plus" class="w-5 h-5 ml-2"></i>
                                إضافة مستخدم جديد (Firebase Auth)
                            </h3>
                            <form id="add-user-form" onsubmit="handleUserCreate(event)" class="space-y-3">
                                <input type="text" id="user-name" placeholder="الاسم الكامل" required class="w-full p-2 border rounded-md focus:ring-shahrazad focus:border-shahrazad">
                                <input type="email" id="user-email" placeholder="البريد الإلكتروني (يُفضل)" required class="w-full p-2 border rounded-md focus:ring-shahrazad focus:border-shahrazad">
                                <input type="password" id="user-password" placeholder="كلمة المرور (6 أحرف فأكثر)" required class="w-full p-2 border rounded-md focus:ring-shahrazad focus:border-shahrazad">
                                <select id="user-role" required class="w-full p-2 border rounded-md focus:ring-shahrazad focus:border-shahrazad">
                                    <option value="staff">موظف (Staff)</option>
                                    <option value="admin">مدير (Admin)</option>
                                </select>
                                <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 transition duration-150">
                                    <i data-lucide="user-plus" class="w-5 h-5 ml-2 inline"></i> إضافة مستخدم جديد
                                </button>
                            </form>
                        </div>

                        <div class="card p-5 md:col-span-2 overflow-x-auto">
                            <h3 class="text-lg font-semibold text-gray-700 mb-4">قائمة المستخدمين المسجلين (${users.length})</h3>
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead>
                                    <tr>
                                        <th class="px-3 py-3 bg-gray-50 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">الاسم</th>
                                        <th class="px-3 py-3 bg-gray-50 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">البريد</th>
                                        <th class="px-3 py-3 bg-gray-50 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">الدور</th>
                                        <th class="px-3 py-3 bg-gray-50 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">إجراءات</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    ${users.map(u => `
                                        <tr class="hover:bg-gray-50 ${u.uid === App.userId ? 'bg-blue-50' : ''}">
                                            <td class="px-3 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${u.name || 'غير محدد'} ${u.uid === App.userId ? '(أنت)' : ''}</td>
                                            <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500">${u.email || 'مجهول/N/A'}</td>
                                            <td class="px-3 py-4 whitespace-nowrap text-sm font-bold ${u.role === 'admin' ? 'text-red-600' : 'text-green-600'}">
                                                ${u.role === 'admin' ? 'مدير' : 'موظف'}
                                            </td>
                                            <td class="px-3 py-4 whitespace-nowrap text-left text-sm font-medium">
                                                <button onclick="handleUserDelete('${u.id}', '${u.email || 'N/A'}')" class="text-red-600 hover:text-red-900 p-2 rounded-full hover:bg-red-100 transition duration-150 ${u.uid === App.userId ? 'opacity-50 cursor-not-allowed' : ''}" title="حذف" ${u.uid === App.userId ? 'disabled' : ''}>
                                                    <i data-lucide="trash-2" class="w-5 h-5"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        };

        // ====================================================================
        //                      App Initialization
        // ====================================================================

        App.views = {
            loading: LoadingView,
            auth_error: AuthErrorView,
            login: LoginView,
            dashboard: DashboardView,
            products: ProductsView,
            invoices: InvoicesView,
            new_invoice: NewInvoiceView, // Added new view
            invoice_details: PrintInvoiceView, // Added new view
            customers: CustomersView,
            alerts: AlertsView,
            general_settings: GeneralSettingsView,
            user_settings: UserSettingsView,
        };

        // NOTE: The `handleAddProduct` and `handleDeleteProduct` functions are not visible in the provided snippet
        // but are assumed to exist based on the `ProductsView` and are essential for a complete system. 
        // Their functionality (CRUD for products) is assumed to remain unchanged except for the new fields.

        function render() {
            const appRoot = document.getElementById('app-root');
            if (appRoot) {
                appRoot.innerHTML = MainLayout();
                lucide.createIcons();
            }
        }

        // --- Start Application ---

        // 1. Setup global container
        const appContainer = document.createElement('div');
        appContainer.id = 'app-root';
        document.body.appendChild(appContainer);

        // 2. Start Auth Process
        authenticateUser().then(() => { setupAuthStateListener(); });
    </script>
    
    <div id="global-alert" class="fixed top-4 right-4 z-50 p-4 rounded-lg shadow-xl text-white transition-all duration-300 transform -translate-y-20 opacity-0">
        </div>
    
</body>
</html>
